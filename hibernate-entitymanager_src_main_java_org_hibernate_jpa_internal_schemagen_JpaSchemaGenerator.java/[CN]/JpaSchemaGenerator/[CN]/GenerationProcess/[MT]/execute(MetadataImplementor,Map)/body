{
  final SchemaGenAction databaseAction=SchemaGenAction.interpret(configurationValues.get(AvailableSettings.SCHEMA_GEN_DATABASE_ACTION));
  final SchemaGenAction scriptsAction=SchemaGenAction.interpret(configurationValues.get(AvailableSettings.SCHEMA_GEN_SCRIPTS_ACTION));
  if (databaseAction == SchemaGenAction.NONE && scriptsAction == SchemaGenAction.NONE) {
    log.debug("No actions specified; doing nothing");
    return;
  }
  final JdbcConnectionContext jdbcConnectionContext=determineAppropriateJdbcConnectionContext(configurationValues,serviceRegistry);
  try {
    final Dialect dialect=determineDialect(jdbcConnectionContext,configurationValues,serviceRegistry);
    final List<GenerationSource> createSourceList=databaseAction.includesCreate() || scriptsAction.includesCreate() ? buildCreateSourceList(metadata,configurationValues,dialect) : Collections.<GenerationSource>emptyList();
    final List<GenerationSource> dropSourceList=databaseAction.includesDrop() || scriptsAction.includesDrop() ? buildDropSourceList(metadata,configurationValues,dialect) : Collections.<GenerationSource>emptyList();
    final GenerationTarget databaseTarget=new GenerationTargetToDatabase(jdbcConnectionContext,databaseAction);
    final Object createScriptTargetSetting=configurationValues.get(SCHEMA_GEN_SCRIPTS_CREATE_TARGET);
    final Object dropScriptTargetSetting=configurationValues.get(SCHEMA_GEN_SCRIPTS_DROP_TARGET);
    final GenerationTarget scriptsTarget=new GenerationTargetToScript(interpretScriptTargetSetting(createScriptTargetSetting,scriptsAction.includesCreate(),SCHEMA_GEN_SCRIPTS_CREATE_TARGET),interpretScriptTargetSetting(dropScriptTargetSetting,scriptsAction.includesDrop(),SCHEMA_GEN_SCRIPTS_DROP_TARGET),scriptsAction);
    final List<GenerationTarget> targets=Arrays.asList(databaseTarget,scriptsTarget);
    final String hbm2ddl=(String)configurationValues.get(HBM2DDL_AUTO);
    if (StringHelper.isNotEmpty(hbm2ddl)) {
      log.warnf("Hibernate hbm2ddl-auto setting was specified [%s] in combination with JPA schema-generation; " + "combination will likely cause trouble",hbm2ddl);
    }
    try {
      doGeneration(createSourceList,dropSourceList,targets);
    }
  finally {
      releaseTargets(targets);
      releaseSources(createSourceList);
      releaseSources(dropSourceList);
    }
  }
  finally {
    releaseJdbcConnectionContext(jdbcConnectionContext);
  }
}
