{
  TransactionManager tm=null;
  if (settings.getTransactionManagerLookup() != null) {
    tm=settings.getTransactionManagerLookup().getTransactionManager(properties);
  }
  Configuration cacheConfig=cache.getConfiguration();
  TransactionManager cacheTm=cacheConfig.getRuntimeConfig().getTransactionManager();
  if (!safeEquals(tm,cacheTm)) {
    if (cache.getCacheStatus() != CacheStatus.INSTANTIATED && cache.getCacheStatus() != CacheStatus.DESTROYED) {
      throw new CacheException("JBoss Cache is already started " + "with a transaction manager (" + cacheTm + ") that doesn't match our own ("+ tm+ ")");
    }
 else {
      cacheConfig.getRuntimeConfig().setTransactionManager(tm);
      if (tm == null) {
        cacheConfig.setTransactionManagerLookupClass(null);
      }
    }
  }
}
