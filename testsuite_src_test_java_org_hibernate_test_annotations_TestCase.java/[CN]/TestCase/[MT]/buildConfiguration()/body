{
  if (sessions != null) {
    sessions.close();
  }
  try {
    setCfg(new AnnotationConfiguration());
    cfg.setProperty(AnnotationConfiguration.USE_NEW_ID_GENERATOR_MAPPINGS,"true");
    configure(cfg);
    if (recreateSchema()) {
      cfg.setProperty(Environment.HBM2DDL_AUTO,"create-drop");
    }
    for (    String aPackage : getAnnotatedPackages()) {
      ((AnnotationConfiguration)getCfg()).addPackage(aPackage);
    }
    for (    Class<?> aClass : getAnnotatedClasses()) {
      ((AnnotationConfiguration)getCfg()).addAnnotatedClass(aClass);
    }
    for (    String xmlFile : getXmlFiles()) {
      InputStream is=Thread.currentThread().getContextClassLoader().getResourceAsStream(xmlFile);
      getCfg().addInputStream(is);
    }
    sessions=getCfg().buildSessionFactory();
  }
 catch (  Exception e) {
    e.printStackTrace();
    throw e;
  }
}
