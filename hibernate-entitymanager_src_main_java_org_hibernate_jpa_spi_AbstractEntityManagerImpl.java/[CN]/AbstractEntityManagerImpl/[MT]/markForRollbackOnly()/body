{
  LOG.debugf("Mark transaction for rollback");
  if (tx.isActive()) {
    tx.setRollbackOnly();
  }
 else {
    if (PersistenceUnitTransactionType.JTA == transactionType) {
      TransactionManager transactionManager=sfi().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager();
      if (transactionManager == null) {
        throw new PersistenceException("Using a JTA persistence context wo setting hibernate.transaction.jta.platform");
      }
      try {
        if (transactionManager.getStatus() != Status.STATUS_NO_TRANSACTION) {
          transactionManager.setRollbackOnly();
        }
      }
 catch (      SystemException e) {
        throw new PersistenceException("Unable to set the JTA transaction as RollbackOnly",e);
      }
    }
  }
}
