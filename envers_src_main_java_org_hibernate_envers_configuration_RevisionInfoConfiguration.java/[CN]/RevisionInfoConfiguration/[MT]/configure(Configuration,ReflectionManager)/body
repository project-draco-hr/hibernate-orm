{
  Iterator<PersistentClass> classes=(Iterator<PersistentClass>)cfg.getClassMappings();
  boolean revisionEntityFound=false;
  RevisionInfoGenerator revisionInfoGenerator=null;
  Class<?> revisionInfoClass=null;
  while (classes.hasNext()) {
    PersistentClass pc=classes.next();
    XClass clazz;
    try {
      clazz=reflectionManager.classForName(pc.getClassName(),this.getClass());
    }
 catch (    ClassNotFoundException e) {
      throw new MappingException(e);
    }
    RevisionEntity revisionEntity=clazz.getAnnotation(RevisionEntity.class);
    if (revisionEntity != null) {
      if (revisionEntityFound) {
        throw new MappingException("Only one entity may be annotated with @RevisionEntity!");
      }
      if (clazz.getAnnotation(Audited.class) != null) {
        throw new MappingException("An entity annotated with @RevisionEntity cannot be versioned!");
      }
      revisionEntityFound=true;
      MutableBoolean revisionNumberFound=new MutableBoolean();
      MutableBoolean revisionTimestampFound=new MutableBoolean();
      searchForRevisionInfoCfg(clazz,reflectionManager,revisionNumberFound,revisionTimestampFound);
      if (!revisionNumberFound.isSet()) {
        throw new MappingException("An entity annotated with @RevisionEntity must have a field annotated " + "with @RevisionNumber!");
      }
      if (!revisionTimestampFound.isSet()) {
        throw new MappingException("An entity annotated with @RevisionEntity must have a field annotated " + "with @RevisionTimestamp!");
      }
      revisionInfoEntityName=pc.getEntityName();
      revisionInfoClass=pc.getMappedClass();
      revisionInfoGenerator=new DefaultRevisionInfoGenerator(revisionInfoEntityName,revisionInfoClass,revisionEntity.value(),revisionInfoTimestampName);
    }
  }
  Document revisionInfoXmlMapping=null;
  if (revisionInfoGenerator == null) {
    revisionInfoClass=DefaultRevisionEntity.class;
    revisionInfoGenerator=new DefaultRevisionInfoGenerator(revisionInfoEntityName,revisionInfoClass,RevisionListener.class,revisionInfoTimestampName);
    revisionInfoXmlMapping=generateDefaultRevisionInfoXmlMapping();
  }
  return new RevisionInfoConfigurationResult(revisionInfoGenerator,revisionInfoXmlMapping,new RevisionInfoQueryCreator(revisionInfoEntityName,revisionInfoIdName,revisionInfoTimestampName),generateRevisionInfoRelationMapping(),new RevisionInfoNumberReader(revisionInfoClass,revisionInfoIdName),revisionInfoEntityName);
}
