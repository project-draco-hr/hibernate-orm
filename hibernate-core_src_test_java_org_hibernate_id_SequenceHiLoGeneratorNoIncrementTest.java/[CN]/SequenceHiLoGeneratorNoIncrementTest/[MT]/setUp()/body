{
  BasicTestingJdbcServiceImpl jdbcServices=new BasicTestingJdbcServiceImpl();
  jdbcServices.prepare(false);
  serviceRegistry=new StandardServiceRegistryBuilder().enableAutoClose().addService(JdbcEnvironment.class,jdbcServices.getJdbcEnvironment()).addService(JdbcServices.class,jdbcServices).applySetting(AvailableSettings.HBM2DDL_AUTO,"create-drop").build();
  generator=new SequenceHiLoGenerator();
  Properties properties=new Properties();
  properties.setProperty(SequenceGenerator.SEQUENCE,TEST_SEQUENCE);
  properties.setProperty(SequenceHiLoGenerator.MAX_LO,"0");
  properties.put(PersistentIdentifierGenerator.IDENTIFIER_NORMALIZER,new ObjectNameNormalizer(){
    @Override protected MetadataBuildingContext getBuildingContext(){
      return new MetadataBuildingContextTestingImpl(serviceRegistry);
    }
  }
);
  generator.configure(StandardBasicTypes.LONG,properties,jdbcServices.getJdbcEnvironment());
  final Metadata metadata=new MetadataSources(serviceRegistry).buildMetadata();
  metadata.getDatabase().addAuxiliaryDatabaseObject(new SimpleAuxiliaryDatabaseObject(Collections.<String>emptySet(),null,null,generator.sqlCreateStrings(TestingDatabaseInfo.DIALECT),generator.sqlDropStrings(TestingDatabaseInfo.DIALECT)));
  sessionFactory=(SessionFactoryImplementor)metadata.buildSessionFactory();
}
