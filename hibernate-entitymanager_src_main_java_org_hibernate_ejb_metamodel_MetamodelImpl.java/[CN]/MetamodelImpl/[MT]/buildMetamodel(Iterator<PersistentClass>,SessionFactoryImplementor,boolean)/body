{
  MetadataContext context=new MetadataContext(sessionFactory,ignoreUnsupported);
  while (persistentClasses.hasNext()) {
    PersistentClass pc=persistentClasses.next();
    if (pc.getMappedClass() != null) {
      locateOrBuildEntityType(pc,context);
    }
  }
  context.wrapUp();
  return new MetamodelImpl(context.getEntityTypeMap(),context.getEmbeddableTypeMap(),context.getMappedSuperclassTypeMap());
}
