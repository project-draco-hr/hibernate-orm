{
  final TransactionContext transactionContext=new TransactionContextImpl(new TransactionEnvironmentImpl(serviceRegistry));
  TransactionCoordinatorImpl transactionCoordinator=new TransactionCoordinatorImpl(null,transactionContext);
  JournalingTransactionObserver observer=new JournalingTransactionObserver();
  transactionCoordinator.addObserver(observer);
  JdbcCoordinator jdbcCoordinator=transactionCoordinator.getJdbcCoordinator();
  LogicalConnectionImplementor logicalConnection=jdbcCoordinator.getLogicalConnection();
  Statement statement=jdbcCoordinator.getStatementPreparer().createStatement();
  jdbcCoordinator.getResultSetReturn().execute(statement,"drop table SANDBOX_JDBC_TST if exists");
  jdbcCoordinator.getResultSetReturn().execute(statement,"create table SANDBOX_JDBC_TST ( ID integer, NAME varchar(100) )");
  assertTrue(jdbcCoordinator.hasRegisteredResources());
  assertTrue(logicalConnection.isPhysicallyConnected());
  jdbcCoordinator.release(statement);
  assertFalse(jdbcCoordinator.hasRegisteredResources());
  assertFalse(logicalConnection.isPhysicallyConnected());
  TransactionImplementor txn=transactionCoordinator.getTransaction();
  txn.begin();
  assertEquals(1,observer.getBegins());
  assertTrue(txn.isInitiator());
  try {
    PreparedStatement ps=jdbcCoordinator.getStatementPreparer().prepareStatement("insert into SANDBOX_JDBC_TST( ID, NAME ) values ( ?, ? )");
    ps.setLong(1,1);
    ps.setString(2,"name");
    jdbcCoordinator.getResultSetReturn().execute(ps);
    assertTrue(jdbcCoordinator.hasRegisteredResources());
    jdbcCoordinator.release(ps);
    assertFalse(jdbcCoordinator.hasRegisteredResources());
    ps=jdbcCoordinator.getStatementPreparer().prepareStatement("select * from SANDBOX_JDBC_TST");
    jdbcCoordinator.getResultSetReturn().extract(ps);
    ps=jdbcCoordinator.getStatementPreparer().prepareStatement("delete from SANDBOX_JDBC_TST");
    jdbcCoordinator.getResultSetReturn().execute(ps);
    assertTrue(jdbcCoordinator.hasRegisteredResources());
    assertTrue(logicalConnection.isPhysicallyConnected());
    txn.commit();
    assertFalse(jdbcCoordinator.hasRegisteredResources());
    assertFalse(logicalConnection.isPhysicallyConnected());
    assertEquals(1,observer.getBeforeCompletions());
    assertEquals(1,observer.getAfterCompletions());
  }
 catch (  SQLException sqle) {
    try {
      serviceRegistry.getService(JtaPlatform.class).retrieveTransactionManager().rollback();
    }
 catch (    Exception ignore) {
    }
    fail("incorrect exception type : SQLException");
  }
catch (  Throwable reThrowable) {
    try {
      serviceRegistry.getService(JtaPlatform.class).retrieveTransactionManager().rollback();
    }
 catch (    Exception ignore) {
    }
    throw reThrowable;
  }
 finally {
    logicalConnection.close();
  }
}
