{
  Session s=openSession();
  s.beginTransaction();
  VersionedNode parent=new VersionedNode("parent","parent");
  VersionedNode child=new VersionedNode("child","child");
  parent.addChild(child);
  s.persist(parent);
  s.getTransaction().commit();
  s.close();
  clearCounts();
  s=openSession();
  s.beginTransaction();
  parent=(VersionedNode)s.merge(parent);
  s.getTransaction().commit();
  s.close();
  assertUpdateCount(0);
  assertInsertCount(0);
  clearCounts();
  s=openSession();
  s.beginTransaction();
  VersionedNode parentGet=(VersionedNode)s.get(parent.getClass(),parent.getId());
  s.merge(parent);
  s.getTransaction().commit();
  s.close();
  assertUpdateCount(0);
  assertInsertCount(0);
  clearCounts();
  s=openSession();
  s.beginTransaction();
  VersionedNode parentLoad=(VersionedNode)s.load(parent.getClass(),parent.getId());
  s.merge(parent);
  s.getTransaction().commit();
  s.close();
  assertUpdateCount(0);
  assertInsertCount(0);
  clearCounts();
  s=openSession();
  s.beginTransaction();
  parent=(VersionedNode)s.get(VersionedNode.class,parent.getId());
  child=(VersionedNode)s.get(VersionedNode.class,child.getId());
  assertEquals(parent.getName(),"parent");
  assertEquals(1,parent.getChildren().size());
  assertEquals(0,parent.getVersion());
  assertSame(parent,child.getParent());
  assertSame(child,parent.getChildren().iterator().next());
  assertEquals(0,child.getVersion());
  s.delete(parent);
  s.delete(child);
  s.getTransaction().commit();
  s.close();
  assertUpdateCount(0);
  assertDeleteCount(2);
}
