{
  StandardServiceRegistryBuilder ssrb=createStandardServiceRegistryBuilder(getConfigurationName());
  localEnvironment=new NodeEnvironment(ssrb);
  localEnvironment.prepare();
  localEntityRegion=localEnvironment.getEntityRegion(REGION_NAME,getCacheDataDescription());
  localAccessStrategy=localEntityRegion.buildAccessStrategy(getAccessType());
  localSession=mock(SessionImplementor.class);
  when(localSession.getTransactionCoordinator()).thenReturn(new BatchModeTransactionCoordinator());
  remoteSession=mock(SessionImplementor.class);
  when(localSession.getTransactionCoordinator()).thenReturn(new BatchModeTransactionCoordinator());
  invalidation=Caches.isInvalidationCache(localEntityRegion.getCache());
  synchronous=Caches.isSynchronousCache(localEntityRegion.getCache());
  avoidConcurrentFlush();
  remoteEnvironment=new NodeEnvironment(ssrb);
  remoteEnvironment.prepare();
  remoteEntityRegion=remoteEnvironment.getEntityRegion(REGION_NAME,getCacheDataDescription());
  remoteAccessStrategy=remoteEntityRegion.buildAccessStrategy(getAccessType());
  waitForClusterToForm(localEntityRegion.getCache(),remoteEntityRegion.getCache());
}
