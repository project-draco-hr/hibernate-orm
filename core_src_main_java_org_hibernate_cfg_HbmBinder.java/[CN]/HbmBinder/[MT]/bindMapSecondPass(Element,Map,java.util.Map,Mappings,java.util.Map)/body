{
  bindCollectionSecondPass(node,map,classes,mappings,inheritedMetas);
  Iterator iter=node.elementIterator();
  while (iter.hasNext()) {
    Element subnode=(Element)iter.next();
    String name=subnode.getName();
    if ("index".equals(name) || "map-key".equals(name)) {
      SimpleValue value=new SimpleValue(map.getCollectionTable());
      bindSimpleValue(subnode,value,map.isOneToMany(),IndexedCollection.DEFAULT_INDEX_COLUMN_NAME,mappings);
      if (!value.isTypeSpecified()) {
        throw new MappingException("map index element must specify a type: " + map.getRole());
      }
      map.setIndex(value);
      map.setIndexNodeName(subnode.attributeValue("node"));
    }
 else     if ("index-many-to-many".equals(name) || "map-key-many-to-many".equals(name)) {
      ManyToOne mto=new ManyToOne(map.getCollectionTable());
      bindManyToOne(subnode,mto,IndexedCollection.DEFAULT_INDEX_COLUMN_NAME,map.isOneToMany(),mappings);
      map.setIndex(mto);
    }
 else     if ("composite-index".equals(name) || "composite-map-key".equals(name)) {
      Component component=new Component(map);
      bindComposite(subnode,component,map.getRole() + ".index",map.isOneToMany(),mappings,inheritedMetas);
      map.setIndex(component);
    }
 else     if ("index-many-to-any".equals(name)) {
      Any any=new Any(map.getCollectionTable());
      bindAny(subnode,any,map.isOneToMany(),mappings);
      map.setIndex(any);
    }
  }
  boolean indexIsFormula=false;
  Iterator colIter=map.getIndex().getColumnIterator();
  while (colIter.hasNext()) {
    if (((Selectable)colIter.next()).isFormula())     indexIsFormula=true;
  }
  if (map.isOneToMany() && !map.getKey().isNullable() && !map.isInverse()&& !indexIsFormula) {
    String entityName=((OneToMany)map.getElement()).getReferencedEntityName();
    PersistentClass referenced=mappings.getClass(entityName);
    IndexBackref ib=new IndexBackref();
    ib.setName('_' + map.getOwnerEntityName() + "."+ node.attributeValue("name")+ "IndexBackref");
    ib.setUpdateable(false);
    ib.setSelectable(false);
    ib.setCollectionRole(map.getRole());
    ib.setEntityName(map.getOwner().getEntityName());
    ib.setValue(map.getIndex());
    referenced.addProperty(ib);
  }
}
