{
  Item item1=new Item();
  item1.setName("item1 name");
  Category category=new Category();
  category.setName("category");
  item1.setCategory(category);
  category.setExampleItem(item1);
  EntityManager em=getOrCreateEntityManager();
  em.getTransaction().begin();
  em.persist(item1);
  em.getTransaction().commit();
  em.close();
  em=getOrCreateEntityManager();
  em.getTransaction().begin();
  Item item1_1=em.find(Item.class,item1.getId());
  Hibernate.initialize(item1_1.getCategory());
  em.getTransaction().commit();
  em.close();
  em=getOrCreateEntityManager();
  em.getTransaction().begin();
  Item item1Merged=em.merge(item1);
  Hibernate.initialize(item1Merged.getCategory());
  item1Merged.setCategory(category);
  category.setExampleItem(item1_1);
  try {
    em.merge(item1Merged);
    fail("should have failed because CustomEntityCopyObserver does not allow multiple copies of a Category. ");
  }
 catch (  IllegalStateException ex) {
  }
 finally {
    em.getTransaction().rollback();
  }
  em.close();
  em=getOrCreateEntityManager();
  em.getTransaction().begin();
  item1=em.find(Item.class,item1.getId());
  assertEquals(category.getName(),item1.getCategory().getName());
  assertSame(item1,item1.getCategory().getExampleItem());
  em.getTransaction().commit();
  em.close();
  cleanup();
}
