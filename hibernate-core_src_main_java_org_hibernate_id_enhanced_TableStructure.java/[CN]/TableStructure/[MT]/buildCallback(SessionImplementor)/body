{
  final SqlStatementLogger statementLogger=session.getFactory().getServiceRegistry().getService(JdbcServices.class).getSqlStatementLogger();
  final SessionEventListenerManager statsCollector=session.getEventListenerManager();
  return new AccessCallback(){
    @Override public IntegralDataTypeHolder getNextValue(){
      return session.getTransactionCoordinator().getTransaction().createIsolationDelegate().delegateWork(new AbstractReturningWork<IntegralDataTypeHolder>(){
        @Override public IntegralDataTypeHolder execute(        Connection connection) throws SQLException {
          final IntegralDataTypeHolder value=makeValue();
          int rows;
          do {
            final PreparedStatement selectStatement=prepareStatement(connection,selectQuery,statementLogger,statsCollector);
            try {
              final ResultSet selectRS=executeQuery(selectStatement,statsCollector);
              if (!selectRS.next()) {
                final String err="could not read a hi value - you need to populate the table: " + tableName;
                LOG.error(err);
                throw new IdentifierGenerationException(err);
              }
              value.initialize(selectRS,1);
              selectRS.close();
            }
 catch (            SQLException sqle) {
              LOG.error("could not read a hi value",sqle);
              throw sqle;
            }
 finally {
              selectStatement.close();
            }
            final PreparedStatement updatePS=prepareStatement(connection,updateQuery,statementLogger,statsCollector);
            try {
              final int increment=applyIncrementSizeToSourceValues ? incrementSize : 1;
              final IntegralDataTypeHolder updateValue=value.copy().add(increment);
              updateValue.bind(updatePS,1);
              value.bind(updatePS,2);
              rows=executeUpdate(updatePS,statsCollector);
            }
 catch (            SQLException e) {
              LOG.unableToUpdateQueryHiValue(tableName,e);
              throw e;
            }
 finally {
              updatePS.close();
            }
          }
 while (rows == 0);
          accessCounter++;
          return value;
        }
      }
,true);
    }
    @Override public String getTenantIdentifier(){
      return session.getTenantIdentifier();
    }
  }
;
}
