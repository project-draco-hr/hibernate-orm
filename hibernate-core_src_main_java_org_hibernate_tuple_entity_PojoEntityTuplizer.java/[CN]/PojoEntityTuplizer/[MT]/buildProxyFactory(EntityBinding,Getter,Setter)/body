{
  HashSet<Class> proxyInterfaces=new HashSet<Class>();
  proxyInterfaces.add(HibernateProxy.class);
  Class mappedClass=entityBinding.getEntity().getClassReference();
  Class proxyInterface=entityBinding.getProxyInterfaceType().getValue();
  if (proxyInterface != null && !mappedClass.equals(proxyInterface)) {
    if (!proxyInterface.isInterface()) {
      throw new MappingException("proxy must be either an interface, or the class itself: " + getEntityName());
    }
    proxyInterfaces.add(proxyInterface);
  }
  if (mappedClass.isInterface()) {
    proxyInterfaces.add(mappedClass);
  }
  for (  EntityBinding subEntityBinding : entityBinding.getPostOrderSubEntityBindingClosure()) {
    final Class subclassProxy=subEntityBinding.getProxyInterfaceType().getValue();
    final Class subclassClass=subEntityBinding.getClassReference();
    if (subclassProxy != null && !subclassClass.equals(subclassProxy)) {
      if (!subclassProxy.isInterface()) {
        throw new MappingException("proxy must be either an interface, or the class itself: " + subEntityBinding.getEntity().getName());
      }
      proxyInterfaces.add(subclassProxy);
    }
  }
  for (  AttributeBinding property : entityBinding.attributeBindings()) {
    Method method=getGetter(property).getMethod();
    if (method != null && Modifier.isFinal(method.getModifiers())) {
      LOG.gettersOfLazyClassesCannotBeFinal(entityBinding.getEntity().getName(),property.getAttribute().getName());
    }
    method=getSetter(property).getMethod();
    if (method != null && Modifier.isFinal(method.getModifiers())) {
      LOG.settersOfLazyClassesCannotBeFinal(entityBinding.getEntity().getName(),property.getAttribute().getName());
    }
  }
  Method idGetterMethod=idGetter == null ? null : idGetter.getMethod();
  Method idSetterMethod=idSetter == null ? null : idSetter.getMethod();
  Method proxyGetIdentifierMethod=idGetterMethod == null || proxyInterface == null ? null : ReflectHelper.getMethod(proxyInterface,idGetterMethod);
  Method proxySetIdentifierMethod=idSetterMethod == null || proxyInterface == null ? null : ReflectHelper.getMethod(proxyInterface,idSetterMethod);
  ProxyFactory pf=buildProxyFactoryInternal(entityBinding,idGetter,idSetter);
  try {
    pf.postInstantiate(getEntityName(),mappedClass,proxyInterfaces,proxyGetIdentifierMethod,proxySetIdentifierMethod,entityBinding.getHierarchyDetails().getEntityIdentifier().isEmbedded() ? (CompositeType)entityBinding.getHierarchyDetails().getEntityIdentifier().getValueBinding().getHibernateTypeDescriptor().getResolvedTypeMapping() : null);
  }
 catch (  HibernateException he) {
    LOG.unableToCreateProxyFactory(getEntityName(),he);
    pf=null;
  }
  return pf;
}
