{
  EntityManager entityManager=getOrCreateEntityManager();
  entityManager.getTransaction().begin();
  Location location=new Location();
  location.address="123 somewhere";
  location.zip=11234;
  entityManager.persist(location);
  Company companyNew=new Company();
  companyNew.location=location;
  entityManager.persist(companyNew);
  entityManager.getTransaction().commit();
  entityManager.close();
  entityManager=getOrCreateEntityManager();
  entityManager.getTransaction().begin();
  EntityGraph<Company> entityGraph=entityManager.createEntityGraph(Company.class);
  entityGraph.addAttributeNodes("markets");
  Query query=entityManager.createQuery("from " + Company.class.getName() + " c order by c.location.zip, c.id");
  query.setHint(QueryHints.HINT_LOADGRAPH,entityGraph);
  List results=query.getResultList();
  assertEquals(3,results.size());
  Company companyResult=(Company)results.get(0);
  assertFalse(Hibernate.isInitialized(companyResult.employees));
  assertFalse(Hibernate.isInitialized(companyResult.location));
  assertEquals(11234,companyResult.getLocation().getZip());
  assertTrue(Hibernate.isInitialized(companyResult.markets));
  assertEquals(0,companyResult.markets.size());
  assertTrue(Hibernate.isInitialized(companyResult.phoneNumbers));
  assertEquals(0,companyResult.phoneNumbers.size());
  companyResult=(Company)results.get(1);
  assertFalse(Hibernate.isInitialized(companyResult.employees));
  assertFalse(Hibernate.isInitialized(companyResult.location));
  assertEquals(12345,companyResult.getLocation().getZip());
  assertTrue(Hibernate.isInitialized(companyResult.markets));
  assertEquals(2,companyResult.markets.size());
  assertTrue(Hibernate.isInitialized(companyResult.phoneNumbers));
  assertEquals(2,companyResult.phoneNumbers.size());
  assertSame(companyResult,results.get(2));
  entityManager.getTransaction().commit();
  entityManager.close();
}
