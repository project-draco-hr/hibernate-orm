{
  final QueryJoinFragment joinFragment=new QueryJoinFragment(factory.getDialect(),useThetaStyle);
  if (rootJoinable != null) {
    joinFragment.addCrossJoin(rootJoinable.getTableName(),rootAlias);
    final String filterCondition=rootJoinable.filterFragment(rootAlias,enabledFilters,treatAsDeclarations);
    joinFragment.setHasFilterCondition(joinFragment.addCondition(filterCondition));
    addSubclassJoins(joinFragment,rootAlias,rootJoinable,true,includeAllSubclassJoins,treatAsDeclarations);
  }
  Joinable last=rootJoinable;
  for (  Join join : joins) {
    final String on=join.getAssociationType().getOnCondition(join.getAlias(),factory,enabledFilters,treatAsDeclarations);
    String condition;
    if (last != null && isManyToManyRoot(last) && ((QueryableCollection)last).getElementType() == join.getAssociationType()) {
      final String manyToManyFilter=((QueryableCollection)last).getManyToManyFilterFragment(join.getAlias(),enabledFilters);
      condition="".equals(manyToManyFilter) ? on : "".equals(on) ? manyToManyFilter : on + " and " + manyToManyFilter;
    }
 else {
      condition=on;
    }
    if (withClauseFragment != null && !isManyToManyRoot(join.joinable)) {
      condition+=" and " + withClauseFragment;
    }
    joinFragment.addJoin(join.getJoinable().getTableName(),join.getAlias(),join.getLHSColumns(),JoinHelper.getRHSColumnNames(join.getAssociationType(),factory),join.joinType,condition);
    addSubclassJoins(joinFragment,join.getAlias(),join.getJoinable(),join.joinType == JoinType.INNER_JOIN,includeAllSubclassJoins,treatAsDeclarations);
    last=join.getJoinable();
  }
  if (next != null) {
    joinFragment.addFragment(next.toJoinFragment(enabledFilters,includeAllSubclassJoins));
  }
  joinFragment.addCondition(conditions.toString());
  if (isFromPart) {
    joinFragment.clearWherePart();
  }
  return joinFragment;
}
