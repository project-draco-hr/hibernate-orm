{
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  Session s=openSession();
  VersionedEntity parent=new VersionedEntity("parent","parent");
  VersionedEntity child=new VersionedEntity("child","child");
  parent.getChildren().add(child);
  child.setParent(parent);
  s.persist(parent);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
  clearCounts();
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  s=openSession();
  VersionedEntity persistentParent=(VersionedEntity)s.get(VersionedEntity.class,parent.getId());
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  persistentParent=(VersionedEntity)getOldToNewEntityRefMap().get(persistentParent);
  VersionedEntity persistentChild=(VersionedEntity)persistentParent.getChildren().iterator().next();
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  persistentParent=(VersionedEntity)getOldToNewEntityRefMap().get(persistentParent);
  VersionedEntity mergedParent=(VersionedEntity)s.merge(persistentParent);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  mergedParent=(VersionedEntity)getOldToNewEntityRefMap().get(mergedParent);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
  assertUpdateCount(0);
  assertInsertCount(0);
  assertEquals("unexpected parent version increment",parent.getVersion(),mergedParent.getVersion());
  VersionedEntity mergedChild=(VersionedEntity)mergedParent.getChildren().iterator().next();
  assertEquals("unexpected child version increment",child.getVersion(),mergedChild.getVersion());
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  s=openSession();
  persistentParent=(VersionedEntity)s.get(VersionedEntity.class,parent.getId());
  persistentParent.setName("new name");
  persistentParent.getChildren().add(new VersionedEntity("child2","new child"));
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  persistentParent=(VersionedEntity)getOldToNewEntityRefMap().get(persistentParent);
  persistentParent=(VersionedEntity)s.merge(persistentParent);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
  assertUpdateCount(1);
  assertInsertCount(1);
}
