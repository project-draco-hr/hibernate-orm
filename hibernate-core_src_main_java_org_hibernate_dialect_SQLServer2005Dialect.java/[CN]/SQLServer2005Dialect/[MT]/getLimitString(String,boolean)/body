{
  StringBuilder sb=new StringBuilder(querySqlString.trim().toLowerCase());
  int orderByIndex=sb.indexOf("order by");
  CharSequence orderby=orderByIndex > 0 ? sb.subSequence(orderByIndex,sb.length()) : "ORDER BY CURRENT_TIMESTAMP";
  if (orderByIndex > 0) {
    sb.delete(orderByIndex,orderByIndex + orderby.length());
  }
  replaceDistinctWithGroupBy(sb);
  insertRowNumberFunction(sb,orderby);
  sb.insert(0,"WITH query AS (").append(") SELECT * FROM query ");
  sb.append("WHERE __hibernate_row_nr__ BETWEEN ? AND ?");
  return sb.toString();
}
