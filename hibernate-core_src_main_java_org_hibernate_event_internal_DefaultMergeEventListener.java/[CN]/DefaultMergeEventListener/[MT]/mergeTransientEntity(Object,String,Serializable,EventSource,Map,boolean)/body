{
  LOG.trace("Merging transient instance");
  final EntityPersister persister=source.getEntityPersister(entityName,entity);
  final Serializable id=persister.hasIdentifierProperty() ? persister.getIdentifier(entity,source) : null;
  if (copyCache.containsKey(entity)) {
    persister.setIdentifier(copyCache.get(entity),id,source);
  }
 else {
    ((EventCache)copyCache).put(entity,source.instantiate(persister,id),true);
  }
  final Object copy=copyCache.get(entity);
  super.cascadeBeforeSave(source,persister,entity,copyCache);
  copyValues(persister,entity,copy,source,copyCache,ForeignKeyDirection.FOREIGN_KEY_FROM_PARENT);
  try {
    saveTransientEntity(copy,entityName,requestedId,source,copyCache,isNullabilityChecked);
  }
 catch (  PropertyValueException ex) {
    String propertyName=ex.getPropertyName();
    Object propertyFromCopy=persister.getPropertyValue(copy,propertyName);
    Object propertyFromEntity=persister.getPropertyValue(entity,propertyName);
    Type propertyType=persister.getPropertyType(propertyName);
    EntityEntry copyEntry=source.getPersistenceContext().getEntry(copy);
    if (propertyFromCopy == null || propertyFromEntity == null || !propertyType.isEntityType() || !copyCache.containsKey(propertyFromEntity)) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("Property '" + copyEntry.getEntityName() + "."+ propertyName+ "' in copy is "+ (propertyFromCopy == null ? "null" : propertyFromCopy));
        LOG.trace("Property '" + copyEntry.getEntityName() + "."+ propertyName+ "' in original is "+ (propertyFromCopy == null ? "null" : propertyFromCopy));
        LOG.trace("Property '" + copyEntry.getEntityName() + "."+ propertyName+ "' is"+ (propertyType.isEntityType() ? "" : " not")+ " an entity type");
        if (propertyFromEntity != null && !copyCache.containsKey(propertyFromEntity)) {
          LOG.tracef("Property '%s.%s' is not in copy cache",copyEntry.getEntityName(),propertyName);
        }
      }
      if (isNullabilityCheckedGlobal(source)) {
        throw ex;
      }
 else {
        saveTransientEntity(copy,entityName,requestedId,source,copyCache,false);
      }
    }
    if (LOG.isTraceEnabled() && propertyFromEntity != null) {
      if (((EventCache)copyCache).isOperatedOn(propertyFromEntity))       LOG.trace("Property '" + copyEntry.getEntityName() + "."+ propertyName+ "' from original entity is in copyCache and is in the process of being merged; "+ propertyName+ " =["+ propertyFromEntity+ "]");
 else       LOG.trace("Property '" + copyEntry.getEntityName() + "."+ propertyName+ "' from original entity is in copyCache and is not in the process of being merged; "+ propertyName+ " =["+ propertyFromEntity+ "]");
    }
  }
  super.cascadeAfterSave(source,persister,entity,copyCache);
  copyValues(persister,entity,copy,source,copyCache,ForeignKeyDirection.FOREIGN_KEY_TO_PARENT);
  return copy;
}
