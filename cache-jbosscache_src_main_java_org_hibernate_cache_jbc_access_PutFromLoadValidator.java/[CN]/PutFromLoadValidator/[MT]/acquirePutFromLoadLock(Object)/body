{
  boolean valid=false;
  boolean locked=false;
  long now=System.currentTimeMillis();
  cleanOutdatedPendingPuts(now,true);
  try {
    PendingPutMap pending=pendingPuts.get(key);
    if (pending != null) {
      locked=pending.acquireLock(100,TimeUnit.MILLISECONDS);
      if (locked) {
        try {
          PendingPut toCancel=pending.remove(getOwnerForPut());
          if (toCancel != null) {
            valid=!toCancel.completed;
            toCancel.completed=true;
          }
        }
  finally {
          if (!valid) {
            pending.releaseLock();
            locked=false;
          }
        }
      }
    }
 else {
      if (now > invalidationTimestamp) {
        Long removedTime=recentRemovals.get(key);
        if (removedTime == null || now > removedTime.longValue()) {
          registerPendingPut(key);
          locked=acquirePutFromLoadLock(key);
          valid=locked;
        }
      }
    }
  }
 catch (  Throwable t) {
    valid=false;
    if (locked) {
      PendingPutMap toRelease=pendingPuts.get(key);
      if (toRelease != null) {
        toRelease.releaseLock();
      }
    }
    if (t instanceof RuntimeException) {
      throw (RuntimeException)t;
    }
 else     if (t instanceof Error) {
      throw (Error)t;
    }
 else {
      throw new RuntimeException(t);
    }
  }
  return valid;
}
