{
  collection.setOwner(entity);
  CollectionEntry ce=session.getPersistenceContext().getCollectionEntry(collection);
  if (ce == null) {
    throw new HibernateException("Found two representations of same collection: " + type.getRole());
  }
  if (ce.isReached()) {
    throw new HibernateException("Found shared references to a collection: " + type.getRole());
  }
  ce.setReached(true);
  SessionFactoryImplementor factory=session.getFactory();
  CollectionPersister persister=factory.getCollectionPersister(type.getRole());
  ce.setCurrentPersister(persister);
  ce.setCurrentKey(type.getKeyOfOwner(entity,session));
  if (log.isDebugEnabled()) {
    log.debug("Collection found: " + MessageHelper.collectionInfoString(persister,ce.getCurrentKey(),factory) + ", was: "+ MessageHelper.collectionInfoString(ce.getLoadedPersister(),ce.getLoadedKey(),factory)+ (collection.wasInitialized() ? " (initialized)" : " (uninitialized)"));
  }
  prepareCollectionForUpdate(collection,ce,session.getEntityMode(),factory);
}
