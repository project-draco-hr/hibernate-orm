{
  Session session=sessionFactory().openSession();
  session.getTransaction().begin();
  Session secondSession=session.sessionWithOptions().transactionContext().autoClose(true).openSession();
  assertTrue(((TransactionContext)secondSession).isAutoCloseSessionEnabled());
  assertTrue(((TransactionContext)secondSession).shouldAutoClose());
  session.getTransaction().commit();
  assertFalse(((SessionImplementor)session).isClosed());
  assertTrue(((SessionImplementor)secondSession).isClosed());
  session.close();
  assertTrue(((SessionImplementor)session).isClosed());
  assertTrue(((SessionImplementor)secondSession).isClosed());
  session=sessionFactory().openSession();
  session.getTransaction().begin();
  secondSession=session.sessionWithOptions().transactionContext().autoClose(true).openSession();
  assertTrue(((TransactionContext)secondSession).isAutoCloseSessionEnabled());
  assertTrue(((TransactionContext)secondSession).shouldAutoClose());
  session.getTransaction().rollback();
  assertFalse(((SessionImplementor)session).isClosed());
  assertTrue(((SessionImplementor)secondSession).isClosed());
  session.close();
  assertTrue(((SessionImplementor)session).isClosed());
  assertTrue(((SessionImplementor)secondSession).isClosed());
}
