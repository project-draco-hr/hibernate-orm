{
  Statistics stats=sessionFactory().getStatistics();
  stats.clear();
  VersionedItem item=null;
  Transaction txn=null;
  Session s=null;
  beginTx();
  try {
    s=openSession();
    txn=s.beginTransaction();
    item=new VersionedItem();
    item.setName("steve");
    item.setDescription("steve's item");
    s.save(item);
    txn.commit();
    s.close();
  }
 catch (  Exception e) {
    setRollbackOnlyTx(e);
  }
 finally {
    commitOrRollbackTx();
  }
  Long initialVersion=item.getVersion();
  item.setVersion(new Long(item.getVersion().longValue() - 1));
  beginTx();
  try {
    s=openSession();
    txn=s.beginTransaction();
    s.update(item);
    txn.commit();
    fail("expected stale write to fail");
  }
 catch (  Exception e) {
    setRollbackOnlyTxExpected(e);
  }
 finally {
    commitOrRollbackTx();
    if (s != null && s.isOpen()) {
      try {
        s.close();
      }
 catch (      Throwable ignore) {
      }
    }
  }
  SecondLevelCacheStatistics slcs=stats.getSecondLevelCacheStatistics(VersionedItem.class.getName());
  Object entry=slcs.getEntries().get(item.getId());
  Long cachedVersionValue;
  cachedVersionValue=(Long)((CacheEntry)entry).getVersion();
  assertEquals(initialVersion.longValue(),cachedVersionValue.longValue());
  beginTx();
  try {
    s=openSession();
    txn=s.beginTransaction();
    item=(VersionedItem)s.load(VersionedItem.class,item.getId());
    s.delete(item);
    txn.commit();
    s.close();
  }
 catch (  Exception e) {
    setRollbackOnlyTx(e);
  }
 finally {
    commitOrRollbackTx();
  }
}
