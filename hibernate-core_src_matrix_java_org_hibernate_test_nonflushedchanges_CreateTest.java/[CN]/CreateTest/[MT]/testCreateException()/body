{
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  Node dupe=new Node("dupe");
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  s.persist(dupe);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  dupe=(Node)getOldToNewEntityRefMap().get(dupe);
  s.persist(dupe);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  s.persist(dupe);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  try {
    TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
    Assert.fail();
  }
 catch (  ConstraintViolationException cve) {
  }
catch (  RollbackException e) {
    if (!ConstraintViolationException.class.isInstance(e.getCause())) {
      throw (Exception)e.getCause();
    }
  }
  if (JtaStatusHelper.isActive(TestingJtaBootstrap.INSTANCE.getTransactionManager())) {
    TestingJtaBootstrap.INSTANCE.getTransactionManager().rollback();
  }
  Node nondupe=new Node("nondupe");
  nondupe.addChild(dupe);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  s.persist(nondupe);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  try {
    TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
    Assert.fail();
  }
 catch (  ConstraintViolationException cve) {
  }
catch (  RollbackException e) {
    if (!ConstraintViolationException.class.isInstance(e.getCause())) {
      throw (Exception)e.getCause();
    }
  }
  if (JtaStatusHelper.isActive(TestingJtaBootstrap.INSTANCE.getTransactionManager())) {
    TestingJtaBootstrap.INSTANCE.getTransactionManager().rollback();
  }
}
