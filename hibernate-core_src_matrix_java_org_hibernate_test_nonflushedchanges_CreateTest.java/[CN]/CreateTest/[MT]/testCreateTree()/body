{
  clearCounts();
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  Node root=new Node("root");
  Node child=new Node("child");
  root.addChild(child);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  s.persist(root);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
  assertInsertCount(2);
  assertUpdateCount(0);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  s=openSession();
  System.out.println("getting");
  root=(Node)s.get(Node.class,"root");
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  Node child2=new Node("child2");
  root.addChild(child2);
  System.out.println("committing");
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
  assertInsertCount(3);
  assertUpdateCount(0);
}
