{
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  NumberedNode dupe=new NumberedNode("dupe");
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  s.persist(dupe);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  dupe=(NumberedNode)getOldToNewEntityRefMap().get(dupe);
  s.persist(dupe);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  dupe=(NumberedNode)getOldToNewEntityRefMap().get(dupe);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  try {
    s.persist(dupe);
    s.flush();
    assertFalse(true);
  }
 catch (  PersistentObjectException poe) {
  }
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().rollback();
  NumberedNode nondupe=new NumberedNode("nondupe");
  nondupe.addChild(dupe);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  try {
    s.persist(nondupe);
    assertFalse(true);
  }
 catch (  PersistentObjectException poe) {
  }
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().rollback();
}
