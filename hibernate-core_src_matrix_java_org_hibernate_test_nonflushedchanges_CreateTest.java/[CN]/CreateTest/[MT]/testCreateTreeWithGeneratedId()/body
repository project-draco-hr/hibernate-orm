{
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  NumberedNode root=new NumberedNode("root");
  NumberedNode child=new NumberedNode("child");
  root.addChild(child);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  s.persist(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(2);
  assertUpdateCount(0);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)s.get(NumberedNode.class,Long.valueOf(root.getId()));
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  NumberedNode child2=new NumberedNode("child2");
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  root.addChild(child2);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(3);
  assertUpdateCount(0);
}
