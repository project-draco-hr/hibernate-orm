{
  if (offset == 0) {
    return new StringBuffer(querySqlString.length() + 8).append(querySqlString).insert(getAfterSelectInsertPoint(querySqlString)," top " + limit).toString();
  }
  StringBuilder sb=new StringBuilder(querySqlString.trim());
  String querySqlLowered=querySqlString.trim().toLowerCase();
  int orderByIndex=querySqlLowered.toLowerCase().indexOf("order by");
  String orderby=orderByIndex > 0 ? querySqlString.substring(orderByIndex) : "ORDER BY CURRENT_TIMESTAMP";
  if (orderByIndex > 0) {
    sb.delete(orderByIndex,orderByIndex + orderby.length());
  }
  int selectIndex=querySqlLowered.trim().startsWith("select distinct") ? 15 : 6;
  sb.insert(selectIndex," ROW_NUMBER() OVER (" + orderby + ") as __hibernate_row_nr__,");
  sb.insert(0,"WITH query AS (").append(") SELECT * FROM query ");
  sb.append("WHERE __hibernate_row_nr__ ");
  if (offset > 0) {
    sb.append("BETWEEN ").append(offset + 1).append(" AND ").append(limit + 1);
  }
 else {
    sb.append(" <= ").append(limit);
  }
  return sb.toString();
}
