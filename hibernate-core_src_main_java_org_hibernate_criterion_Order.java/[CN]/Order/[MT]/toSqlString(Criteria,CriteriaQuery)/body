{
  String[] columns=criteriaQuery.getColumnsUsingProjection(criteria,propertyName);
  Type type=criteriaQuery.getTypeUsingProjection(criteria,propertyName);
  StringBuilder fragment=new StringBuilder();
  for (int i=0; i < columns.length; i++) {
    SessionFactoryImplementor factory=criteriaQuery.getFactory();
    boolean lower=false;
    if (ignoreCase) {
      int sqlType=type.sqlTypes(factory)[i];
      lower=sqlType == Types.VARCHAR || sqlType == Types.CHAR || sqlType == Types.LONGVARCHAR;
    }
    if (lower) {
      fragment.append(factory.getDialect().getLowercaseFunction()).append('(');
    }
    fragment.append(columns[i]);
    if (lower)     fragment.append(')');
    fragment.append(ascending ? " asc" : " desc");
    if (i < columns.length - 1)     fragment.append(", ");
  }
  return fragment.toString();
}
