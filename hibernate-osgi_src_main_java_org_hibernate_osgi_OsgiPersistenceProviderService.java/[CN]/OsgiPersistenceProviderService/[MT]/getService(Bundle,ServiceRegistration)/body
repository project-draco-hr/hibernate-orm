{
  final OsgiClassLoader osgiClassLoader=new OsgiClassLoader();
  osgiClassLoader.addBundle(requestingBundle);
  osgiClassLoader.addBundle(FrameworkUtil.getBundle(SessionFactory.class));
  osgiClassLoader.addBundle(FrameworkUtil.getBundle(HibernateEntityManagerFactory.class));
  final ClassLoader originalTccl=Thread.currentThread().getContextClassLoader();
  Thread.currentThread().setContextClassLoader(osgiClassLoader);
  try {
    return new OsgiPersistenceProvider(osgiClassLoader,osgiJtaPlatform,osgiServiceUtil,requestingBundle);
  }
  finally {
    Thread.currentThread().setContextClassLoader(originalTccl);
  }
}
