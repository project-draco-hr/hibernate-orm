{
  checkEntityManagerFactory();
  if (!open) {
    throw new IllegalStateException("EntityManager is closed");
  }
  if (discardOnClose || !isTransactionInProgress()) {
    if (session != null) {
      session.close();
    }
  }
  open=false;
}
