{
  Session s;
  Transaction tx;
  s=openSession();
  tx=s.beginTransaction();
  Troop t=new Troop();
  t.setName("Final cut");
  Soldier vandamme=new Soldier();
  vandamme.setName("JC Vandamme");
  t.addSoldier(vandamme);
  Soldier rambo=new Soldier();
  rambo.setName("Rambo");
  t.addSoldier(rambo);
  s.persist(t);
  tx.commit();
  s.close();
  s=openSession();
  tx=s.beginTransaction();
  t=(Troop)s.get(Troop.class,t.getId());
  assertNotNull(t.getSoldiers());
  assertFalse(Hibernate.isInitialized(t.getSoldiers()));
  assertEquals(2,t.getSoldiers().size());
  assertEquals(rambo.getName(),t.getSoldiers().iterator().next().getName());
  tx.commit();
  s.close();
  s=openSession();
  tx=s.beginTransaction();
  t=(Troop)s.createQuery("from " + Troop.class.getName() + " as t where t.id = :id").setParameter("id",t.getId()).uniqueResult();
  assertFalse(Hibernate.isInitialized(t.getSoldiers()));
  tx.commit();
  s.close();
  s=openSession();
  tx=s.beginTransaction();
  rambo=(Soldier)s.get(Soldier.class,rambo.getId());
  assertTrue(Hibernate.isInitialized(rambo.getTroop()));
  tx.commit();
  s.close();
  s=openSession();
  tx=s.beginTransaction();
  rambo=(Soldier)s.createQuery("from " + Soldier.class.getName() + " as s where s.id = :rid").setParameter("rid",rambo.getId()).uniqueResult();
  assertTrue("fetching strategy used when we do query",Hibernate.isInitialized(rambo.getTroop()));
  tx.commit();
  s.close();
}
