{
  StandardServiceRegistry ssr=new StandardServiceRegistryBuilder().applySetting(Environment.HBM2DDL_AUTO,"none").build();
  try {
    File output=File.createTempFile("update_script",".sql");
    output.deleteOnExit();
    final MetadataImplementor metadata=(MetadataImplementor)new MetadataSources(ssr).addAnnotatedClass(TestEntity.class).buildMetadata();
    metadata.validate();
    new SchemaUpdate().setHaltOnError(true).setOutputFile(output.getAbsolutePath()).setDelimiter(DELIMITER).setFormat(true).execute(EnumSet.of(TargetType.SCRIPT),metadata);
    String outputContent=new String(Files.readAllBytes(output.toPath()));
    outputContent=outputContent.replaceAll("\r","\n");
    outputContent=outputContent.replaceAll("\n\n","\n");
    Assert.assertTrue(Pattern.compile(AFTER_FORMAT).matcher(outputContent).matches());
  }
  finally {
    StandardServiceRegistryBuilder.destroy(ssr);
  }
}
