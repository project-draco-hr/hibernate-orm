{
  log.trace("merging transient instance");
  final EntityPersister persister=source.getEntityPersister(entityName,entity);
  final Serializable id=persister.hasIdentifierProperty() ? persister.getIdentifier(entity,source) : null;
  if (copyCache.containsKey(entity)) {
    persister.setIdentifier(copyCache.get(entity),id,source);
  }
 else {
    ((EventCache)copyCache).put(entity,persister.instantiate(id,source),true);
  }
  final Object copy=copyCache.get(entity);
  super.cascadeBeforeSave(source,persister,entity,copyCache);
  copyValues(persister,entity,copy,source,copyCache,ForeignKeyDirection.FOREIGN_KEY_FROM_PARENT);
  try {
    if (requestedId == null) {
      saveWithGeneratedId(copy,entityName,copyCache,source,false);
    }
 else {
      saveWithRequestedId(copy,requestedId,entityName,copyCache,source);
    }
  }
 catch (  PropertyValueException ex) {
    String propertyName=ex.getPropertyName();
    Object propertyFromCopy=persister.getPropertyValue(copy,propertyName,source.getEntityMode());
    Object propertyFromEntity=persister.getPropertyValue(entity,propertyName,source.getEntityMode());
    Type propertyType=persister.getPropertyType(propertyName);
    EntityEntry copyEntry=source.getPersistenceContext().getEntry(copy);
    if (propertyFromCopy == null || !propertyType.isEntityType()) {
      log.trace("property '" + copyEntry.getEntityName() + "."+ propertyName+ "' is null or not an entity; "+ propertyName+ " =["+ propertyFromCopy+ "]");
      throw ex;
    }
    if (!copyCache.containsKey(propertyFromEntity)) {
      log.trace("property '" + copyEntry.getEntityName() + "."+ propertyName+ "' from original entity is not in copyCache; "+ propertyName+ " =["+ propertyFromEntity+ "]");
      throw ex;
    }
    if (((EventCache)copyCache).isOperatedOn(propertyFromEntity)) {
      log.trace("property '" + copyEntry.getEntityName() + "."+ propertyName+ "' from original entity is in copyCache and is in the process of being merged; "+ propertyName+ " =["+ propertyFromEntity+ "]");
    }
 else {
      log.trace("property '" + copyEntry.getEntityName() + "."+ propertyName+ "' from original entity is in copyCache and is not in the process of being merged; "+ propertyName+ " =["+ propertyFromEntity+ "]");
    }
  }
  super.cascadeAfterSave(source,persister,entity,copyCache);
  copyValues(persister,entity,copy,source,copyCache,ForeignKeyDirection.FOREIGN_KEY_TO_PARENT);
  return copy;
}
