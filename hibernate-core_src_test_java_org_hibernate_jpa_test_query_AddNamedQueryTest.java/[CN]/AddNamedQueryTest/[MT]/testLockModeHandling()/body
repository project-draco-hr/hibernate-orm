{
  final String name="lock-mode-handling";
  EntityManager em=getOrCreateEntityManager();
  em.getTransaction().begin();
  Query q=em.createQuery("from Item");
  assertEquals(LockModeType.NONE,q.getLockMode());
  q.setLockMode(LockModeType.OPTIMISTIC);
  assertEquals(LockModeType.OPTIMISTIC,q.getLockMode());
  em.getEntityManagerFactory().addNamedQuery(name,q);
  SessionFactoryImplementor sfi=entityManagerFactory().unwrap(SessionFactoryImplementor.class);
  NamedQueryDefinition def=sfi.getNamedQueryRepository().getNamedQueryDefinition(name);
  assertEquals(LockMode.OPTIMISTIC,def.getLockOptions().getLockMode());
  q=em.createNamedQuery(name);
  assertEquals(LockMode.OPTIMISTIC,q.unwrap(org.hibernate.Query.class).getLockOptions().getLockMode());
  assertEquals(LockModeType.OPTIMISTIC,q.getLockMode());
  em.getTransaction().commit();
  em.close();
}
