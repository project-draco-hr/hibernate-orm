{
  if (persister.isSelectBeforeUpdateRequired()) {
    Object[] snapshot=session.getPersistenceContext().getDatabaseSnapshot(id,persister);
    if (snapshot == null) {
      if (session.getFactory().getStatistics().isStatisticsEnabled()) {
        session.getFactory().getStatisticsImplementor().optimisticFailure(persister.getEntityName());
      }
      throw new StaleObjectStateException(persister.getEntityName(),id);
    }
 else {
      return snapshot;
    }
  }
 else {
    EntityKey entityKey=new EntityKey(id,persister,session.getEntityMode());
    return session.getPersistenceContext().getCachedDatabaseSnapshot(entityKey);
  }
}
