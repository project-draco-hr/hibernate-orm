{
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  EntityManager em=entityManagerFactory().createEntityManager();
  final SessionImpl sImpl=em.unwrap(SessionImpl.class);
  final CountDownLatch latch=new CountDownLatch(1);
  Thread thread=new Thread(){
    public void run(){
      sImpl.getTransactionCoordinator().getSynchronizationCallbackCoordinator().afterCompletion(Status.STATUS_ROLLEDBACK);
      latch.countDown();
    }
  }
;
  thread.start();
  latch.await();
  boolean caught=false;
  try {
    em.persist(new Book("The Book of Foo",1));
  }
 catch (  PersistenceException e) {
    caught=e.getCause().getClass().equals(HibernateException.class);
  }
  assertTrue(caught);
  caught=false;
  try {
    em.createQuery("from Book").getResultList();
  }
 catch (  PersistenceException e) {
    caught=e.getCause().getClass().equals(GenericJDBCException.class);
  }
  assertTrue(caught);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().rollback();
  em.close();
}
