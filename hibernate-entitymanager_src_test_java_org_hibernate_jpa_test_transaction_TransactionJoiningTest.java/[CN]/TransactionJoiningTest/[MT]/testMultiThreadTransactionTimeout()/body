{
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  EntityManager em=entityManagerFactory().createEntityManager();
  final SessionImpl sImpl=em.unwrap(SessionImpl.class);
  final CountDownLatch latch=new CountDownLatch(1);
  Thread thread=new Thread(){
    public void run(){
      sImpl.getTransactionCoordinator().getSynchronizationCallbackCoordinator().afterCompletion(Status.STATUS_ROLLEDBACK);
      latch.countDown();
    }
  }
;
  thread.start();
  latch.await();
  em.persist(new Book("The Book of Foo",1));
  assertEquals("The background thread did not clear the session as expected!",0,em.createQuery("from Book").getResultList().size());
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
  em.close();
}
