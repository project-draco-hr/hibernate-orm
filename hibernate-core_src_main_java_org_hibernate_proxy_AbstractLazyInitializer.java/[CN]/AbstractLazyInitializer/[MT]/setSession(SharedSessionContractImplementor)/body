{
  if (s != session) {
    if (s == null) {
      unsetSession();
    }
 else     if (isConnectedToSession()) {
      throw new HibernateException("illegally attempted to associate a proxy with two open Sessions");
    }
 else {
      session=s;
      if (readOnlyBeforeAttachedToSession == null) {
        final EntityPersister persister=s.getFactory().getEntityPersister(entityName);
        setReadOnly(s.getPersistenceContext().isDefaultReadOnly() || !persister.isMutable());
      }
 else {
        setReadOnly(readOnlyBeforeAttachedToSession);
        readOnlyBeforeAttachedToSession=null;
      }
    }
  }
}
