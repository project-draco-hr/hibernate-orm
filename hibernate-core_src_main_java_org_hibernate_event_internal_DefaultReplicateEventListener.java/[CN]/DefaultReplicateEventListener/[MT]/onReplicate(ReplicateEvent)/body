{
  final EventSource source=event.getSession();
  if (source.getPersistenceContext().reassociateIfUninitializedProxy(event.getObject())) {
    LOG.trace("Uninitialized proxy passed to replicate()");
    return;
  }
  Object entity=source.getPersistenceContext().unproxyAndReassociate(event.getObject());
  if (source.getPersistenceContext().isEntryFor(entity)) {
    LOG.trace("Ignoring persistent instance passed to replicate()");
    return;
  }
  EntityPersister persister=source.getEntityPersister(event.getEntityName(),entity);
  Serializable id=persister.getIdentifier(entity,source);
  if (id == null) {
    throw new TransientObjectException("instance with null id passed to replicate()");
  }
  final ReplicationMode replicationMode=event.getReplicationMode();
  final Object oldVersion;
  if (replicationMode == ReplicationMode.EXCEPTION) {
    oldVersion=null;
  }
 else {
    oldVersion=persister.getCurrentVersion(id,source);
  }
  final boolean traceEnabled=LOG.isTraceEnabled();
  if (oldVersion != null) {
    if (traceEnabled) {
      LOG.tracev("Found existing row for {0}",MessageHelper.infoString(persister,id,source.getFactory()));
    }
    final Object realOldVersion=persister.isVersioned() ? oldVersion : null;
    boolean canReplicate=replicationMode.shouldOverwriteCurrentVersion(entity,realOldVersion,persister.getVersion(entity),persister.getVersionType());
    if (canReplicate)     performReplication(entity,id,realOldVersion,persister,replicationMode,source);
 else     if (traceEnabled)     LOG.trace("No need to replicate");
  }
 else {
    if (traceEnabled) {
      LOG.tracev("No existing row, replicating new instance {0}",MessageHelper.infoString(persister,id,source.getFactory()));
    }
    final boolean regenerate=persister.isIdentifierAssignedByInsert();
    final EntityKey key=regenerate ? null : source.generateEntityKey(id,persister);
    performSaveOrReplicate(entity,key,persister,regenerate,replicationMode,source,true);
  }
}
