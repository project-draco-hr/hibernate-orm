{
  EntityManager entityManager=createEntityManager();
  entityManager.getTransaction().begin();
  Session session=entityManager.unwrap(Session.class);
  session.doWork(new Work(){
    @Override public void execute(    Connection connection) throws SQLException {
      Statement statement=null;
      try {
        statement=connection.createStatement();
        statement.executeUpdate("DROP FUNCTION sp_count_phones(bigint)");
      }
 catch (      SQLException ignore) {
      }
 finally {
        if (statement != null) {
          statement.close();
        }
      }
    }
  }
);
  entityManager.getTransaction().commit();
  entityManager.close();
  entityManager=createEntityManager();
  entityManager.getTransaction().begin();
  session=entityManager.unwrap(Session.class);
  session.doWork(new Work(){
    @Override public void execute(    Connection connection) throws SQLException {
      Statement statement=null;
      try {
        statement=connection.createStatement();
        statement.executeUpdate("DROP FUNCTION fn_phones(bigint)");
      }
 catch (      SQLException ignore) {
      }
 finally {
        if (statement != null) {
          statement.close();
        }
      }
    }
  }
);
  entityManager.getTransaction().commit();
  entityManager.close();
  entityManager=createEntityManager();
  entityManager.getTransaction().begin();
  session=entityManager.unwrap(Session.class);
  session.doWork(new Work(){
    @Override public void execute(    Connection connection) throws SQLException {
      Statement statement=null;
      try {
        statement=connection.createStatement();
        statement.executeUpdate("CREATE OR REPLACE FUNCTION sp_count_phones( " + "   IN personId bigint, " + "   OUT phoneCount bigint) "+ "   RETURNS bigint AS "+ "$BODY$ "+ "    BEGIN "+ "        SELECT COUNT(*) INTO phoneCount "+ "        FROM phone  "+ "        WHERE person_id = personId; "+ "    END; "+ "$BODY$ "+ "LANGUAGE plpgsql;");
        statement.executeUpdate("CREATE OR REPLACE FUNCTION fn_phones(personId BIGINT) " + "   RETURNS REFCURSOR AS " + "$BODY$ "+ "    DECLARE "+ "        phones REFCURSOR; "+ "    BEGIN "+ "        OPEN phones FOR  "+ "            SELECT *  "+ "            FROM phone   "+ "            WHERE person_id = personId;  "+ "        RETURN phones; "+ "    END; "+ "$BODY$ "+ "LANGUAGE plpgsql");
      }
  finally {
        if (statement != null) {
          statement.close();
        }
      }
    }
  }
);
  entityManager.getTransaction().commit();
  entityManager.close();
  entityManager=createEntityManager();
  entityManager.getTransaction().begin();
  Person person1=new Person("John Doe");
  person1.setNickName("JD");
  person1.setAddress("Earth");
  person1.setCreatedOn(Timestamp.from(LocalDateTime.of(2000,1,1,0,0,0).toInstant(ZoneOffset.UTC)));
  entityManager.persist(person1);
  Phone phone1=new Phone("123-456-7890");
  phone1.setId(1L);
  person1.addPhone(phone1);
  Phone phone2=new Phone("098_765-4321");
  phone2.setId(2L);
  person1.addPhone(phone2);
  entityManager.getTransaction().commit();
  entityManager.close();
}
