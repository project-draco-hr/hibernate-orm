{
  final Map settings=generateSettings(properties);
  settings.put(org.hibernate.jpa.AvailableSettings.SCANNER,new OsgiScanner(requestingBundle));
  settings.put(AvailableSettings.ENVIRONMENT_CLASSLOADER,osgiClassLoader);
  osgiClassLoader.addBundle(requestingBundle);
  final EntityManagerFactoryBuilder builder=getEntityManagerFactoryBuilderOrNull(persistenceUnitName,settings,osgiClassLoader);
  return builder == null ? null : builder.build();
}
