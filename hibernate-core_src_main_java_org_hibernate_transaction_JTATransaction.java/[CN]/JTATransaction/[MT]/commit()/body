{
  if (!begun) {
    throw new TransactionException("Transaction not successfully started");
  }
  LOG.debugf("Commit");
  boolean flush=!transactionContext.isFlushModeNever() && (callback || !transactionContext.isFlushBeforeCompletionEnabled());
  if (flush) {
    transactionContext.managedFlush();
  }
  if (callback && newTransaction) {
    jdbcContext.beforeTransactionCompletion(this);
  }
  closeIfRequired();
  if (newTransaction) {
    try {
      userTransaction.commit();
      commitSucceeded=true;
      LOG.debugf("Committed JTA UserTransaction");
    }
 catch (    Exception e) {
      commitFailed=true;
      LOG.error(LOG.unableToCommitJta(),e);
      throw new TransactionException(LOG.unableToCommitJta(),e);
    }
 finally {
      afterCommitRollback();
    }
  }
 else {
    afterCommitRollback();
  }
}
