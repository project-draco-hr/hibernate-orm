{
  if (!begun && !commitFailed) {
    throw new TransactionException("Transaction not successfully started");
  }
  log.debug("rollback");
  try {
    closeIfRequired();
  }
 catch (  Exception e) {
    log.error("could not close session during rollback",e);
  }
  try {
    if (newTransaction) {
      if (!commitFailed) {
        userTransaction.rollback();
        log.debug("Rolled back JTA UserTransaction");
      }
    }
 else {
      userTransaction.setRollbackOnly();
      log.debug("set JTA UserTransaction to rollback only");
    }
  }
 catch (  Exception e) {
    log.error("JTA rollback failed",e);
    throw new TransactionException("JTA rollback failed",e);
  }
 finally {
    afterCommitRollback();
  }
}
