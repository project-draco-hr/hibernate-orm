{
  if (!begun && !commitFailed) {
    throw new TransactionException("Transaction not successfully started");
  }
  LOG.debugf("Rollback");
  try {
    closeIfRequired();
  }
 catch (  Exception e) {
    LOG.unableToCloseSessionDuringRollback(e);
  }
  try {
    if (newTransaction) {
      if (!commitFailed) {
        userTransaction.rollback();
        LOG.debugf("Rolled back JTA UserTransaction");
      }
    }
 else {
      userTransaction.setRollbackOnly();
      LOG.debugf("Set JTA UserTransaction to rollback only");
    }
  }
 catch (  Exception e) {
    LOG.error(LOG.unableToRollbackJta(),e);
    throw new TransactionException(LOG.unableToRollbackJta(),e);
  }
 finally {
    afterCommitRollback();
  }
}
