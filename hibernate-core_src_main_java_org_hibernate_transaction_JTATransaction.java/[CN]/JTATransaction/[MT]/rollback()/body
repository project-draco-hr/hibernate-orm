{
  if (!begun && !commitFailed) {
    throw new TransactionException("Transaction not successfully started");
  }
  LOG.rollback();
  try {
    closeIfRequired();
  }
 catch (  Exception e) {
    LOG.error(LOG.unableToCloseSessionDuringRollback(),e);
  }
  try {
    if (newTransaction) {
      if (!commitFailed) {
        userTransaction.rollback();
        LOG.rolledBackJtaUserTransaction();
      }
    }
 else {
      userTransaction.setRollbackOnly();
      LOG.jtaUserTransactionSetToRollbackOnly();
    }
  }
 catch (  Exception e) {
    LOG.error(LOG.unableToRollbackJta(),e);
    throw new TransactionException(LOG.unableToRollbackJta(),e);
  }
 finally {
    afterCommitRollback();
  }
}
