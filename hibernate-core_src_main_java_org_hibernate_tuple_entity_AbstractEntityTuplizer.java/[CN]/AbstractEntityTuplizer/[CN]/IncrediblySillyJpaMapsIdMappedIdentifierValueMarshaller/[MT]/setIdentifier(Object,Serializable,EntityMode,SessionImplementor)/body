{
  final Object[] extractedValues=mappedIdentifierType.getPropertyValues(id,entityMode);
  final Object[] injectionValues=new Object[extractedValues.length];
  final PersistenceContext persistenceContext=session.getPersistenceContext();
  for (int i=0; i < virtualIdComponent.getSubtypes().length; i++) {
    final Type virtualPropertyType=virtualIdComponent.getSubtypes()[i];
    final Type idClassPropertyType=mappedIdentifierType.getSubtypes()[i];
    if (virtualPropertyType.isEntityType() && !idClassPropertyType.isEntityType()) {
      if (session == null) {
        throw new AssertionError("Deprecated version of getIdentifier (no session) was used but session was required");
      }
      final String associatedEntityName=((EntityType)virtualPropertyType).getAssociatedEntityName();
      final EntityKey entityKey=session.generateEntityKey((Serializable)extractedValues[i],session.getFactory().getEntityPersister(associatedEntityName));
      Object association=persistenceContext.getProxy(entityKey);
      if (association == null) {
        association=persistenceContext.getEntity(entityKey);
      }
      injectionValues[i]=association;
    }
 else {
      injectionValues[i]=extractedValues[i];
    }
  }
  virtualIdComponent.setPropertyValues(entity,injectionValues,entityMode);
}
