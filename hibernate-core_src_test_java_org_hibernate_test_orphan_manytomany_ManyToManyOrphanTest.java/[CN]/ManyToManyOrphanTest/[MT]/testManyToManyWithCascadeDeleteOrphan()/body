{
  Session s=openSession();
  Transaction t=s.beginTransaction();
  User bob=new User("bob","jboss");
  Group seam=new Group("seam","jboss");
  seam.setGroupType(1);
  Group hb=new Group("hibernate","jboss");
  hb.setGroupType(2);
  bob.getGroups().put(seam.getGroupType(),seam);
  bob.getGroups().put(hb.getGroupType(),hb);
  s.persist(bob);
  s.persist(seam);
  s.persist(hb);
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  bob=(User)s.get(User.class,"bob");
  assertEquals(2,bob.getGroups().size());
  seam=(Group)s.get(Group.class,"seam");
  assertEquals((Integer)1,seam.getGroupType());
  hb=(Group)s.get(Group.class,"hibernate");
  assertEquals((Integer)2,hb.getGroupType());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  bob=(User)s.get(User.class,"bob");
  assertEquals(2,bob.getGroups().size());
  hb=(Group)s.get(Group.class,"hibernate");
  bob.getGroups().remove(hb.getGroupType());
  assertEquals(1,bob.getGroups().size());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  bob=(User)s.get(User.class,"bob");
  assertEquals(1,bob.getGroups().size());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  List<Group> groups=s.createCriteria(Group.class).list();
  assertEquals(1,groups.size());
  assertEquals("seam",groups.get(0).getName());
  t.commit();
  s.close();
}
