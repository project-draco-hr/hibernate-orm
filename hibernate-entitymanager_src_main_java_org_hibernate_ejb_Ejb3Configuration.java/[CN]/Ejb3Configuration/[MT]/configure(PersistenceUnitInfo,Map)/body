{
  if (LOG.isDebugEnabled())   LOG.debugf("Processing %s",LogHelper.logPersistenceUnitInfo(info));
 else   LOG.processingPersistenceUnitInfoName(info.getPersistenceUnitName());
  integration=integration != null ? Collections.unmodifiableMap(integration) : CollectionHelper.EMPTY_MAP;
  String provider=(String)integration.get(AvailableSettings.PROVIDER);
  if (provider == null) {
    provider=info.getPersistenceProviderClassName();
  }
  if (provider != null && !provider.trim().startsWith(IMPLEMENTATION_NAME)) {
    LOG.requiredDifferentProvider(provider);
    return null;
  }
  if (info.getClassLoader() == null) {
    throw new IllegalStateException("[PersistenceUnit: " + info.getPersistenceUnitName() == null ? "" : info.getPersistenceUnitName() + "] " + "PersistenceUnitInfo.getClassLoader() id null");
  }
  Thread thread=Thread.currentThread();
  ClassLoader contextClassLoader=thread.getContextClassLoader();
  boolean sameClassLoader=info.getClassLoader().equals(contextClassLoader);
  if (!sameClassLoader) {
    overridenClassLoader=info.getClassLoader();
    thread.setContextClassLoader(overridenClassLoader);
  }
 else {
    overridenClassLoader=null;
  }
  try {
    Map workingVars=new HashMap();
    workingVars.put(AvailableSettings.PERSISTENCE_UNIT_NAME,info.getPersistenceUnitName());
    this.persistenceUnitName=info.getPersistenceUnitName();
    List<String> entities=new ArrayList<String>(50);
    if (info.getManagedClassNames() != null)     entities.addAll(info.getManagedClassNames());
    List<NamedInputStream> hbmFiles=new ArrayList<NamedInputStream>();
    List<String> packages=new ArrayList<String>();
    List<String> xmlFiles=new ArrayList<String>(50);
    List<XmlDocument> xmlDocuments=new ArrayList<XmlDocument>(50);
    if (info.getMappingFileNames() != null) {
      xmlFiles.addAll(info.getMappingFileNames());
    }
    boolean searchForORMFiles=!xmlFiles.contains(META_INF_ORM_XML);
    ScanningContext context=new ScanningContext();
    final Properties copyOfProperties=(Properties)info.getProperties().clone();
    ConfigurationHelper.overrideProperties(copyOfProperties,integration);
    context.scanner(buildScanner(copyOfProperties,integration)).searchOrm(searchForORMFiles).explicitMappingFiles(null);
    setDetectedArtifactsOnScanningContext(context,info.getProperties(),null,false);
    for (    URL jar : info.getJarFileUrls()) {
      context.url(jar);
      scanForClasses(context,packages,entities,hbmFiles);
    }
    context.url(info.getPersistenceUnitRootUrl());
    setDetectedArtifactsOnScanningContext(context,info.getProperties(),null,info.excludeUnlistedClasses());
    scanForClasses(context,packages,entities,hbmFiles);
    Properties properties=info.getProperties() != null ? info.getProperties() : new Properties();
    ConfigurationHelper.overrideProperties(properties,integration);
    addXMLEntities(xmlFiles,info,entities,xmlDocuments);
    if ("true".equalsIgnoreCase(properties.getProperty(AvailableSettings.USE_CLASS_ENHANCER))) {
      info.addTransformer(new InterceptFieldClassFileTransformer(entities));
    }
    workingVars.put(AvailableSettings.CLASS_NAMES,entities);
    workingVars.put(AvailableSettings.PACKAGE_NAMES,packages);
    workingVars.put(AvailableSettings.XML_FILE_NAMES,xmlFiles);
    workingVars.put(PARSED_MAPPING_DOMS,xmlDocuments);
    if (hbmFiles.size() > 0) {
      workingVars.put(AvailableSettings.HBXML_FILES,hbmFiles);
    }
    final Object validationFactory=integration.get(AvailableSettings.VALIDATION_FACTORY);
    if (validationFactory != null) {
      properties.put(AvailableSettings.VALIDATION_FACTORY,validationFactory);
    }
{
      final Object integrationValue=integration.get(AvailableSettings.VALIDATION_MODE);
      if (integrationValue != null) {
        properties.put(AvailableSettings.VALIDATION_MODE,integrationValue.toString());
      }
 else       if (info.getValidationMode() != null) {
        properties.put(AvailableSettings.VALIDATION_MODE,info.getValidationMode().name());
      }
    }
{
      final Object integrationValue=integration.get(AvailableSettings.SHARED_CACHE_MODE);
      if (integrationValue != null) {
        properties.put(AvailableSettings.SHARED_CACHE_MODE,integrationValue.toString());
      }
 else       if (info.getSharedCacheMode() != null) {
        properties.put(AvailableSettings.SHARED_CACHE_MODE,info.getSharedCacheMode().name());
      }
    }
    Boolean isJTA=null;
    boolean overridenDatasource=false;
    if (integration.containsKey(AvailableSettings.JTA_DATASOURCE)) {
      String dataSource=(String)integration.get(AvailableSettings.JTA_DATASOURCE);
      overridenDatasource=true;
      properties.setProperty(Environment.DATASOURCE,dataSource);
      isJTA=Boolean.TRUE;
    }
    if (integration.containsKey(AvailableSettings.NON_JTA_DATASOURCE)) {
      String dataSource=(String)integration.get(AvailableSettings.NON_JTA_DATASOURCE);
      overridenDatasource=true;
      properties.setProperty(Environment.DATASOURCE,dataSource);
      if (isJTA == null)       isJTA=Boolean.FALSE;
    }
    if (!overridenDatasource && (info.getJtaDataSource() != null || info.getNonJtaDataSource() != null)) {
      isJTA=info.getJtaDataSource() != null ? Boolean.TRUE : Boolean.FALSE;
      this.setDataSource(isJTA ? info.getJtaDataSource() : info.getNonJtaDataSource());
      this.setProperty(Environment.CONNECTION_PROVIDER,InjectedDataSourceConnectionProvider.class.getName());
    }
    PersistenceUnitTransactionType transactionType=info.getTransactionType();
    if (transactionType == null) {
      if (isJTA == Boolean.TRUE) {
        transactionType=PersistenceUnitTransactionType.JTA;
      }
 else       if (isJTA == Boolean.FALSE) {
        transactionType=PersistenceUnitTransactionType.RESOURCE_LOCAL;
      }
 else {
        transactionType=PersistenceUnitTransactionType.JTA;
      }
    }
    defineTransactionType(transactionType,workingVars);
    configure(properties,workingVars);
  }
  finally {
    if (!sameClassLoader) {
      thread.setContextClassLoader(contextClassLoader);
    }
  }
  return this;
}
