{
  if (isConfigurationProcessed)   return this;
  isConfigurationProcessed=true;
  Properties preparedProperties=prepareProperties(properties,workingVars);
  if (workingVars == null)   workingVars=CollectionHelper.EMPTY_MAP;
  if (preparedProperties.containsKey(AvailableSettings.CFG_FILE)) {
    String cfgFileName=preparedProperties.getProperty(AvailableSettings.CFG_FILE);
    cfg.configure(cfgFileName);
  }
  cfg.addProperties(preparedProperties);
  addClassesToSessionFactory(workingVars);
  List<String> jaccKeys=new ArrayList<String>();
  Interceptor defaultInterceptor=DEFAULT_CONFIGURATION.getInterceptor();
  NamingStrategy defaultNamingStrategy=DEFAULT_CONFIGURATION.getNamingStrategy();
  Iterator propertyIt=preparedProperties.keySet().iterator();
  while (propertyIt.hasNext()) {
    Object uncastObject=propertyIt.next();
    if (uncastObject != null && uncastObject instanceof String) {
      String propertyKey=(String)uncastObject;
      if (propertyKey.startsWith(AvailableSettings.CLASS_CACHE_PREFIX)) {
        setCacheStrategy(propertyKey,preparedProperties,true,workingVars);
      }
 else       if (propertyKey.startsWith(AvailableSettings.COLLECTION_CACHE_PREFIX)) {
        setCacheStrategy(propertyKey,preparedProperties,false,workingVars);
      }
 else       if (propertyKey.startsWith(AvailableSettings.JACC_PREFIX) && !(propertyKey.equals(AvailableSettings.JACC_CONTEXT_ID) || propertyKey.equals(AvailableSettings.JACC_ENABLED))) {
        jaccKeys.add(propertyKey);
      }
    }
  }
  final Interceptor interceptor=instantiateCustomClassFromConfiguration(preparedProperties,defaultInterceptor,cfg.getInterceptor(),AvailableSettings.INTERCEPTOR,"interceptor",Interceptor.class);
  if (interceptor != null) {
    cfg.setInterceptor(interceptor);
  }
  final NamingStrategy namingStrategy=instantiateCustomClassFromConfiguration(preparedProperties,defaultNamingStrategy,cfg.getNamingStrategy(),AvailableSettings.NAMING_STRATEGY,"naming strategy",NamingStrategy.class);
  if (namingStrategy != null) {
    cfg.setNamingStrategy(namingStrategy);
  }
  final SessionFactoryObserver observer=instantiateCustomClassFromConfiguration(preparedProperties,null,cfg.getSessionFactoryObserver(),AvailableSettings.SESSION_FACTORY_OBSERVER,"SessionFactory observer",SessionFactoryObserver.class);
  if (observer != null) {
    cfg.setSessionFactoryObserver(observer);
  }
  final IdentifierGeneratorStrategyProvider strategyProvider=instantiateCustomClassFromConfiguration(preparedProperties,null,null,AvailableSettings.IDENTIFIER_GENERATOR_STRATEGY_PROVIDER,"Identifier generator strategy provider",IdentifierGeneratorStrategyProvider.class);
  if (strategyProvider != null) {
    final MutableIdentifierGeneratorFactory identifierGeneratorFactory=cfg.getIdentifierGeneratorFactory();
    for (    Map.Entry<String,Class<?>> entry : strategyProvider.getStrategies().entrySet()) {
      identifierGeneratorFactory.register(entry.getKey(),entry.getValue());
    }
  }
  if (jaccKeys.size() > 0) {
    addSecurity(jaccKeys,preparedProperties,workingVars);
  }
  if (!"true".equalsIgnoreCase(cfg.getProperty(Environment.AUTOCOMMIT)))   LOG.jdbcAutoCommitFalseBreaksEjb3Spec(Environment.AUTOCOMMIT);
  discardOnClose=preparedProperties.getProperty(AvailableSettings.DISCARD_PC_ON_CLOSE).equals("true");
  return this;
}
