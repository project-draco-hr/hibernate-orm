{
  Thread thread=null;
  ClassLoader contextClassLoader=null;
  if (overridenClassLoader != null) {
    thread=Thread.currentThread();
    contextClassLoader=thread.getContextClassLoader();
    thread.setContextClassLoader(overridenClassLoader);
  }
  try {
    final ServiceRegistry serviceRegistry=buildLifecycleControledServiceRegistry(builder);
    return new EntityManagerFactoryImpl(transactionType,discardOnClose,getSessionInterceptorClass(cfg.getProperties()),cfg,serviceRegistry,persistenceUnitName);
  }
 catch (  HibernateException e) {
    throw new PersistenceException(getExceptionHeader() + "Unable to build EntityManagerFactory",e);
  }
 finally {
    if (thread != null) {
      thread.setContextClassLoader(contextClassLoader);
    }
  }
}
