{
  AuditMetadataGenerator versionsMetaGen=new AuditMetadataGenerator(cfg,globalCfg,verEntCfg,revisionInfoRelationMapping);
  DOMWriter writer=new DOMWriter();
  Iterator<PersistentClass> classes=GraphTopologicalSort.sort(new PersistentClassGraphDefiner(cfg)).iterator();
  Map<PersistentClass,PersistentClassAuditingData> pcDatas=new HashMap<PersistentClass,PersistentClassAuditingData>();
  Map<PersistentClass,EntityXmlMappingData> xmlMappings=new HashMap<PersistentClass,EntityXmlMappingData>();
  while (classes.hasNext()) {
    PersistentClass pc=classes.next();
    AnnotationsMetadataReader annotationsMetadataReader=new AnnotationsMetadataReader(globalCfg,reflectionManager,pc);
    PersistentClassAuditingData auditData=annotationsMetadataReader.getAuditData();
    if (auditData.isAudited()) {
      pcDatas.put(pc,auditData);
      if (!StringTools.isEmpty(auditData.getAuditTable().value())) {
        verEntCfg.addCustomVersionsTableName(pc.getEntityName(),auditData.getAuditTable().value());
      }
      EntityXmlMappingData xmlMappingData=new EntityXmlMappingData();
      versionsMetaGen.generateFirstPass(pc,auditData,xmlMappingData);
      xmlMappings.put(pc,xmlMappingData);
    }
  }
  for (  Map.Entry<PersistentClass,PersistentClassAuditingData> pcDatasEntry : pcDatas.entrySet()) {
    EntityXmlMappingData xmlMappingData=xmlMappings.get(pcDatasEntry.getKey());
    versionsMetaGen.generateSecondPass(pcDatasEntry.getKey(),pcDatasEntry.getValue(),xmlMappingData);
    try {
      cfg.addDocument(writer.write(xmlMappingData.getMainXmlMapping()));
      for (      Document additionalMapping : xmlMappingData.getAdditionalXmlMappings()) {
        cfg.addDocument(writer.write(additionalMapping));
      }
    }
 catch (    DocumentException e) {
      throw new MappingException(e);
    }
  }
  if (pcDatas.size() > 0) {
    try {
      if (revisionInfoXmlMapping != null) {
        cfg.addDocument(writer.write(revisionInfoXmlMapping));
      }
    }
 catch (    DocumentException e) {
      throw new MappingException(e);
    }
  }
  return new EntitiesConfigurations(versionsMetaGen.getEntitiesConfigurations());
}
