{
  final Map integration=wrap(properties);
  final List<ParsedPersistenceXmlDescriptor> units=PersistenceXmlParser.locatePersistenceUnits(integration);
  if (persistenceUnitName == null && units.size() > 1) {
    throw new PersistenceException("No name provided and multiple persistence units found");
  }
  for (  ParsedPersistenceXmlDescriptor persistenceUnit : units) {
    boolean matches=persistenceUnitName == null || persistenceUnit.getName().equals(persistenceUnitName);
    if (!matches) {
      continue;
    }
    if (!ProviderChecker.isProvider(persistenceUnit,properties)) {
      continue;
    }
    return Bootstrap.getEntityManagerFactoryBuilder(persistenceUnit,integration).build();
  }
  return null;
}
