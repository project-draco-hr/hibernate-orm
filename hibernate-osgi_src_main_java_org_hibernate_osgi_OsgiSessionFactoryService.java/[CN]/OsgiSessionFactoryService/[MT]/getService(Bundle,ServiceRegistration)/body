{
  osgiClassLoader.addBundle(requestingBundle);
  final Configuration configuration=new Configuration();
  configuration.getProperties().put(AvailableSettings.JTA_PLATFORM,osgiJtaPlatform);
  configuration.configure();
  final BootstrapServiceRegistryBuilder builder=new BootstrapServiceRegistryBuilder();
  builder.with(osgiClassLoader);
  final List<Integrator> integrators=OsgiServiceUtil.getServiceImpls(Integrator.class,context);
  for (  Integrator integrator : integrators) {
    builder.with(integrator);
  }
  final List<StrategyRegistrationProvider> strategyRegistrationProviders=OsgiServiceUtil.getServiceImpls(StrategyRegistrationProvider.class,context);
  for (  StrategyRegistrationProvider strategyRegistrationProvider : strategyRegistrationProviders) {
    builder.withStrategySelectors(strategyRegistrationProvider);
  }
  final List<TypeContributor> typeContributors=OsgiServiceUtil.getServiceImpls(TypeContributor.class,context);
  for (  TypeContributor typeContributor : typeContributors) {
    configuration.registerTypeContributor(typeContributor);
  }
  final ServiceRegistry serviceRegistry=new StandardServiceRegistryBuilder(builder.build()).applySettings(configuration.getProperties()).build();
  return configuration.buildSessionFactory(serviceRegistry);
}
