{
  osgiClassLoader.addBundle(requestingBundle);
  Configuration configuration=new Configuration();
  configuration.getProperties().put(AvailableSettings.JTA_PLATFORM,osgiJtaPlatform);
  configuration.configure();
  BootstrapServiceRegistryBuilder builder=new BootstrapServiceRegistryBuilder();
  builder.with(osgiClassLoader);
  List<Integrator> integrators=OsgiServiceUtil.getServiceImpls(Integrator.class,context);
  for (  Integrator integrator : integrators) {
    builder.with(integrator);
  }
  ServiceRegistry serviceRegistry=new StandardServiceRegistryBuilder(builder.build()).applySettings(configuration.getProperties()).build();
  return configuration.buildSessionFactory(serviceRegistry);
}
