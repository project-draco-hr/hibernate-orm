{
  Session session=openSession();
  SessionImplementor sessionImpl=(SessionImplementor)session;
  TransactionCoordinator transactionCoordinator=sessionImpl.getTransactionCoordinator();
  JournalingTransactionObserver observer=new JournalingTransactionObserver();
  transactionCoordinator.addObserver(observer);
  final JdbcCoordinator jdbcCoordinator=transactionCoordinator.getJdbcCoordinator();
  LogicalConnectionImplementor logicalConnection=jdbcCoordinator.getLogicalConnection();
  Statement statement=jdbcCoordinator.getStatementPreparer().createStatement();
  jdbcCoordinator.getResultSetReturn().execute(statement,"drop table SANDBOX_JDBC_TST if exists");
  jdbcCoordinator.getResultSetReturn().execute(statement,"create table SANDBOX_JDBC_TST ( ID integer, NAME varchar(100) )");
  assertTrue(jdbcCoordinator.hasRegisteredResources());
  assertTrue(logicalConnection.isPhysicallyConnected());
  jdbcCoordinator.release(statement);
  assertFalse(jdbcCoordinator.hasRegisteredResources());
  assertTrue(logicalConnection.isPhysicallyConnected());
  TransactionImplementor txn=transactionCoordinator.getTransaction();
  txn.begin();
  assertEquals(1,observer.getBegins());
  final BatchBuilder batchBuilder=new BatchBuilderImpl(2);
  final BatchKey batchKey=new BasicBatchKey("this",Expectations.BASIC);
  final Batch insertBatch=batchBuilder.buildBatch(batchKey,jdbcCoordinator);
  assertTrue("unexpected Batch impl",BatchingBatch.class.isInstance(insertBatch));
  final JournalingBatchObserver batchObserver=new JournalingBatchObserver();
  insertBatch.addObserver(batchObserver);
  final String insertSql="insert into SANDBOX_JDBC_TST( ID, NAME ) values ( ?, ? )";
  PreparedStatement insert=insertBatch.getBatchStatement(insertSql,false);
  insert.setLong(1,1);
  insert.setString(2,"name");
  assertEquals(0,batchObserver.getExplicitExecutionCount());
  assertEquals(0,batchObserver.getImplicitExecutionCount());
  insertBatch.addToBatch();
  assertEquals(0,batchObserver.getExplicitExecutionCount());
  assertEquals(0,batchObserver.getImplicitExecutionCount());
  assertTrue(jdbcCoordinator.hasRegisteredResources());
  PreparedStatement insert2=insertBatch.getBatchStatement(insertSql,false);
  assertSame(insert,insert2);
  insert=insert2;
  insert.setLong(1,2);
  insert.setString(2,"another name");
  assertEquals(0,batchObserver.getExplicitExecutionCount());
  assertEquals(0,batchObserver.getImplicitExecutionCount());
  insertBatch.addToBatch();
  assertEquals(0,batchObserver.getExplicitExecutionCount());
  assertEquals(1,batchObserver.getImplicitExecutionCount());
  assertTrue(jdbcCoordinator.hasRegisteredResources());
  insertBatch.execute();
  assertEquals(1,batchObserver.getExplicitExecutionCount());
  assertEquals(1,batchObserver.getImplicitExecutionCount());
  assertFalse(jdbcCoordinator.hasRegisteredResources());
  insertBatch.release();
  txn.commit();
  session.close();
}
