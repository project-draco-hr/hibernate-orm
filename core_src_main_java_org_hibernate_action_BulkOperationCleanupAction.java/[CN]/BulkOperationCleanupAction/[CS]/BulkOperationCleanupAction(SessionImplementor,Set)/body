{
  Set tmpSpaces=new HashSet(tableSpaces);
  SessionFactoryImplementor factory=session.getFactory();
  Iterator iterator=factory.getAllClassMetadata().entrySet().iterator();
  while (iterator.hasNext()) {
    Map.Entry entry=(Map.Entry)iterator.next();
    String entityName=(String)entry.getKey();
    EntityPersister persister=factory.getEntityPersister(entityName);
    Serializable[] entitySpaces=persister.getQuerySpaces();
    if (affectedEntity(tableSpaces,entitySpaces)) {
      tmpSpaces.addAll(Arrays.asList(entitySpaces));
      if (persister.hasCache()) {
        entityCleanups.add(new EntityCleanup(persister.getCacheAccessStrategy()));
      }
      Set roles=session.getFactory().getCollectionRolesByEntityParticipant(persister.getEntityName());
      if (roles != null) {
        Iterator itr=roles.iterator();
        while (itr.hasNext()) {
          String role=(String)itr.next();
          CollectionPersister collectionPersister=factory.getCollectionPersister(role);
          if (collectionPersister.hasCache()) {
            collectionCleanups.add(new CollectionCleanup(collectionPersister.getCacheAccessStrategy()));
          }
        }
      }
    }
  }
  this.affectedTableSpaces=(Serializable[])tmpSpaces.toArray(new Serializable[tmpSpaces.size()]);
}
