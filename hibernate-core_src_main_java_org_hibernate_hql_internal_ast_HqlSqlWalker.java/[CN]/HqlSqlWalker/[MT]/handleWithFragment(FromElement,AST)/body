{
  try {
    withClause(hqlWithNode);
    AST hqlSqlWithNode=returnAST;
    if (LOG.isDebugEnabled()) {
      LOG.debug("handleWithFragment() : " + getASTPrinter().showAsString(hqlSqlWithNode,"-- with clause --"));
    }
    WithClauseVisitor visitor=new WithClauseVisitor(fromElement,queryTranslatorImpl);
    NodeTraverser traverser=new NodeTraverser(visitor);
    traverser.traverseDepthFirst(hqlSqlWithNode);
    String withClauseJoinAlias=visitor.getJoinAlias();
    if (withClauseJoinAlias == null) {
      withClauseJoinAlias=fromElement.getCollectionTableAlias();
    }
 else {
      FromElement referencedFromElement=visitor.getReferencedFromElement();
      if (referencedFromElement != fromElement) {
        LOG.warnf("with-clause expressions do not reference the from-clause element to which the " + "with-clause was associated.  The query may not work as expected [%s]",queryTranslatorImpl.getQueryString());
      }
    }
    SqlGenerator sql=new SqlGenerator(getSessionFactoryHelper().getFactory());
    sql.whereExpr(hqlSqlWithNode.getFirstChild());
    fromElement.setWithClauseFragment(withClauseJoinAlias,"(" + sql.getSQL() + ")");
  }
 catch (  SemanticException e) {
    throw e;
  }
catch (  InvalidWithClauseException e) {
    throw e;
  }
catch (  Exception e) {
    throw new SemanticException(e.getMessage());
  }
}
