{
  if (compiled) {
    LOG.debug("compile() : The query is already compiled, skipping...");
    return;
  }
  this.tokenReplacements=replacements;
  if (tokenReplacements == null) {
    tokenReplacements=new HashMap();
  }
  this.shallowQuery=shallow;
  try {
    final HqlParser parser=parse(true);
    final HqlSqlWalker w=analyze(parser,collectionRole);
    sqlAst=(Statement)w.getAST();
    if (sqlAst.needsExecutor()) {
      statementExecutor=buildAppropriateStatementExecutor(w);
    }
 else {
      generate((QueryNode)sqlAst);
      queryLoader=new QueryLoader(this,factory,w.getSelectClause());
    }
    compiled=true;
  }
 catch (  QueryException qe) {
    if (qe.getQueryString() == null) {
      throw new QueryException(qe.getMessage(),hql,qe);
    }
 else {
      throw qe;
    }
  }
catch (  RecognitionException e) {
    LOG.trace("Converted antlr.RecognitionException",e);
    throw QuerySyntaxException.convert(e,hql);
  }
catch (  ANTLRException e) {
    LOG.trace("Converted antlr.ANTLRException",e);
    throw new QueryException(e.getMessage(),hql);
  }
  this.enabledFilters=null;
}
