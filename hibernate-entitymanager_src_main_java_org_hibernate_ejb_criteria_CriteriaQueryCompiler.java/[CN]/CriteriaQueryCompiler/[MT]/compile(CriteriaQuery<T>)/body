{
  CriteriaQueryImpl<T> criteriaQueryImpl=(CriteriaQueryImpl<T>)criteriaQuery;
  criteriaQueryImpl.validate();
  final Map<ParameterExpression<?>,String> explicitParameterMapping=new HashMap<ParameterExpression<?>,String>();
  final Map<String,ParameterExpression<?>> explicitParameterNameMapping=new HashMap<String,ParameterExpression<?>>();
  final List<ImplicitParameterBinding> implicitParameterBindings=new ArrayList<ImplicitParameterBinding>();
  final Map<String,Class> implicitParameterTypes=new HashMap<String,Class>();
  RenderingContext renderingContext=new RenderingContext(){
    private int aliasCount=0;
    private int explicitParameterCount=0;
    public String generateAlias(){
      return "generatedAlias" + aliasCount++;
    }
    public String generateParameterName(){
      return "param" + explicitParameterCount++;
    }
    public String registerExplicitParameter(    ParameterExpression<?> criteriaQueryParameter){
      final String jpaqlParameterName;
      if (explicitParameterMapping.containsKey(criteriaQueryParameter)) {
        jpaqlParameterName=explicitParameterMapping.get(criteriaQueryParameter);
      }
 else {
        jpaqlParameterName=generateParameterName();
        explicitParameterMapping.put(criteriaQueryParameter,jpaqlParameterName);
      }
      if (StringHelper.isNotEmpty(criteriaQueryParameter.getName())) {
        explicitParameterNameMapping.put(criteriaQueryParameter.getName(),criteriaQueryParameter);
      }
      return jpaqlParameterName;
    }
    public String registerLiteralParameterBinding(    final Object literal,    final Class javaType){
      final String parameterName=generateParameterName();
      final ImplicitParameterBinding binding=new CriteriaQueryCompiler.ImplicitParameterBinding(){
        public String getParameterName(){
          return parameterName;
        }
        public Class getJavaType(){
          return javaType;
        }
        public void bind(        TypedQuery typedQuery){
          typedQuery.setParameter(parameterName,literal);
        }
      }
;
      implicitParameterBindings.add(binding);
      implicitParameterTypes.put(parameterName,javaType);
      return parameterName;
    }
    public String getCastType(    Class javaType){
      SessionFactoryImplementor factory=(SessionFactoryImplementor)entityManager.getFactory().getSessionFactory();
      Type hibernateType=factory.getTypeResolver().heuristicType(javaType.getName());
      if (hibernateType == null) {
        throw new IllegalArgumentException("Could not convert java type [" + javaType.getName() + "] to Hibernate type");
      }
      int[] sqlTypeCodes=hibernateType.sqlTypes(factory);
      if (sqlTypeCodes.length != 1) {
        throw new IllegalArgumentException("Invalid Hibernate Type [" + hibernateType.getName() + "] for cast : more than one column spanned");
      }
      return factory.getDialect().getCastTypeName(sqlTypeCodes[0]);
    }
  }
;
  final RenderedCriteriaQuery renderedCriteriaQuery=criteriaQueryImpl.render(renderingContext);
  LOG.debugf("Rendered criteria query -> %s",renderedCriteriaQuery.getQueryString());
  TypedQuery<T> jpaqlQuery=entityManager.createQuery(renderedCriteriaQuery.getQueryString(),criteriaQuery.getResultType(),criteriaQuery.getSelection(),new HibernateEntityManagerImplementor.Options(){
    public List<ValueHandlerFactory.ValueHandler> getValueHandlers(){
      return renderedCriteriaQuery.getValueHandlers();
    }
    public Map<String,Class> getNamedParameterExplicitTypes(){
      return implicitParameterTypes;
    }
    public ResultMetadataValidator getResultMetadataValidator(){
      return renderedCriteriaQuery.getResultMetadataValidator();
    }
  }
);
  for (  ImplicitParameterBinding implicitParameterBinding : implicitParameterBindings) {
    implicitParameterBinding.bind(jpaqlQuery);
  }
  return wrap(jpaqlQuery,explicitParameterMapping,explicitParameterNameMapping);
}
