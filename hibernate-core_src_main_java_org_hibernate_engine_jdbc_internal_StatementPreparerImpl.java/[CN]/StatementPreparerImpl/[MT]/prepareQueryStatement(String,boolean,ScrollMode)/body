{
  if (scrollMode != null && !scrollMode.equals(ScrollMode.FORWARD_ONLY)) {
    if (!settings().isScrollableResultSetsEnabled()) {
      throw new AssertionFailure("scrollable result sets are not enabled");
    }
    PreparedStatement ps=new QueryStatementPreparationTemplate(sql){
      public PreparedStatement doPrepare() throws SQLException {
        return isCallable ? connectionProxy().prepareCall(sql,scrollMode.toResultSetType(),ResultSet.CONCUR_READ_ONLY) : connectionProxy().prepareStatement(sql,scrollMode.toResultSetType(),ResultSet.CONCUR_READ_ONLY);
      }
    }
.prepareStatement();
    logicalConnection().getResourceRegistry().registerLastQuery(ps);
    return ps;
  }
 else {
    PreparedStatement ps=new QueryStatementPreparationTemplate(sql){
      public PreparedStatement doPrepare() throws SQLException {
        return isCallable ? connectionProxy().prepareCall(sql) : connectionProxy().prepareStatement(sql);
      }
    }
.prepareStatement();
    logicalConnection().getResourceRegistry().registerLastQuery(ps);
    return ps;
  }
}
