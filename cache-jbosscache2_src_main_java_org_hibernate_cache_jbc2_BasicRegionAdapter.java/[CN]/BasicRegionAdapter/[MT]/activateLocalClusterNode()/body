{
  Transaction tx=suspend();
  try {
    Configuration cfg=jbcCache.getConfiguration();
    if (cfg.isUseRegionBasedMarshalling()) {
      org.jboss.cache.Region jbcRegion=jbcCache.getRegion(regionFqn,true);
      ClassLoader classLoader=Thread.currentThread().getContextClassLoader();
      if (classLoader == null) {
        classLoader=getClass().getClassLoader();
      }
      jbcRegion.registerContextClassLoader(classLoader);
      if (!jbcRegion.isActive()) {
        jbcRegion.activate();
      }
    }
    regionRoot=jbcCache.getRoot().getChild(regionFqn);
    if (regionRoot == null || !regionRoot.isValid()) {
      DataVersion version=optimistic ? NonLockingDataVersion.INSTANCE : null;
      regionRoot=CacheHelper.addNode(jbcCache,regionFqn,true,true,version);
    }
 else     if (optimistic && regionRoot instanceof NodeSPI) {
      if (!(((NodeSPI)regionRoot).getVersion() instanceof NonLockingDataVersion)) {
        ((NodeSPI)regionRoot).setVersion(NonLockingDataVersion.INSTANCE);
      }
    }
    if (!regionRoot.isResident()) {
      regionRoot.setResident(true);
    }
  }
 catch (  Exception e) {
    throw new CacheException(e.getMessage(),e);
  }
 finally {
    if (tx != null)     resume(tx);
  }
}
