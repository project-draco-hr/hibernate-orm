{
  if (entityRegionMap != null) {
    for (    final EntityRegionImpl region : entityRegionMap.values()) {
      Caches.withinTx(region.getTransactionManager(),new Callable<Void>(){
        @Override public Void call() throws Exception {
          region.getCache().withFlags(Flag.CACHE_MODE_LOCAL).clear();
          return null;
        }
      }
);
      region.getCache().stop();
    }
    entityRegionMap.clear();
  }
  if (collectionRegionMap != null) {
    for (    final CollectionRegionImpl collectionRegion : collectionRegionMap.values()) {
      Caches.withinTx(collectionRegion.getTransactionManager(),new Callable<Void>(){
        @Override public Void call() throws Exception {
          collectionRegion.getCache().withFlags(Flag.CACHE_MODE_LOCAL).clear();
          return null;
        }
      }
);
      collectionRegion.getCache().stop();
    }
    collectionRegionMap.clear();
  }
  if (regionFactory != null) {
    regionFactory.stop();
  }
  if (serviceRegistry != null) {
    serviceRegistry.destroy();
  }
}
