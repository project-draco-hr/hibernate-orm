{
  LOG.trace("Transaction before completion callback");
  boolean flush;
  try {
    flush=beforeCompletionManagedFlushChecker.shouldDoManagedFlush(ctx,jtaTransaction);
  }
 catch (  SystemException se) {
    setRollbackOnly();
    throw exceptionMapper.mapStatusCheckFailure("could not determine transaction status in beforeCompletion()",se);
  }
  try {
    if (flush) {
      LOG.trace("Automatically flushing session");
      ctx.managedFlush();
    }
  }
 catch (  RuntimeException re) {
    setRollbackOnly();
    throw exceptionMapper.mapManagedFlushFailure("error during managed flush",re);
  }
 finally {
    jdbcContext.beforeTransactionCompletion(hibernateTransaction);
  }
}
