{
  final JdbcServices jdbcServices=serviceRegistry.getService(JdbcServices.class);
  Settings settings=new Settings();
  String sessionFactoryName=props.getProperty(Environment.SESSION_FACTORY_NAME);
  settings.setSessionFactoryName(sessionFactoryName);
  ExtractedDatabaseMetaData meta=jdbcServices.getExtractedMetaDataSupport();
  settings.setDataDefinitionImplicitCommit(meta.doesDataDefinitionCauseTransactionCommit());
  settings.setDataDefinitionInTransactionSupported(meta.supportsDataDefinitionInTransaction());
  final Properties properties=new Properties();
  properties.putAll(jdbcServices.getDialect().getDefaultProperties());
  properties.putAll(props);
  settings.setJdbcSupport(new JdbcSupport(!ConfigurationHelper.getBoolean(Environment.NON_CONTEXTUAL_LOB_CREATION,properties)));
  settings.setJtaPlatform(serviceRegistry.getService(JtaPlatform.class));
  boolean flushBeforeCompletion=ConfigurationHelper.getBoolean(Environment.FLUSH_BEFORE_COMPLETION,properties);
  log.info("Automatic flush during beforeCompletion(): " + enabledDisabled(flushBeforeCompletion));
  settings.setFlushBeforeCompletionEnabled(flushBeforeCompletion);
  boolean autoCloseSession=ConfigurationHelper.getBoolean(Environment.AUTO_CLOSE_SESSION,properties);
  log.info("Automatic session close at end of transaction: " + enabledDisabled(autoCloseSession));
  settings.setAutoCloseSessionEnabled(autoCloseSession);
  int batchSize=ConfigurationHelper.getInt(Environment.STATEMENT_BATCH_SIZE,properties,0);
  if (!meta.supportsBatchUpdates())   batchSize=0;
  if (batchSize > 0)   log.info("JDBC batch size: " + batchSize);
  settings.setJdbcBatchSize(batchSize);
  boolean jdbcBatchVersionedData=ConfigurationHelper.getBoolean(Environment.BATCH_VERSIONED_DATA,properties,false);
  if (batchSize > 0)   log.info("JDBC batch updates for versioned data: " + enabledDisabled(jdbcBatchVersionedData));
  settings.setJdbcBatchVersionedData(jdbcBatchVersionedData);
  boolean useScrollableResultSets=ConfigurationHelper.getBoolean(Environment.USE_SCROLLABLE_RESULTSET,properties,meta.supportsScrollableResults());
  log.info("Scrollable result sets: " + enabledDisabled(useScrollableResultSets));
  settings.setScrollableResultSetsEnabled(useScrollableResultSets);
  boolean wrapResultSets=ConfigurationHelper.getBoolean(Environment.WRAP_RESULT_SETS,properties,false);
  log.debug("Wrap result sets: " + enabledDisabled(wrapResultSets));
  settings.setWrapResultSetsEnabled(wrapResultSets);
  boolean useGetGeneratedKeys=ConfigurationHelper.getBoolean(Environment.USE_GET_GENERATED_KEYS,properties,meta.supportsGetGeneratedKeys());
  log.info("JDBC3 getGeneratedKeys(): " + enabledDisabled(useGetGeneratedKeys));
  settings.setGetGeneratedKeysEnabled(useGetGeneratedKeys);
  Integer statementFetchSize=ConfigurationHelper.getInteger(Environment.STATEMENT_FETCH_SIZE,properties);
  if (statementFetchSize != null)   log.info("JDBC result set fetch size: " + statementFetchSize);
  settings.setJdbcFetchSize(statementFetchSize);
  String releaseModeName=ConfigurationHelper.getString(Environment.RELEASE_CONNECTIONS,properties,"auto");
  log.info("Connection release mode: " + releaseModeName);
  ConnectionReleaseMode releaseMode;
  if ("auto".equals(releaseModeName)) {
    releaseMode=serviceRegistry.getService(TransactionFactory.class).getDefaultReleaseMode();
  }
 else {
    releaseMode=ConnectionReleaseMode.parse(releaseModeName);
    if (releaseMode == ConnectionReleaseMode.AFTER_STATEMENT && !jdbcServices.getConnectionProvider().supportsAggressiveRelease()) {
      log.warn("Overriding release mode as connection provider does not support 'after_statement'");
      releaseMode=ConnectionReleaseMode.AFTER_TRANSACTION;
    }
  }
  settings.setConnectionReleaseMode(releaseMode);
  String defaultSchema=properties.getProperty(Environment.DEFAULT_SCHEMA);
  String defaultCatalog=properties.getProperty(Environment.DEFAULT_CATALOG);
  if (defaultSchema != null)   log.info("Default schema: " + defaultSchema);
  if (defaultCatalog != null)   log.info("Default catalog: " + defaultCatalog);
  settings.setDefaultSchemaName(defaultSchema);
  settings.setDefaultCatalogName(defaultCatalog);
  Integer maxFetchDepth=ConfigurationHelper.getInteger(Environment.MAX_FETCH_DEPTH,properties);
  if (maxFetchDepth != null)   log.info("Maximum outer join fetch depth: " + maxFetchDepth);
  settings.setMaximumFetchDepth(maxFetchDepth);
  int batchFetchSize=ConfigurationHelper.getInt(Environment.DEFAULT_BATCH_FETCH_SIZE,properties,1);
  log.info("Default batch fetch size: " + batchFetchSize);
  settings.setDefaultBatchFetchSize(batchFetchSize);
  boolean comments=ConfigurationHelper.getBoolean(Environment.USE_SQL_COMMENTS,properties);
  log.info("Generate SQL with comments: " + enabledDisabled(comments));
  settings.setCommentsEnabled(comments);
  boolean orderUpdates=ConfigurationHelper.getBoolean(Environment.ORDER_UPDATES,properties);
  log.info("Order SQL updates by primary key: " + enabledDisabled(orderUpdates));
  settings.setOrderUpdatesEnabled(orderUpdates);
  boolean orderInserts=ConfigurationHelper.getBoolean(Environment.ORDER_INSERTS,properties);
  log.info("Order SQL inserts for batching: " + enabledDisabled(orderInserts));
  settings.setOrderInsertsEnabled(orderInserts);
  settings.setQueryTranslatorFactory(createQueryTranslatorFactory(properties));
  Map querySubstitutions=ConfigurationHelper.toMap(Environment.QUERY_SUBSTITUTIONS," ,=;:\n\t\r\f",properties);
  log.info("Query language substitutions: " + querySubstitutions);
  settings.setQuerySubstitutions(querySubstitutions);
  boolean jpaqlCompliance=ConfigurationHelper.getBoolean(Environment.JPAQL_STRICT_COMPLIANCE,properties,false);
  settings.setStrictJPAQLCompliance(jpaqlCompliance);
  log.info("JPA-QL strict compliance: " + enabledDisabled(jpaqlCompliance));
  boolean useSecondLevelCache=ConfigurationHelper.getBoolean(Environment.USE_SECOND_LEVEL_CACHE,properties,true);
  log.info("Second-level cache: " + enabledDisabled(useSecondLevelCache));
  settings.setSecondLevelCacheEnabled(useSecondLevelCache);
  boolean useQueryCache=ConfigurationHelper.getBoolean(Environment.USE_QUERY_CACHE,properties);
  log.info("Query cache: " + enabledDisabled(useQueryCache));
  settings.setQueryCacheEnabled(useQueryCache);
  settings.setRegionFactory(createRegionFactory(properties,(useSecondLevelCache || useQueryCache)));
  boolean useMinimalPuts=ConfigurationHelper.getBoolean(Environment.USE_MINIMAL_PUTS,properties,settings.getRegionFactory().isMinimalPutsEnabledByDefault());
  log.info("Optimize cache for minimal puts: " + enabledDisabled(useMinimalPuts));
  settings.setMinimalPutsEnabled(useMinimalPuts);
  String prefix=properties.getProperty(Environment.CACHE_REGION_PREFIX);
  if (StringHelper.isEmpty(prefix))   prefix=null;
  if (prefix != null)   log.info("Cache region prefix: " + prefix);
  settings.setCacheRegionPrefix(prefix);
  boolean useStructuredCacheEntries=ConfigurationHelper.getBoolean(Environment.USE_STRUCTURED_CACHE,properties,false);
  log.info("Structured second-level cache entries: " + enabledDisabled(useStructuredCacheEntries));
  settings.setStructuredCacheEntriesEnabled(useStructuredCacheEntries);
  if (useQueryCache)   settings.setQueryCacheFactory(createQueryCacheFactory(properties));
  boolean useStatistics=ConfigurationHelper.getBoolean(Environment.GENERATE_STATISTICS,properties);
  log.info("Statistics: " + enabledDisabled(useStatistics));
  settings.setStatisticsEnabled(useStatistics);
  boolean useIdentifierRollback=ConfigurationHelper.getBoolean(Environment.USE_IDENTIFIER_ROLLBACK,properties);
  log.info("Deleted entity synthetic identifier rollback: " + enabledDisabled(useIdentifierRollback));
  settings.setIdentifierRollbackEnabled(useIdentifierRollback);
  String autoSchemaExport=properties.getProperty(Environment.HBM2DDL_AUTO);
  if ("validate".equals(autoSchemaExport))   settings.setAutoValidateSchema(true);
  if ("update".equals(autoSchemaExport))   settings.setAutoUpdateSchema(true);
  if ("create".equals(autoSchemaExport))   settings.setAutoCreateSchema(true);
  if ("create-drop".equals(autoSchemaExport)) {
    settings.setAutoCreateSchema(true);
    settings.setAutoDropSchema(true);
  }
  settings.setImportFiles(properties.getProperty(Environment.HBM2DDL_IMPORT_FILES));
  EntityMode defaultEntityMode=EntityMode.parse(properties.getProperty(Environment.DEFAULT_ENTITY_MODE));
  log.info("Default entity-mode: " + defaultEntityMode);
  settings.setDefaultEntityMode(defaultEntityMode);
  boolean namedQueryChecking=ConfigurationHelper.getBoolean(Environment.QUERY_STARTUP_CHECKING,properties,true);
  log.info("Named query checking : " + enabledDisabled(namedQueryChecking));
  settings.setNamedQueryStartupCheckingEnabled(namedQueryChecking);
  boolean checkNullability=ConfigurationHelper.getBoolean(Environment.CHECK_NULLABILITY,properties,true);
  log.info("Check Nullability in Core (should be disabled when Bean Validation is on): " + enabledDisabled(checkNullability));
  settings.setCheckNullability(checkNullability);
  return settings;
}
