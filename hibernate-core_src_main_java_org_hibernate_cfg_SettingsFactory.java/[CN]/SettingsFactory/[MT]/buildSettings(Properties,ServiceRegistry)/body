{
  final JdbcServices jdbcServices=serviceRegistry.getService(JdbcServices.class);
  Settings settings=new Settings();
  String sessionFactoryName=props.getProperty(Environment.SESSION_FACTORY_NAME);
  settings.setSessionFactoryName(sessionFactoryName);
  ExtractedDatabaseMetaData meta=jdbcServices.getExtractedMetaDataSupport();
  settings.setDataDefinitionImplicitCommit(meta.doesDataDefinitionCauseTransactionCommit());
  settings.setDataDefinitionInTransactionSupported(meta.supportsDataDefinitionInTransaction());
  final Properties properties=new Properties();
  properties.putAll(jdbcServices.getDialect().getDefaultProperties());
  properties.putAll(props);
  settings.setJtaPlatform(serviceRegistry.getService(JtaPlatform.class));
  boolean flushBeforeCompletion=ConfigurationHelper.getBoolean(Environment.FLUSH_BEFORE_COMPLETION,properties);
  LOG.debugf("Automatic flush during beforeCompletion(): %s",enabledDisabled(flushBeforeCompletion));
  settings.setFlushBeforeCompletionEnabled(flushBeforeCompletion);
  boolean autoCloseSession=ConfigurationHelper.getBoolean(Environment.AUTO_CLOSE_SESSION,properties);
  LOG.debugf("Automatic session close at end of transaction: %s",enabledDisabled(autoCloseSession));
  settings.setAutoCloseSessionEnabled(autoCloseSession);
  int batchSize=ConfigurationHelper.getInt(Environment.STATEMENT_BATCH_SIZE,properties,0);
  if (!meta.supportsBatchUpdates()) {
    batchSize=0;
  }
  if (batchSize > 0) {
    LOG.debugf("JDBC batch size: %s",batchSize);
  }
  settings.setJdbcBatchSize(batchSize);
  boolean jdbcBatchVersionedData=ConfigurationHelper.getBoolean(Environment.BATCH_VERSIONED_DATA,properties,false);
  if (batchSize > 0) {
    LOG.debugf("JDBC batch updates for versioned data: %s",enabledDisabled(jdbcBatchVersionedData));
  }
  settings.setJdbcBatchVersionedData(jdbcBatchVersionedData);
  boolean useScrollableResultSets=ConfigurationHelper.getBoolean(Environment.USE_SCROLLABLE_RESULTSET,properties,meta.supportsScrollableResults());
  LOG.debugf("Scrollable result sets: %s",enabledDisabled(useScrollableResultSets));
  settings.setScrollableResultSetsEnabled(useScrollableResultSets);
  boolean wrapResultSets=ConfigurationHelper.getBoolean(Environment.WRAP_RESULT_SETS,properties,false);
  LOG.debugf("Wrap result sets: %s",enabledDisabled(wrapResultSets));
  settings.setWrapResultSetsEnabled(wrapResultSets);
  boolean useGetGeneratedKeys=ConfigurationHelper.getBoolean(Environment.USE_GET_GENERATED_KEYS,properties,meta.supportsGetGeneratedKeys());
  LOG.debugf("JDBC3 getGeneratedKeys(): %s",enabledDisabled(useGetGeneratedKeys));
  settings.setGetGeneratedKeysEnabled(useGetGeneratedKeys);
  Integer statementFetchSize=ConfigurationHelper.getInteger(Environment.STATEMENT_FETCH_SIZE,properties);
  if (statementFetchSize != null) {
    LOG.debugf("JDBC result set fetch size: %s",statementFetchSize);
  }
  settings.setJdbcFetchSize(statementFetchSize);
  String releaseModeName=ConfigurationHelper.getString(Environment.RELEASE_CONNECTIONS,properties,"auto");
  LOG.debugf("Connection release mode: %s",releaseModeName);
  ConnectionReleaseMode releaseMode;
  if ("auto".equals(releaseModeName)) {
    releaseMode=serviceRegistry.getService(TransactionFactory.class).getDefaultReleaseMode();
  }
 else {
    releaseMode=ConnectionReleaseMode.parse(releaseModeName);
    if (releaseMode == ConnectionReleaseMode.AFTER_STATEMENT && !jdbcServices.getConnectionProvider().supportsAggressiveRelease()) {
      LOG.unsupportedAfterStatement();
      releaseMode=ConnectionReleaseMode.AFTER_TRANSACTION;
    }
  }
  settings.setConnectionReleaseMode(releaseMode);
  String defaultSchema=properties.getProperty(Environment.DEFAULT_SCHEMA);
  String defaultCatalog=properties.getProperty(Environment.DEFAULT_CATALOG);
  if (defaultSchema != null) {
    LOG.debugf("Default schema: %s",defaultSchema);
  }
  if (defaultCatalog != null) {
    LOG.debugf("Default catalog: %s",defaultCatalog);
  }
  settings.setDefaultSchemaName(defaultSchema);
  settings.setDefaultCatalogName(defaultCatalog);
  Integer maxFetchDepth=ConfigurationHelper.getInteger(Environment.MAX_FETCH_DEPTH,properties);
  if (maxFetchDepth != null) {
    LOG.debugf("Maximum outer join fetch depth: %s",maxFetchDepth);
  }
  settings.setMaximumFetchDepth(maxFetchDepth);
  int batchFetchSize=ConfigurationHelper.getInt(Environment.DEFAULT_BATCH_FETCH_SIZE,properties,1);
  LOG.debugf("Default batch fetch size: %s",batchFetchSize);
  settings.setDefaultBatchFetchSize(batchFetchSize);
  boolean comments=ConfigurationHelper.getBoolean(Environment.USE_SQL_COMMENTS,properties);
  LOG.debugf("Generate SQL with comments: %s",enabledDisabled(comments));
  settings.setCommentsEnabled(comments);
  boolean orderUpdates=ConfigurationHelper.getBoolean(Environment.ORDER_UPDATES,properties);
  LOG.debugf("Order SQL updates by primary key: %s",enabledDisabled(orderUpdates));
  settings.setOrderUpdatesEnabled(orderUpdates);
  boolean orderInserts=ConfigurationHelper.getBoolean(Environment.ORDER_INSERTS,properties);
  LOG.debugf("Order SQL inserts for batching: %s",enabledDisabled(orderInserts));
  settings.setOrderInsertsEnabled(orderInserts);
  settings.setQueryTranslatorFactory(createQueryTranslatorFactory(properties,serviceRegistry));
  Map querySubstitutions=ConfigurationHelper.toMap(Environment.QUERY_SUBSTITUTIONS," ,=;:\n\t\r\f",properties);
  LOG.debugf("Query language substitutions: %s",querySubstitutions);
  settings.setQuerySubstitutions(querySubstitutions);
  boolean jpaqlCompliance=ConfigurationHelper.getBoolean(Environment.JPAQL_STRICT_COMPLIANCE,properties,false);
  LOG.debugf("JPA-QL strict compliance: %s",enabledDisabled(jpaqlCompliance));
  settings.setStrictJPAQLCompliance(jpaqlCompliance);
  boolean useSecondLevelCache=ConfigurationHelper.getBoolean(Environment.USE_SECOND_LEVEL_CACHE,properties,true);
  LOG.debugf("Second-level cache: %s",enabledDisabled(useSecondLevelCache));
  settings.setSecondLevelCacheEnabled(useSecondLevelCache);
  boolean useQueryCache=ConfigurationHelper.getBoolean(Environment.USE_QUERY_CACHE,properties);
  LOG.debugf("Query cache: %s",enabledDisabled(useQueryCache));
  settings.setQueryCacheEnabled(useQueryCache);
  if (useQueryCache) {
    settings.setQueryCacheFactory(createQueryCacheFactory(properties,serviceRegistry));
  }
  settings.setRegionFactory(createRegionFactory(properties,(useSecondLevelCache || useQueryCache),serviceRegistry));
  boolean useMinimalPuts=ConfigurationHelper.getBoolean(Environment.USE_MINIMAL_PUTS,properties,settings.getRegionFactory().isMinimalPutsEnabledByDefault());
  LOG.debugf("Optimize cache for minimal puts: %s",enabledDisabled(useMinimalPuts));
  settings.setMinimalPutsEnabled(useMinimalPuts);
  String prefix=properties.getProperty(Environment.CACHE_REGION_PREFIX);
  if (StringHelper.isEmpty(prefix)) {
    prefix=null;
  }
  if (prefix != null) {
    LOG.debugf("Cache region prefix: %s",prefix);
  }
  settings.setCacheRegionPrefix(prefix);
  boolean useStructuredCacheEntries=ConfigurationHelper.getBoolean(Environment.USE_STRUCTURED_CACHE,properties,false);
  LOG.debugf("Structured second-level cache entries: %s",enabledDisabled(useStructuredCacheEntries));
  settings.setStructuredCacheEntriesEnabled(useStructuredCacheEntries);
  boolean useStatistics=ConfigurationHelper.getBoolean(Environment.GENERATE_STATISTICS,properties);
  LOG.debugf("Statistics: %s",enabledDisabled(useStatistics));
  settings.setStatisticsEnabled(useStatistics);
  boolean useIdentifierRollback=ConfigurationHelper.getBoolean(Environment.USE_IDENTIFIER_ROLLBACK,properties);
  LOG.debugf("Deleted entity synthetic identifier rollback: %s",enabledDisabled(useIdentifierRollback));
  settings.setIdentifierRollbackEnabled(useIdentifierRollback);
  String autoSchemaExport=properties.getProperty(Environment.HBM2DDL_AUTO);
  if ("validate".equals(autoSchemaExport)) {
    settings.setAutoValidateSchema(true);
  }
  if ("update".equals(autoSchemaExport)) {
    settings.setAutoUpdateSchema(true);
  }
  if ("create".equals(autoSchemaExport)) {
    settings.setAutoCreateSchema(true);
  }
  if ("create-drop".equals(autoSchemaExport)) {
    settings.setAutoCreateSchema(true);
    settings.setAutoDropSchema(true);
  }
  settings.setImportFiles(properties.getProperty(Environment.HBM2DDL_IMPORT_FILES));
  EntityMode defaultEntityMode=EntityMode.parse(properties.getProperty(Environment.DEFAULT_ENTITY_MODE));
  LOG.debugf("Default entity-mode: %s",defaultEntityMode);
  settings.setDefaultEntityMode(defaultEntityMode);
  boolean namedQueryChecking=ConfigurationHelper.getBoolean(Environment.QUERY_STARTUP_CHECKING,properties,true);
  LOG.debugf("Named query checking : %s",enabledDisabled(namedQueryChecking));
  settings.setNamedQueryStartupCheckingEnabled(namedQueryChecking);
  boolean checkNullability=ConfigurationHelper.getBoolean(Environment.CHECK_NULLABILITY,properties,true);
  LOG.debugf("Check Nullability in Core (should be disabled when Bean Validation is on): %s",enabledDisabled(checkNullability));
  settings.setCheckNullability(checkNullability);
  MultiTenancyStrategy multiTenancyStrategy=MultiTenancyStrategy.determineMultiTenancyStrategy(properties);
  LOG.debugf("multi-tenancy strategy : %s",multiTenancyStrategy);
  settings.setMultiTenancyStrategy(multiTenancyStrategy);
  return settings;
}
