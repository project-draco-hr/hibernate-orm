{
  if (parent != null) {
    throw attemptedDereference();
  }
  final FromReferenceNode mapReference=getMapReference();
  mapReference.resolve(true,true);
  FromElement sourceFromElement=null;
  if (isAliasRef(mapReference)) {
    final QueryableCollection collectionPersister=mapReference.getFromElement().getQueryableCollection();
    if (Map.class.isAssignableFrom(collectionPersister.getCollectionType().getReturnedClass())) {
      sourceFromElement=mapReference.getFromElement();
    }
  }
 else {
    if (mapReference.getDataType().isCollectionType()) {
      final CollectionType collectionType=(CollectionType)mapReference.getDataType();
      if (Map.class.isAssignableFrom(collectionType.getReturnedClass())) {
        sourceFromElement=mapReference.getFromElement();
      }
    }
  }
  if (sourceFromElement == null) {
    throw nonMap();
  }
  mapFromElement=sourceFromElement;
  setFromElement(sourceFromElement);
  setDataType(resolveType(sourceFromElement.getQueryableCollection()));
  this.columns=resolveColumns(sourceFromElement.getQueryableCollection());
  initText(this.columns);
  setFirstChild(null);
}
