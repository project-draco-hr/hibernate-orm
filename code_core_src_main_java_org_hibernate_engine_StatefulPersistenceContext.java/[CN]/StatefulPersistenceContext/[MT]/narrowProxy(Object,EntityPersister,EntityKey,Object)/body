{
  boolean alreadyNarrow=persister.getConcreteProxyClass(session.getEntityMode()).isAssignableFrom(proxy.getClass());
  if (!alreadyNarrow) {
    if (PROXY_WARN_LOG.isWarnEnabled()) {
      PROXY_WARN_LOG.warn("Narrowing proxy to " + persister.getConcreteProxyClass(session.getEntityMode()) + " - this operation breaks ==");
    }
    if (object != null) {
      proxiesByKey.remove(key);
      return object;
    }
 else {
      proxy=persister.createProxy(key.getIdentifier(),session);
      proxiesByKey.put(key,proxy);
      return proxy;
    }
  }
 else {
    if (object != null) {
      LazyInitializer li=((HibernateProxy)proxy).getHibernateLazyInitializer();
      li.setImplementation(object);
    }
    return proxy;
  }
}
