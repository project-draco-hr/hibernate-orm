{
  Configuration cfg=new Configuration();
  for (  String file : FILES) {
    cfg.addResource("org/hibernate/test/" + file);
  }
  cfg.addAnnotatedClass(Serial.class);
  byte[] bytes=SerializationHelper.serialize(cfg);
  cfg=(Configuration)SerializationHelper.deserialize(bytes);
  SessionFactory factory=null;
  ServiceRegistryHolder serviceRegistryHolder=null;
  try {
    serviceRegistryHolder=new ServiceRegistryHolder(cfg.getProperties());
    factory=cfg.buildSessionFactory(serviceRegistryHolder.getServiceRegistry());
  }
  finally {
    if (factory != null) {
      factory.close();
    }
    if (serviceRegistryHolder != null) {
      serviceRegistryHolder.destroy();
    }
  }
}
