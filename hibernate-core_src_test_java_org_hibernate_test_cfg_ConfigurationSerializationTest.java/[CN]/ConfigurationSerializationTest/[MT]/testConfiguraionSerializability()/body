{
  Configuration cfg=new Configuration();
  for (  String file : FILES) {
    cfg.addResource("org/hibernate/test/" + file);
  }
  cfg.addAnnotatedClass(Serial.class);
  byte[] bytes=SerializationHelper.serialize(cfg);
  cfg=(Configuration)SerializationHelper.deserialize(bytes);
  SessionFactory factory=null;
  ServiceRegistry serviceRegistry=null;
  try {
    serviceRegistry=ServiceRegistryBuilder.buildServiceRegistry(cfg.getProperties());
    factory=cfg.buildSessionFactory(serviceRegistry);
  }
  finally {
    if (factory != null) {
      factory.close();
    }
    if (serviceRegistry != null) {
      ServiceRegistryBuilder.destroy(serviceRegistry);
    }
  }
}
