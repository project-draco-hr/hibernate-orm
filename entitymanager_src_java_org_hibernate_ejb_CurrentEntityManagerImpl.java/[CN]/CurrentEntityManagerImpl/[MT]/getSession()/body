{
  Session s;
  SessionFactoryImplementor sfi=(SessionFactoryImplementor)sessionFactory;
  if (!JTAHelper.isTransactionInProgress(sfi)) {
    s=sfi.openTemporarySession();
    ((SessionImplementor)s).setAutoClear(true);
  }
 else {
    s=sessionFactory.getCurrentSession();
  }
  return s;
}
