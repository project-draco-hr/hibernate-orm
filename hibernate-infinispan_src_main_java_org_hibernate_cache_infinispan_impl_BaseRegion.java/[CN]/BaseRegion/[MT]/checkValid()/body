{
  boolean valid=isValid();
  if (!valid) {
synchronized (invalidationMutex) {
      if (invalidateState.compareAndSet(InvalidateState.INVALID,InvalidateState.CLEARING)) {
        try {
          Transaction tx=getCurrentTransaction();
          if (tx != null) {
            log.tracef("Transaction, clearing one element at the time");
            Caches.removeAll(regionClearCache);
          }
 else {
            log.tracef("Non-transactional, clear in one go");
            regionClearCache.clear();
          }
          log.tracef("Transition state from CLEARING to VALID");
          invalidateState.compareAndSet(InvalidateState.CLEARING,InvalidateState.VALID);
        }
 catch (        Exception e) {
          if (log.isTraceEnabled()) {
            log.trace("Could not invalidate region: ",e);
          }
        }
      }
    }
    valid=isValid();
  }
  return valid;
}
