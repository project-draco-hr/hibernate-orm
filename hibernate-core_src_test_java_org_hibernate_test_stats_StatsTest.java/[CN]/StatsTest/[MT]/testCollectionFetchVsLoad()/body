{
  SessionFactory sf=buildBaseConfiguration().setProperty(AvailableSettings.HBM2DDL_AUTO,"create").buildSessionFactory();
  Session s=sf.openSession();
  Transaction tx=s.beginTransaction();
  Continent europe=fillDb(s);
  tx.commit();
  s.close();
  s=sf.openSession();
  tx=s.beginTransaction();
  assertEquals(0,sf.getStatistics().getCollectionLoadCount());
  assertEquals(0,sf.getStatistics().getCollectionFetchCount());
  Continent europe2=(Continent)s.get(Continent.class,europe.getId());
  assertEquals("Lazy true: no collection should be loaded",0,sf.getStatistics().getCollectionLoadCount());
  assertEquals(0,sf.getStatistics().getCollectionFetchCount());
  europe2.getCountries().size();
  assertEquals(1,sf.getStatistics().getCollectionLoadCount());
  assertEquals("Explicit fetch of the collection state",1,sf.getStatistics().getCollectionFetchCount());
  tx.commit();
  s.close();
  sf.getStatistics().clear();
  s=sf.openSession();
  tx=s.beginTransaction();
  europe=fillDb(s);
  tx.commit();
  s.clear();
  tx=s.beginTransaction();
  assertEquals(0,sf.getStatistics().getCollectionLoadCount());
  assertEquals(0,sf.getStatistics().getCollectionFetchCount());
  europe2=(Continent)s.createQuery("from " + Continent.class.getName() + " a join fetch a.countries where a.id = "+ europe.getId()).uniqueResult();
  assertEquals(1,sf.getStatistics().getCollectionLoadCount());
  assertEquals("collection should be loaded in the same query as its parent",0,sf.getStatistics().getCollectionFetchCount());
  tx.commit();
  s.close();
  sf.close();
  Configuration cfg=buildBaseConfiguration();
  cfg.buildMappings();
  Collection coll=cfg.getCollectionMapping(Continent.class.getName() + ".countries");
  coll.setFetchMode(FetchMode.JOIN);
  coll.setLazy(false);
  sf=cfg.buildSessionFactory();
  s=sf.openSession();
  tx=s.beginTransaction();
  europe=fillDb(s);
  tx.commit();
  s.close();
  s=sf.openSession();
  tx=s.beginTransaction();
  assertEquals(0,sf.getStatistics().getCollectionLoadCount());
  assertEquals(0,sf.getStatistics().getCollectionFetchCount());
  europe2=(Continent)s.get(Continent.class,europe.getId());
  assertEquals(1,sf.getStatistics().getCollectionLoadCount());
  assertEquals("Should do direct load, not indirect second load when lazy false and JOIN",0,sf.getStatistics().getCollectionFetchCount());
  tx.commit();
  s.close();
  sf.close();
  sf.close();
  cfg=buildBaseConfiguration();
  cfg.buildMappings();
  coll=cfg.getCollectionMapping(Continent.class.getName() + ".countries");
  coll.setFetchMode(FetchMode.SELECT);
  coll.setLazy(false);
  sf=cfg.buildSessionFactory();
  s=sf.openSession();
  tx=s.beginTransaction();
  europe=fillDb(s);
  tx.commit();
  s.close();
  s=sf.openSession();
  tx=s.beginTransaction();
  assertEquals(0,sf.getStatistics().getCollectionLoadCount());
  assertEquals(0,sf.getStatistics().getCollectionFetchCount());
  europe2=(Continent)s.get(Continent.class,europe.getId());
  assertEquals(1,sf.getStatistics().getCollectionLoadCount());
  assertEquals("Should do explicit collection load, not part of the first one",1,sf.getStatistics().getCollectionFetchCount());
  for (  Object o : europe2.getCountries()) {
    s.delete(o);
  }
  cleanDb(s);
  tx.commit();
  s.close();
  sf.close();
}
