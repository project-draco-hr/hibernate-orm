{
  if (currentElements.size() == 0) {
    return oldElements;
  }
  if (oldElements.size() == 0) {
    return oldElements;
  }
  final EntityPersister entityPersister=session.getFactory().getEntityPersister(entityName);
  final Type idType=entityPersister.getIdentifierType();
  final Collection res=new ArrayList();
  final java.util.Set currentIds=new HashSet();
  final java.util.Set currentSaving=new IdentitySet();
  for (  Object current : currentElements) {
    if (current != null && ForeignKeys.isNotTransient(entityName,current,null,session)) {
      final EntityEntry ee=session.getPersistenceContext().getEntry(current);
      if (ee != null && ee.getStatus() == Status.SAVING) {
        currentSaving.add(current);
      }
 else {
        final Serializable currentId=ForeignKeys.getEntityIdentifierIfNotUnsaved(entityName,current,session);
        currentIds.add(new TypedValue(idType,currentId));
      }
    }
  }
  for (  Object old : oldElements) {
    if (!currentSaving.contains(old)) {
      final Serializable oldId=ForeignKeys.getEntityIdentifierIfNotUnsaved(entityName,old,session);
      if (!currentIds.contains(new TypedValue(idType,oldId))) {
        res.add(old);
      }
    }
  }
  return res;
}
