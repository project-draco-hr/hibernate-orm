{
  LOG.trace("Flushing session");
  EventSource session=event.getSession();
  final PersistenceContext persistenceContext=session.getPersistenceContext();
  session.getInterceptor().preFlush(new LazyIterator(persistenceContext.getEntitiesByKey()));
  prepareEntityFlushes(session);
  prepareCollectionFlushes(session);
  persistenceContext.setFlushing(true);
  try {
    flushEntities(event);
    flushCollections(session);
  }
  finally {
    persistenceContext.setFlushing(false);
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Flushed: " + session.getActionQueue().numberOfInsertions() + " insertions, "+ session.getActionQueue().numberOfUpdates()+ " updates, "+ session.getActionQueue().numberOfDeletions()+ " deletions to "+ persistenceContext.getEntityEntries().size()+ " objects");
    LOG.debug("Flushed: " + session.getActionQueue().numberOfCollectionCreations() + " (re)creations, "+ session.getActionQueue().numberOfCollectionUpdates()+ " updates, "+ session.getActionQueue().numberOfCollectionRemovals()+ " removals to "+ persistenceContext.getCollectionEntries().size()+ " collections");
    new Printer(session.getFactory()).toString(persistenceContext.getEntitiesByKey().values().iterator(),session.getEntityMode());
  }
}
