{
  LOG.flushingSession();
  EventSource session=event.getSession();
  final PersistenceContext persistenceContext=session.getPersistenceContext();
  session.getInterceptor().preFlush(new LazyIterator(persistenceContext.getEntitiesByKey()));
  prepareEntityFlushes(session);
  prepareCollectionFlushes(session);
  persistenceContext.setFlushing(true);
  try {
    flushEntities(event);
    flushCollections(session);
  }
  finally {
    persistenceContext.setFlushing(false);
  }
  if (LOG.isDebugEnabled()) {
    LOG.flushedEntities(session.getActionQueue().numberOfInsertions(),session.getActionQueue().numberOfUpdates(),session.getActionQueue().numberOfDeletions(),persistenceContext.getEntityEntries().size());
    LOG.flushedCollections(session.getActionQueue().numberOfCollectionCreations(),session.getActionQueue().numberOfCollectionUpdates(),session.getActionQueue().numberOfCollectionRemovals(),persistenceContext.getCollectionEntries().size());
    new Printer(session.getFactory()).toString(persistenceContext.getEntitiesByKey().values().iterator(),session.getEntityMode());
  }
}
