{
  TransactionManager tm=factory.getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager();
  try {
    return tm != null && isTransactionInProgress(tm.getTransaction());
  }
 catch (  SystemException se) {
    throw new TransactionException("could not obtain JTA Transaction",se);
  }
}
