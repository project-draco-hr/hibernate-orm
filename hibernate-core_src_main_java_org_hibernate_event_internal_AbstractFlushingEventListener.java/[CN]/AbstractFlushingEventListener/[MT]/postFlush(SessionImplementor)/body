{
  LOG.trace("Post flush");
  final PersistenceContext persistenceContext=session.getPersistenceContext();
  persistenceContext.getCollectionsByKey().clear();
  persistenceContext.getBatchFetchQueue().clearSubselects();
  for (  Map.Entry<PersistentCollection,CollectionEntry> me : IdentityMap.concurrentEntries(persistenceContext.getCollectionEntries())) {
    CollectionEntry collectionEntry=me.getValue();
    PersistentCollection persistentCollection=me.getKey();
    collectionEntry.postFlush(persistentCollection);
    if (collectionEntry.getLoadedPersister() == null) {
      persistenceContext.getCollectionEntries().remove(persistentCollection);
    }
 else {
      CollectionKey collectionKey=new CollectionKey(collectionEntry.getLoadedPersister(),collectionEntry.getLoadedKey());
      persistenceContext.getCollectionsByKey().put(collectionKey,persistentCollection);
    }
  }
  session.getInterceptor().postFlush(new LazyIterator(persistenceContext.getEntitiesByKey()));
}
