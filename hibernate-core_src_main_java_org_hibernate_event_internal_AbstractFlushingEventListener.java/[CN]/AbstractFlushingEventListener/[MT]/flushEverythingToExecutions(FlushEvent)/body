{
  LOG.trace("Flushing session");
  EventSource session=event.getSession();
  final PersistenceContext persistenceContext=session.getPersistenceContext();
  session.getInterceptor().preFlush(new LazyIterator(persistenceContext.getEntitiesByKey()));
  prepareEntityFlushes(session,persistenceContext);
  prepareCollectionFlushes(persistenceContext);
  persistenceContext.setFlushing(true);
  try {
    int entityCount=flushEntities(event,persistenceContext);
    int collectionCount=flushCollections(session,persistenceContext);
    event.setNumberOfEntitiesProcessed(entityCount);
    event.setNumberOfCollectionsProcessed(collectionCount);
  }
  finally {
    persistenceContext.setFlushing(false);
  }
  logFlushResults(event);
}
