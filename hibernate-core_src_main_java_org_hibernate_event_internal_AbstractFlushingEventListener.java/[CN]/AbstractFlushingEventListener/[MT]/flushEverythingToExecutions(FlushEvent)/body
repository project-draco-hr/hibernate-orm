{
  LOG.trace("Flushing session");
  EventSource session=event.getSession();
  final PersistenceContext persistenceContext=session.getPersistenceContext();
  session.getInterceptor().preFlush(new LazyIterator(persistenceContext.getEntitiesByKey()));
  prepareEntityFlushes(session);
  prepareCollectionFlushes(session);
  persistenceContext.setFlushing(true);
  try {
    flushEntities(event);
    flushCollections(session);
  }
  finally {
    persistenceContext.setFlushing(false);
  }
  if (LOG.isDebugEnabled()) {
    LOG.debugf("Flushed: %s insertions, %s updates, %s deletions to %s objects",session.getActionQueue().numberOfInsertions(),session.getActionQueue().numberOfUpdates(),session.getActionQueue().numberOfDeletions(),persistenceContext.getEntityEntries().size());
    LOG.debugf("Flushed: %s (re)creations, %s updates, %s removals to %s collections",session.getActionQueue().numberOfCollectionCreations(),session.getActionQueue().numberOfCollectionUpdates(),session.getActionQueue().numberOfCollectionRemovals(),persistenceContext.getCollectionEntries().size());
    new Printer(session.getFactory()).toString(persistenceContext.getEntitiesByKey().values().iterator());
  }
}
