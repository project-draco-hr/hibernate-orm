{
  LOG.trace("Flushing session");
  EventSource session=event.getSession();
  final PersistenceContext persistenceContext=session.getPersistenceContext();
  session.getInterceptor().preFlush(new LazyIterator(persistenceContext.getEntitiesByKey()));
  prepareEntityFlushes(session);
  prepareCollectionFlushes(session);
  persistenceContext.setFlushing(true);
  try {
    flushEntities(event);
    flushCollections(session);
  }
  finally {
    persistenceContext.setFlushing(false);
  }
  logFlushResults(event);
}
