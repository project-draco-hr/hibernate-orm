{
  if (workUnits.size() == 0 && undoQueue.size() == 0) {
    return;
  }
  if (!session.getTransactionCoordinator().isActive()) {
    log.debug("Skipping envers transaction hook due to non-active (most likely marked-rollback-only) transaction");
    return;
  }
  if (FlushModeType.COMMIT.equals(session.getFlushMode())) {
    Session temporarySession=null;
    try {
      temporarySession=session.sessionWithOptions().connection().autoClose(false).connectionHandlingMode(PhysicalConnectionHandlingMode.DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION).openSession();
      executeInSession(temporarySession);
      temporarySession.flush();
    }
  finally {
      if (temporarySession != null) {
        temporarySession.close();
      }
    }
  }
 else {
    executeInSession(session);
    session.flush();
  }
}
