{
  if (workUnits.size() == 0 && undoQueue.size() == 0) {
    return;
  }
  if (!session.getTransactionCoordinator().isActive()) {
    log.debug("Skipping envers transaction hook due to non-active (most likely marked-rollback-only) transaction");
    return;
  }
  if (FlushMode.isManualFlushMode(session.getFlushMode())) {
    Session temporarySession=null;
    try {
      temporarySession=((Session)session).sessionWithOptions().transactionContext().autoClose(false).connectionReleaseMode(ConnectionReleaseMode.AFTER_TRANSACTION).openSession();
      executeInSession(temporarySession);
      temporarySession.flush();
    }
  finally {
      if (temporarySession != null) {
        temporarySession.close();
      }
    }
  }
 else {
    executeInSession((Session)session);
    session.flush();
  }
}
