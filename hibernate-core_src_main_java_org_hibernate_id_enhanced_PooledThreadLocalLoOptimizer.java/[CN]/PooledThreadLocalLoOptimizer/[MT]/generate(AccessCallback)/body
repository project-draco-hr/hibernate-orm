{
  GenerationState local=null;
  if (callback.getTenantIdentifier() == null) {
    local=localAssignedIds.get();
  }
 else   if (tenantSpecificState != null) {
    local=tenantSpecificState.get(callback.getTenantIdentifier());
  }
  if (local != null && local.value.lt(local.upperLimitValue)) {
    return local.value.makeValueThenIncrement();
  }
synchronized (this) {
    final GenerationState generationState=locateGenerationState(callback);
    if (callback.getTenantIdentifier() != null) {
      return generationState.value.makeValueThenIncrement();
    }
 else {
      if (local == null) {
        localAssignedIds.set(generationState);
      }
      if (!generationState.value.lt(generationState.upperLimitValue)) {
        generationState.lastSourceValue=callback.getNextValue();
        generationState.upperLimitValue=generationState.lastSourceValue.copy().add(incrementSize);
        generationState.value=generationState.lastSourceValue.copy();
        while (generationState.value.lt(1)) {
          generationState.value.increment();
        }
      }
      return generationState.value.makeValueThenIncrement();
    }
  }
}
