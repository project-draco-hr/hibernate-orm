{
  Session s=openSession().getSession(EntityMode.MAP);
  s.beginTransaction();
  Map map=new HashMap();
  map.put("$type$","TestMap");
  map.put("name","foo");
  map.put("address","bar");
  Map cmp=new HashMap();
  cmp.put("a",new Integer(1));
  cmp.put("b",new Float(1.0));
  map.put("cmp",cmp);
  s.save(map);
  s.getTransaction().commit();
  s.close();
  s=openSession().getSession(EntityMode.MAP);
  s.beginTransaction();
  map=(Map)s.get("TestMap",(Serializable)map.get("id"));
  assertTrue(map != null && "foo".equals(map.get("name")));
  assertTrue(map.get("$type$").equals("TestMap"));
  int size=s.createCriteria("TestMap").add(Example.create(map)).list().size();
  assertTrue(size == 1);
  s.getTransaction().commit();
  s.close();
  s=openSession().getSession(EntityMode.MAP);
  s.beginTransaction();
  List list=s.createQuery("from TestMap").list();
  map=(Map)list.get(0);
  assertTrue("foo".equals(map.get("name")));
  assertTrue("bar".equals(map.get("address")));
  cmp=(Map)map.get("cmp");
  assertTrue(new Integer(1).equals(cmp.get("a")) && new Float(1.0).equals(cmp.get("b")));
  assertTrue(null == map.get("parent"));
  map.put("name","foobar");
  map.put("parent",map);
  List bag=(List)map.get("children");
  bag.add(map);
  s.getTransaction().commit();
  s.close();
  s=openSession();
  s.beginTransaction();
  list=s.createQuery("from TestMap tm where tm.address = 'bar'").list();
  map=(Map)list.get(0);
  assertTrue("foobar".equals(map.get("name")));
  assertTrue("bar".equals(map.get("address")));
  assertTrue(map == map.get("parent"));
  bag=(List)map.get("children");
  assertTrue(bag.size() == 1);
  size=s.createCriteria("TestMap").add(Restrictions.eq("address","bar")).createCriteria("parent").add(Restrictions.eq("name","foobar")).list().size();
  assertTrue(size == 1);
  s.delete(map);
  s.getTransaction().commit();
  s.close();
}
