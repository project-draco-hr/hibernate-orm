{
  Category catWA=new Category();
  catWA.setName("HSQL workaround");
  Category cat=new Category();
  cat.setName("foo");
  Category subCatBar=new Category();
  subCatBar.setName("bar");
  Category subCatBaz=new Category();
  subCatBaz.setName("baz");
  cat.getSubcategories().add(subCatBar);
  cat.getSubcategories().add(subCatBaz);
  Session s=openSession();
  s.save(catWA);
  s.save(cat);
  s.flush();
  s.connection().commit();
  s.close();
  cat.setName("new foo");
  subCatBar.setName("new bar");
  cat.getSubcategories().remove(subCatBaz);
  Category newCat=new Category();
  newCat.setName("new");
  cat.getSubcategories().add(newCat);
  Category newSubCat=new Category();
  newSubCat.setName("new sub");
  newCat.getSubcategories().add(newSubCat);
  s=openSession();
  Category copiedCat=(Category)s.saveOrUpdateCopy(cat);
  s.flush();
  s.connection().commit();
  s.close();
  assertFalse(copiedCat == cat);
  assertTrue(cat.getSubcategories().contains(newCat));
  s=openSession();
  cat=(Category)s.createQuery("from Category cat where cat.name='new foo'").uniqueResult();
  newSubCat=(Category)s.createQuery("from Category cat left join fetch cat.subcategories where cat.name='new sub'").uniqueResult();
  assertTrue(newSubCat.getName().equals("new sub"));
  s.close();
  newSubCat.getSubcategories().add(cat);
  cat.setName("new new foo");
  s=openSession();
  newSubCat=(Category)s.saveOrUpdateCopy(newSubCat,new Long(newSubCat.getId()));
  assertTrue(newSubCat.getName().equals("new sub"));
  assertTrue(newSubCat.getSubcategories().size() == 1);
  cat=(Category)newSubCat.getSubcategories().get(0);
  assertTrue(cat.getName().equals("new new foo"));
  newSubCat.getSubcategories().remove(cat);
  s.delete(cat);
  s.delete(subCatBaz);
  s.delete(catWA);
  s.flush();
  s.connection().commit();
  s.close();
}
