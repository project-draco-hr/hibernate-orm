{
  log.trace("Building session factory");
  ejb3Configuration=buildConfiguration();
  ejb3Configuration.configure(getConfig());
  afterConfigurationBuilt(ejb3Configuration);
  entityManagerFactory=(EntityManagerFactoryImpl)ejb3Configuration.buildEntityManagerFactory(bootstrapRegistryBuilder());
  serviceRegistry=(BasicServiceRegistryImpl)((SessionFactoryImpl)entityManagerFactory.getSessionFactory()).getServiceRegistry().getParentServiceRegistry();
  afterEntityManagerFactoryBuilt();
}
