{
  try {
    withClause(hqlWithNode);
    AST hqlSqlWithNode=returnAST;
    if (log.isDebugEnabled()) {
      log.debug("handleWithFragment() : " + getASTPrinter().showAsString(hqlSqlWithNode,"-- with clause --"));
    }
    WithClauseVisitor visitor=new WithClauseVisitor(fromElement);
    NodeTraverser traverser=new NodeTraverser(visitor);
    traverser.traverseDepthFirst(hqlSqlWithNode);
    FromElement referencedFromElement=visitor.getReferencedFromElement();
    if (referencedFromElement != fromElement) {
      throw new InvalidWithClauseException("with-clause expressions did not reference from-clause element to which the with-clause was associated");
    }
    SqlGenerator sql=new SqlGenerator(getSessionFactoryHelper().getFactory());
    sql.whereExpr(hqlSqlWithNode.getFirstChild());
    fromElement.setWithClauseFragment(visitor.getJoinAlias(),"(" + sql.getSQL() + ")");
  }
 catch (  SemanticException e) {
    throw e;
  }
catch (  InvalidWithClauseException e) {
    throw e;
  }
catch (  Exception e) {
    throw new SemanticException(e.getMessage());
  }
}
