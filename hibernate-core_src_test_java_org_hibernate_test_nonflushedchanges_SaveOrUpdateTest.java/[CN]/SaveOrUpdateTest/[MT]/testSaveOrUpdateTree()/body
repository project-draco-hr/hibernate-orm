{
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  Node root=new Node("root");
  Node child=new Node("child");
  root.addChild(child);
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  child=(Node)getOldToNewEntityRefMap().get(child);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(2);
  clearCounts();
  root.setDescription("The root node");
  child.setDescription("The child node");
  Node secondChild=new Node("second child");
  root.addChild(secondChild);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(1);
  assertUpdateCount(2);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.createQuery("delete from Node where parent is not null").executeUpdate();
  s.createQuery("delete from Node").executeUpdate();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
}
