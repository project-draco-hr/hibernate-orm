{
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  Session s=openSession();
  Node root=new Node("root");
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
  assertInsertCount(1);
  assertUpdateCount(0);
  clearCounts();
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  s=openSession();
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
  assertInsertCount(0);
  assertUpdateCount(0);
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  s=openSession();
  root=(Node)s.get(Node.class,"root");
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  Hibernate.initialize(root.getChildren());
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
  clearCounts();
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  s=openSession();
  Node child=new Node("child");
  root.addChild(child);
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  child=(Node)root.getChildren().iterator().next();
  assertTrue(s.contains(child));
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(Node)getOldToNewEntityRefMap().get(root);
  child=(Node)getOldToNewEntityRefMap().get(child);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
  assertInsertCount(1);
  SimpleJtaTransactionManagerImpl.getInstance().begin();
  s=openSession();
  assertEquals(Long.valueOf(2),s.createCriteria(Node.class).setProjection(Projections.rowCount()).uniqueResult());
  s.delete(root);
  s.delete(child);
  SimpleJtaTransactionManagerImpl.getInstance().commit();
}
