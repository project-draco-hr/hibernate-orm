{
  boolean instrumented=FieldInterceptionHelper.isInstrumented(new NumberedNode());
  clearCounts();
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  NumberedNode root=new NumberedNode("root");
  NumberedNode child=new NumberedNode("child");
  NumberedNode grandchild=new NumberedNode("grandchild");
  root.addChild(child);
  child.addChild(grandchild);
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  child=(NumberedNode)getOldToNewEntityRefMap().get(child);
  grandchild=(NumberedNode)getOldToNewEntityRefMap().get(grandchild);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
  assertInsertCount(3);
  assertUpdateCount(0);
  clearCounts();
  child=(NumberedNode)root.getChildren().iterator().next();
  grandchild=(NumberedNode)child.getChildren().iterator().next();
  grandchild.setDescription("the grand child");
  NumberedNode grandchild2=new NumberedNode("grandchild2");
  child.addChild(grandchild2);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
  assertInsertCount(1);
  assertUpdateCount(instrumented ? 1 : 3);
  clearCounts();
  NumberedNode child2=new NumberedNode("child2");
  NumberedNode grandchild3=new NumberedNode("grandchild3");
  child2.addChild(grandchild3);
  root.addChild(child2);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
  assertInsertCount(2);
  assertUpdateCount(instrumented ? 0 : 4);
  clearCounts();
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.createQuery("delete from NumberedNode where name like 'grand%'").executeUpdate();
  s.createQuery("delete from NumberedNode where name like 'child%'").executeUpdate();
  s.createQuery("delete from NumberedNode").executeUpdate();
  TestingJtaPlatformImpl.INSTANCE.getTransactionManager().commit();
}
