{
  MetadataContext context=new MetadataContext(sessionFactory,mappedSuperclasses,ignoreUnsupported);
  while (persistentClasses.hasNext()) {
    PersistentClass pc=persistentClasses.next();
    locateOrBuildEntityType(pc,context);
  }
  handleUnusedMappedSuperclasses(context);
  context.wrapUp();
  return new MetamodelImpl(context.getEntityTypeMap(),context.getEmbeddableTypeMap(),context.getMappedSuperclassTypeMap(),context.getEntityTypesByEntityName());
}
