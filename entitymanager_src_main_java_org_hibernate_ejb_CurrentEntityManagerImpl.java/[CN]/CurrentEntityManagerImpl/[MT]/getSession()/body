{
  SessionFactoryImplementor sfi=(SessionFactoryImplementor)getEntityManagerFactory().getSessionFactory();
  Session s;
  if (!JTAHelper.isTransactionInProgress(sfi)) {
    s=sfi.openTemporarySession();
    ((SessionImplementor)s).setAutoClear(true);
  }
 else {
    s=sfi.getCurrentSession();
  }
  return s;
}
