{
  Session s=sessionFactory().openSession();
  s.setFlushMode(FlushMode.MANUAL);
  s.beginTransaction();
  Simple simple=new Simple(Long.valueOf(10));
  simple.setAddress("123 Main St. Anytown USA");
  simple.setCount(1);
  simple.setDate(new Date());
  simple.setName("My UnflushedSessionSerialization Simple");
  simple.setPay(Float.valueOf(5000));
  s.save(simple);
  s.getTransaction().commit();
  Session s2=spoofSerialization(s);
  s.close();
  s=s2;
  s.beginTransaction();
  simple=(Simple)s.load(Simple.class,new Long(10));
  Simple other=new Simple(Long.valueOf(11));
  other.init();
  s.save(other);
  simple.setOther(other);
  s.flush();
  s.getTransaction().commit();
  s.close();
  Simple check=simple;
  s=sessionFactory().openSession();
  s.setFlushMode(FlushMode.MANUAL);
  s.beginTransaction();
  simple=(Simple)s.get(Simple.class,Long.valueOf(10));
  assertTrue("Not same parent instances",check.getName().equals(simple.getName()));
  assertTrue("Not same child instances",check.getOther().getName().equals(other.getName()));
  simple.setName("My updated name");
  s.getTransaction().commit();
  s2=spoofSerialization(s);
  s.close();
  s=s2;
  s.beginTransaction();
  s.flush();
  s.getTransaction().commit();
  s.close();
  check=simple;
  s=sessionFactory().openSession();
  s.setFlushMode(FlushMode.MANUAL);
  s.beginTransaction();
  simple=(Simple)s.get(Simple.class,Long.valueOf(10));
  assertTrue("Not same parent instances",check.getName().equals(simple.getName()));
  assertTrue("Not same child instances",check.getOther().getName().equals(other.getName()));
  s.delete(simple);
  s.getTransaction().commit();
  s2=spoofSerialization(s);
  s.close();
  s=s2;
  s.beginTransaction();
  s.flush();
  s.getTransaction().commit();
  s.close();
  s=sessionFactory().openSession();
  s.setFlushMode(FlushMode.MANUAL);
  s.beginTransaction();
  Fum fum=new Fum(fumKey("uss-fum"));
  fum.setFo(new Fum(fumKey("uss-fo")));
  fum.setFum("fo fee fi");
  fum.getFo().setFum("stuff");
  Fum fr=new Fum(fumKey("uss-fr"));
  fr.setFum("goo");
  Fum fr2=new Fum(fumKey("uss-fr2"));
  fr2.setFum("soo");
  fum.setFriends(new HashSet());
  fum.getFriends().add(fr);
  fum.getFriends().add(fr2);
  s.save(fr);
  s.save(fr2);
  s.save(fum.getFo());
  s.save(fum);
  s.getTransaction().commit();
  s2=spoofSerialization(s);
  s.close();
  s=s2;
  s.beginTransaction();
  s.flush();
  s.getTransaction().commit();
  s.close();
  s=sessionFactory().openSession();
  s.setFlushMode(FlushMode.MANUAL);
  s.beginTransaction();
  fum=(Fum)s.load(Fum.class,fum.getId());
  assertTrue("the Fum.friends did not get saved",fum.getFriends().size() == 2);
  fum.setFriends(null);
  s.getTransaction().commit();
  s2=spoofSerialization(s);
  s.close();
  s=s2;
  s.beginTransaction();
  s.flush();
  s.getTransaction().commit();
  s.close();
  s=sessionFactory().openSession();
  s.setFlushMode(FlushMode.MANUAL);
  fum=(Fum)s.load(Fum.class,fum.getId());
  assertTrue("the Fum.friends is not empty",fum.getFriends() == null || fum.getFriends().size() == 0);
  s.connection().commit();
  s.close();
}
