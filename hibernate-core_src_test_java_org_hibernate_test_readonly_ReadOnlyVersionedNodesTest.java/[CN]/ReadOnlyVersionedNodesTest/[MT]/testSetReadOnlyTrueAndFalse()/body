{
  Session s=openSession();
  s.beginTransaction();
  VersionedNode node=new VersionedNode("node","node");
  s.persist(node);
  s.getTransaction().commit();
  s.close();
  clearCounts();
  s=openSession();
  s.beginTransaction();
  node=(VersionedNode)s.get(VersionedNode.class,node.getId());
  s.setReadOnly(node,true);
  node.setName("node-name");
  s.getTransaction().commit();
  assertUpdateCount(0);
  assertInsertCount(0);
  assertEquals("node-name",node.getName());
  s.beginTransaction();
  node=(VersionedNode)s.get(VersionedNode.class,node.getId());
  assertEquals("node-name",node.getName());
  s.refresh(node);
  assertEquals("node",node.getName());
  node=(VersionedNode)s.get(VersionedNode.class,node.getId());
  assertEquals("node",node.getName());
  s.getTransaction().commit();
  s.close();
  assertUpdateCount(0);
  assertInsertCount(0);
  s=openSession();
  s.beginTransaction();
  node=(VersionedNode)s.get(VersionedNode.class,node.getId());
  assertEquals("node",node.getName());
  s.setReadOnly(node,true);
  node.setName("diff-node-name");
  s.flush();
  assertEquals("diff-node-name",node.getName());
  s.refresh(node);
  assertEquals("node",node.getName());
  s.setReadOnly(node,false);
  node.setName("diff-node-name");
  s.getTransaction().commit();
  s.close();
  assertUpdateCount(1);
  assertInsertCount(0);
  clearCounts();
  s=openSession();
  s.beginTransaction();
  node=(VersionedNode)s.get(VersionedNode.class,node.getId());
  assertEquals("diff-node-name",node.getName());
  assertEquals(1,node.getVersion());
  s.setReadOnly(node,true);
  s.delete(node);
  s.getTransaction().commit();
  s.close();
  assertUpdateCount(0);
  assertDeleteCount(1);
}
