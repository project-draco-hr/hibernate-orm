{
  CollectionListeners listeners=new CollectionListeners(getSessions());
  ParentWithCollection parent=createParentWithOneChild("parent","child");
  ParentWithCollection otherParent=createParentWithOneChild("otherParent","otherChild");
  Child child=(Child)parent.getChildren().iterator().next();
  listeners.clear();
  Session s=openSession();
  Transaction tx=s.beginTransaction();
  parent=(ParentWithCollection)s.get(parent.getClass(),parent.getId());
  otherParent=(ParentWithCollection)s.get(otherParent.getClass(),otherParent.getId());
  if (child instanceof ChildEntity) {
    child=(ChildEntity)s.get(child.getClass(),((ChildEntity)child).getId());
  }
  otherParent.addAllChildren(parent.getChildren());
  parent.clearChildren();
  tx.commit();
  s.close();
  int index=0;
  if (((PersistentCollection)parent.getChildren()).wasInitialized()) {
    checkResult(listeners,listeners.getInitializeCollectionListener(),parent,index++);
  }
  if (((PersistentCollection)otherParent.getChildren()).wasInitialized()) {
    checkResult(listeners,listeners.getInitializeCollectionListener(),otherParent,index++);
  }
  if (child.hasBidirectionalManyToMany()) {
    checkResult(listeners,listeners.getInitializeCollectionListener(),child,index++);
  }
  checkResult(listeners,listeners.getPreCollectionUpdateListener(),parent,index++);
  checkResult(listeners,listeners.getPostCollectionUpdateListener(),parent,index++);
  checkResult(listeners,listeners.getPreCollectionUpdateListener(),otherParent,index++);
  checkResult(listeners,listeners.getPostCollectionUpdateListener(),otherParent,index++);
  if (child.hasBidirectionalManyToMany()) {
    checkResult(listeners,listeners.getPreCollectionUpdateListener(),child,index++);
    checkResult(listeners,listeners.getPostCollectionUpdateListener(),child,index++);
  }
  checkNumberOfResults(listeners,index);
}
