{
  try {
    em=getOrCreateEntityManager();
    super.runTest();
    if (em.getTransaction().isActive()) {
      em.getTransaction().rollback();
      fail("You left an open transaction! Fix your test case. For now, we are closing it for you.");
    }
  }
 catch (  Throwable t) {
    if (em.getTransaction().isActive())     em.getTransaction().rollback();
    throw t;
  }
 finally {
    if (em.isOpen()) {
      em.close();
      log.warn("The EntityManager is not closed. Closing it.");
    }
  }
}
