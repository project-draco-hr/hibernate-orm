{
  collection.setOwner(entity);
  CollectionEntry ce=session.getPersistenceContext().getCollectionEntry(collection);
  if (ce == null) {
    throw new HibernateException("Found two representations of same collection: " + type.getRole());
  }
  if (ce.isReached()) {
    throw new HibernateException("Found shared references to a collection: " + type.getRole());
  }
  ce.setReached(true);
  SessionFactoryImplementor factory=session.getFactory();
  CollectionPersister persister=factory.getCollectionPersister(type.getRole());
  ce.setCurrentPersister(persister);
  ce.setCurrentKey(type.getKeyOfOwner(entity,session));
  if (LOG.isDebugEnabled()) {
    if (collection.wasInitialized())     LOG.debugf("Collection found: %s, was: %s (initialized)",MessageHelper.collectionInfoString(persister,ce.getCurrentKey(),factory),MessageHelper.collectionInfoString(ce.getLoadedPersister(),ce.getLoadedKey(),factory));
 else     LOG.debugf("Collection found: %s, was: %s (uninitialized)",MessageHelper.collectionInfoString(persister,ce.getCurrentKey(),factory),MessageHelper.collectionInfoString(ce.getLoadedPersister(),ce.getLoadedKey(),factory));
  }
  prepareCollectionForUpdate(collection,ce,factory);
}
