{
  sessionFactory().evictQueries();
  sessionFactory().getStatistics().clear();
  final String queryString="from Item i where i.name='widget'";
  Session s=openSession();
  Transaction t=s.beginTransaction();
  s.createQuery(queryString).setCacheable(true).list();
  Item i=new Item();
  i.setName("widget");
  i.setDescription("A really top-quality, full-featured widget.");
  s.save(i);
  t.commit();
  s.close();
  QueryStatistics qs=s.getSessionFactory().getStatistics().getQueryStatistics(queryString);
  EntityStatistics es=s.getSessionFactory().getStatistics().getEntityStatistics(Item.class.getName());
  Thread.sleep(200);
  s=openSession();
  t=s.beginTransaction();
  List result=s.createQuery(queryString).setCacheable(true).list();
  assertEquals(result.size(),1);
  t.commit();
  s.close();
  assertEquals(qs.getCacheHitCount(),0);
  s=openSession();
  t=s.beginTransaction();
  result=s.createQuery(queryString).setCacheable(true).list();
  assertEquals(result.size(),1);
  t.commit();
  s.close();
  assertEquals(qs.getCacheHitCount(),1);
  assertEquals(s.getSessionFactory().getStatistics().getEntityFetchCount(),0);
  s=openSession();
  t=s.beginTransaction();
  result=s.createQuery(queryString).setCacheable(true).list();
  assertEquals(result.size(),1);
  assertTrue(Hibernate.isInitialized(result.get(0)));
  i=(Item)result.get(0);
  i.setName("Widget");
  t.commit();
  s.close();
  assertEquals(qs.getCacheHitCount(),2);
  assertEquals(qs.getCacheMissCount(),2);
  assertEquals(s.getSessionFactory().getStatistics().getEntityFetchCount(),0);
  Thread.sleep(200);
  s=openSession();
  t=s.beginTransaction();
  result=s.createQuery(queryString).setCacheable(true).list();
  i=(Item)s.get(Item.class,new Long(i.getId()));
  s.delete(i);
  t.commit();
  s.close();
  assertEquals(qs.getCacheHitCount(),2);
  assertEquals(qs.getCacheMissCount(),3);
  assertEquals(qs.getCachePutCount(),3);
  assertEquals(qs.getExecutionCount(),3);
  assertEquals(es.getFetchCount(),0);
}
