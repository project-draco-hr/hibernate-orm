{
  final MetadataSources metadataSources=builder.getSources();
  this.serviceRegistry=metadataSources.getServiceRegistry();
  this.namingStrategy=builder.getNamingStrategy();
  this.sharedCacheMode=builder.getSharedCacheMode();
  final ArrayList<String> processedEntityNames=new ArrayList<String>();
  if (builder.getSourceProcessingOrder() == SourceProcessingOrder.HBM_FIRST) {
    applyHibernateMappings(metadataSources,processedEntityNames);
    applyAnnotationMappings(metadataSources,processedEntityNames);
  }
 else {
    applyAnnotationMappings(metadataSources,processedEntityNames);
    applyHibernateMappings(metadataSources,processedEntityNames);
  }
  new EntityReferenceResolver(this).resolve();
}
