{
  if (!isOpen()) {
    throw new IllegalStateException("EntityManagerFactory is closed");
  }
  if (StoredProcedureQueryImpl.class.isInstance(query)) {
    final ProcedureCall procedureCall=((StoredProcedureQueryImpl)query).getHibernateProcedureCall();
    sessionFactory.getNamedQueryRepository().registerNamedProcedureCallMemento(name,procedureCall.extractMemento(query.getHints()));
  }
 else   if (!HibernateQuery.class.isInstance(query)) {
    throw new PersistenceException("Cannot use query non-Hibernate EntityManager query as basis for named query");
  }
 else {
    final org.hibernate.Query hibernateQuery=((HibernateQuery)query).getHibernateQuery();
    if (org.hibernate.SQLQuery.class.isInstance(hibernateQuery)) {
      sessionFactory.registerNamedSQLQueryDefinition(name,extractSqlQueryDefinition((org.hibernate.SQLQuery)hibernateQuery,name));
    }
 else {
      sessionFactory.registerNamedQueryDefinition(name,extractHqlQueryDefinition(hibernateQuery,name));
    }
  }
}
