{
  this.sessionFactory=sessionFactory;
  this.transactionType=settings.getTransactionType();
  this.discardOnClose=settings.isReleaseResourcesOnCloseEnabled();
  this.sessionInterceptorClass=settings.getSessionInterceptorClass();
  final JpaMetaModelPopulationSetting jpaMetaModelPopulationSetting=determineJpaMetaModelPopulationSetting(configurationValues);
  if (JpaMetaModelPopulationSetting.DISABLED == jpaMetaModelPopulationSetting) {
    this.metamodel=null;
  }
 else {
    this.metamodel=MetamodelImpl.buildMetamodel(metadata.getEntityBindings().iterator(),metadata.getMappedSuperclassMappingsCopy(),sessionFactory,JpaMetaModelPopulationSetting.IGNORE_UNSUPPORTED == jpaMetaModelPopulationSetting);
  }
  this.criteriaBuilder=new CriteriaBuilderImpl(this);
  this.util=new HibernatePersistenceUnitUtil(this);
  HashMap<String,Object> props=new HashMap<String,Object>();
  addAll(props,sessionFactory.getProperties());
  addAll(props,configurationValues);
  if (!props.containsKey(AvailableSettings.VALIDATION_FACTORY)) {
    if (sessionFactory.getSessionFactoryOptions().getValidatorFactoryReference() != null) {
      props.put(AvailableSettings.VALIDATION_FACTORY,sessionFactory.getSessionFactoryOptions().getValidatorFactoryReference());
    }
  }
  maskOutSensitiveInformation(props);
  this.properties=Collections.unmodifiableMap(props);
  String entityManagerFactoryName=(String)this.properties.get(AvailableSettings.ENTITY_MANAGER_FACTORY_NAME);
  if (entityManagerFactoryName == null) {
    entityManagerFactoryName=persistenceUnitName;
  }
  if (entityManagerFactoryName == null) {
    entityManagerFactoryName=(String)UUID_GENERATOR.generate(null,null);
  }
  this.entityManagerFactoryName=entityManagerFactoryName;
  applyNamedEntityGraphs(metadata.getNamedEntityGraphs().values());
  EntityManagerFactoryRegistry.INSTANCE.addEntityManagerFactory(entityManagerFactoryName,this);
}
