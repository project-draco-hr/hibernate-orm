{
  final SqlStatementLogger statementLogger=session.getFactory().getServiceRegistry().getService(JdbcServices.class).getSqlStatementLogger();
  return session.getTransactionCoordinator().getTransaction().createIsolationDelegate().delegateWork(new ReturningWork<IntegralDataTypeHolder>(){
    @Override public IntegralDataTypeHolder execute(    Connection connection) throws SQLException {
      IntegralDataTypeHolder value=buildHolder();
      int rows;
      do {
        statementLogger.logStatement(query,FormatStyle.BASIC.getFormatter());
        PreparedStatement qps=connection.prepareStatement(query);
        try {
          ResultSet rs=qps.executeQuery();
          if (!rs.next()) {
            String err="could not read a hi value - you need to populate the table: " + tableName;
            LOG.error(err);
            throw new IdentifierGenerationException(err);
          }
          value.initialize(rs,1);
          rs.close();
        }
 catch (        SQLException e) {
          LOG.error("Could not read a hi value",e);
          throw e;
        }
 finally {
          qps.close();
        }
        statementLogger.logStatement(update,FormatStyle.BASIC.getFormatter());
        PreparedStatement ups=connection.prepareStatement(update);
        try {
          value.copy().increment().bind(ups,1);
          value.bind(ups,2);
          rows=ups.executeUpdate();
        }
 catch (        SQLException sqle) {
          LOG.error(LOG.unableToUpdateHiValue(tableName),sqle);
          throw sqle;
        }
 finally {
          ups.close();
        }
      }
 while (rows == 0);
      return value;
    }
  }
,true);
}
