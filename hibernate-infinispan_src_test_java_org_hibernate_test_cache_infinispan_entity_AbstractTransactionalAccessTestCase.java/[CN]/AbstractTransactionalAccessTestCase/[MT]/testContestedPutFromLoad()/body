{
  final Object KEY=TestingKeyFactory.generateEntityCacheKey(KEY_BASE + testCount++);
  localAccessStrategy.putFromLoad(localSession,KEY,VALUE1,System.currentTimeMillis(),new Integer(1));
  final CountDownLatch pferLatch=new CountDownLatch(1);
  final CountDownLatch pferCompletionLatch=new CountDownLatch(1);
  final CountDownLatch commitLatch=new CountDownLatch(1);
  final CountDownLatch completionLatch=new CountDownLatch(1);
  Thread blocker=new Thread("Blocker"){
    @Override public void run(){
      try {
        long txTimestamp=System.currentTimeMillis();
        BatchModeTransactionManager.getInstance().begin();
        assertEquals("Correct initial value",VALUE1,localAccessStrategy.get(localSession,KEY,txTimestamp));
        SoftLock softLock=localAccessStrategy.lockItem(localSession,KEY,null);
        localAccessStrategy.update(localSession,KEY,VALUE2,new Integer(2),new Integer(1));
        localAccessStrategy.unlockItem(localSession,KEY,softLock);
        pferLatch.countDown();
        commitLatch.await();
        BatchModeTransactionManager.getInstance().commit();
      }
 catch (      Exception e) {
        log.error("node1 caught exception",e);
        node1Exception=e;
        rollback();
      }
catch (      AssertionFailedError e) {
        node1Failure=e;
        rollback();
      }
 finally {
        completionLatch.countDown();
      }
    }
  }
;
  Thread putter=new Thread("Putter"){
    @Override public void run(){
      try {
        long txTimestamp=System.currentTimeMillis();
        BatchModeTransactionManager.getInstance().begin();
        localAccessStrategy.putFromLoad(null,KEY,VALUE1,txTimestamp,new Integer(1));
        BatchModeTransactionManager.getInstance().commit();
      }
 catch (      Exception e) {
        log.error("node1 caught exception",e);
        node1Exception=e;
        rollback();
      }
catch (      AssertionFailedError e) {
        node1Failure=e;
        rollback();
      }
 finally {
        pferCompletionLatch.countDown();
      }
    }
  }
;
  blocker.start();
  assertTrue("Active tx has done an update",pferLatch.await(1,TimeUnit.SECONDS));
  putter.start();
  assertTrue("putFromLoadreturns promtly",pferCompletionLatch.await(10,TimeUnit.MILLISECONDS));
  commitLatch.countDown();
  assertTrue("Threads completed",completionLatch.await(1,TimeUnit.SECONDS));
  assertThreadsRanCleanly();
  long txTimestamp=System.currentTimeMillis();
  assertEquals("Correct node1 value",VALUE2,localAccessStrategy.get(null,KEY,txTimestamp));
}
