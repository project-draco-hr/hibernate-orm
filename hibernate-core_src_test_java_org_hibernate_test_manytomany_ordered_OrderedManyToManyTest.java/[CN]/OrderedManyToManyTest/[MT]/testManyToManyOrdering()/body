{
  Session s=openSession();
  Transaction t=s.beginTransaction();
  User gavin=new User("gavin","jboss");
  User steve=new User("steve","jboss");
  User max=new User("max","jboss");
  User emmanuel=new User("emmanuel","jboss");
  s.persist(gavin);
  s.persist(steve);
  s.persist(max);
  s.persist(emmanuel);
  Group hibernate=new Group("hibernate","jboss");
  hibernate.addUser(gavin);
  hibernate.addUser(steve);
  hibernate.addUser(max);
  hibernate.addUser(emmanuel);
  s.persist(hibernate);
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  hibernate=(Group)s.get(Group.class,hibernate.getId());
  assertFalse(Hibernate.isInitialized(hibernate.getUsers()));
  assertEquals(4,hibernate.getUsers().size());
  assertOrdering(hibernate.getUsers());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  hibernate=(Group)s.createQuery("from Group").uniqueResult();
  assertFalse(Hibernate.isInitialized(hibernate.getUsers()));
  assertEquals(4,hibernate.getUsers().size());
  assertOrdering(hibernate.getUsers());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  hibernate=(Group)s.createQuery("from Group g inner join fetch g.users").uniqueResult();
  assertTrue(Hibernate.isInitialized(hibernate.getUsers()));
  assertEquals(4,hibernate.getUsers().size());
  assertOrdering(hibernate.getUsers());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  Criteria criteria=s.createCriteria(Group.class);
  criteria.setFetchMode("users",FetchMode.JOIN);
  hibernate=(Group)criteria.uniqueResult();
  assertTrue(Hibernate.isInitialized(hibernate.getUsers()));
  assertEquals(4,hibernate.getUsers().size());
  assertOrdering(hibernate.getUsers());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  criteria=s.createCriteria(Group.class);
  criteria.setFetchMode("users",FetchMode.SELECT);
  hibernate=(Group)criteria.uniqueResult();
  assertFalse(Hibernate.isInitialized(hibernate.getUsers()));
  assertEquals(4,hibernate.getUsers().size());
  assertOrdering(hibernate.getUsers());
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  s.delete(gavin);
  s.delete(steve);
  s.delete(max);
  s.delete(emmanuel);
  s.delete(hibernate);
  t.commit();
  s.close();
}
