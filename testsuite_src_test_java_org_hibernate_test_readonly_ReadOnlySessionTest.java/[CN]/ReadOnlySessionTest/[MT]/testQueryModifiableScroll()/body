{
  Session s=openSession();
  s.setCacheMode(CacheMode.IGNORE);
  Transaction t=s.beginTransaction();
  DataPoint dp=null;
  for (int i=0; i < 100; i++) {
    dp=new DataPoint();
    dp.setX(new BigDecimal(i * 0.1d).setScale(19,BigDecimal.ROUND_DOWN));
    dp.setY(new BigDecimal(Math.cos(dp.getX().doubleValue())).setScale(19,BigDecimal.ROUND_DOWN));
    s.save(dp);
  }
  t.commit();
  s.close();
  s=openSession();
  s.setCacheMode(CacheMode.IGNORE);
  t=s.beginTransaction();
  s.setDefaultReadOnly(true);
  int i=0;
  Query query=s.createQuery("from DataPoint dp order by dp.x asc");
  assertTrue(query.isReadOnly());
  s.setDefaultReadOnly(false);
  assertFalse(query.isReadOnly());
  s.setDefaultReadOnly(true);
  assertTrue(query.isReadOnly());
  query.setReadOnly(false);
  assertFalse(query.isReadOnly());
  s.setDefaultReadOnly(false);
  assertFalse(query.isReadOnly());
  s.setDefaultReadOnly(true);
  assertFalse(query.isReadOnly());
  query.setReadOnly(true);
  assertTrue(query.isReadOnly());
  s.setDefaultReadOnly(false);
  assertTrue(query.isReadOnly());
  query.setReadOnly(false);
  assertFalse(query.isReadOnly());
  s.setDefaultReadOnly(true);
  assertTrue(s.isDefaultReadOnly());
  ScrollableResults sr=query.scroll(ScrollMode.FORWARD_ONLY);
  assertFalse(query.isReadOnly());
  DataPoint dpLast=(DataPoint)s.get(DataPoint.class,dp.getId());
  assertTrue(s.isReadOnly(dpLast));
  query.setReadOnly(true);
  assertTrue(query.isReadOnly());
  int nExpectedChanges=0;
  assertTrue(s.isDefaultReadOnly());
  while (sr.next()) {
    assertTrue(s.isDefaultReadOnly());
    dp=(DataPoint)sr.get(0);
    if (dp.getId() == dpLast.getId()) {
      assertTrue(s.isReadOnly(dp));
    }
 else {
      assertFalse(s.isReadOnly(dp));
    }
    if (++i == 50) {
      s.setReadOnly(dp,true);
      nExpectedChanges=(dp == dpLast ? 99 : 98);
    }
    dp.setDescription("done!");
  }
  assertTrue(s.isDefaultReadOnly());
  t.commit();
  s.clear();
  t=s.beginTransaction();
  List list=s.createQuery("from DataPoint where description='done!'").list();
  assertEquals(nExpectedChanges,list.size());
  s.createQuery("delete from DataPoint").executeUpdate();
  t.commit();
  s.close();
}
