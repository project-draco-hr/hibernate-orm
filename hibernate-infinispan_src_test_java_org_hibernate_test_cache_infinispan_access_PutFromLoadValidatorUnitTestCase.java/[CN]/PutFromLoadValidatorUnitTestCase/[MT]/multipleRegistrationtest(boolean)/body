{
  final PutFromLoadValidator testee=new PutFromLoadValidator(new DefaultCacheManager(),transactional ? tm : null,PutFromLoadValidator.NAKED_PUT_INVALIDATION_PERIOD);
  final CountDownLatch registeredLatch=new CountDownLatch(3);
  final CountDownLatch finishedLatch=new CountDownLatch(3);
  final AtomicInteger success=new AtomicInteger();
  Runnable r=new Runnable(){
    public void run(){
      try {
        if (transactional) {
          tm.begin();
        }
        testee.registerPendingPut(KEY1);
        registeredLatch.countDown();
        registeredLatch.await(5,TimeUnit.SECONDS);
        if (testee.acquirePutFromLoadLock(KEY1)) {
          try {
            success.incrementAndGet();
          }
  finally {
            testee.releasePutFromLoadLock(KEY1);
          }
        }
        finishedLatch.countDown();
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
  }
;
  ExecutorService executor=Executors.newFixedThreadPool(3);
  testee.invalidateRegion();
  executor.execute(r);
  executor.execute(r);
  executor.execute(r);
  finishedLatch.await(5,TimeUnit.SECONDS);
  assertEquals("All threads succeeded",3,success.get());
}
