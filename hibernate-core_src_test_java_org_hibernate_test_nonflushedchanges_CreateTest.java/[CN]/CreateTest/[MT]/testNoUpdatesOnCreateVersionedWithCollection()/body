{
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  VersionedEntity root=new VersionedEntity("root","root");
  VersionedEntity child=new VersionedEntity("c1","child-1");
  root.getChildren().add(child);
  child.setParent(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  s.save(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(VersionedEntity)getOldToNewEntityRefMap().get(root);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(VersionedEntity)getOldToNewEntityRefMap().get(root);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(2);
  assertUpdateCount(0);
  assertDeleteCount(0);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.delete(root);
  applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertUpdateCount(0);
  assertDeleteCount(2);
}
