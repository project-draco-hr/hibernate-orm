{
  boolean instrumented=FieldInterceptionHelper.isInstrumented(new NumberedNode());
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  NumberedNode root=new NumberedNode("root");
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(1);
  assertUpdateCount(0);
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(0);
  assertUpdateCount(instrumented ? 0 : 1);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  root=(NumberedNode)s.get(NumberedNode.class,Long.valueOf(root.getId()));
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  Hibernate.initialize(root.getChildren());
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  NumberedNode child=new NumberedNode("child");
  root.addChild(child);
  s.saveOrUpdate(root);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  root=(NumberedNode)getOldToNewEntityRefMap().get(root);
  assertTrue(Hibernate.isInitialized(root.getChildren()));
  child=(NumberedNode)root.getChildren().iterator().next();
  assertTrue(s.contains(child));
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(1);
  assertUpdateCount(instrumented ? 0 : 1);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  assertEquals(s.createCriteria(NumberedNode.class).setProjection(Projections.rowCount()).uniqueResult(),new Long(2));
  s.delete(root);
  s.delete(child);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
}
