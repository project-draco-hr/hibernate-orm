{
  TransactionManager transactionManager=factory.getTransactionManager();
  if (transactionManager == null) {
    throw new HibernateException("No TransactionManagerLookup specified");
  }
  Transaction txn;
  try {
    txn=transactionManager.getTransaction();
    if (txn == null) {
      throw new HibernateException("Unable to locate current JTA transaction");
    }
    if (!JTAHelper.isInProgress(txn.getStatus())) {
      throw new HibernateException("Current transaction is not in progress");
    }
  }
 catch (  HibernateException e) {
    throw e;
  }
catch (  Throwable t) {
    throw new HibernateException("Problem locating/validating JTA transaction",t);
  }
  final Object txnIdentifier=factory.getSettings().getTransactionManagerLookup() == null ? txn : factory.getSettings().getTransactionManagerLookup().getTransactionIdentifier(txn);
  Session currentSession=(Session)currentSessionMap.get(txnIdentifier);
  if (currentSession == null) {
    currentSession=buildOrObtainSession();
    try {
      txn.registerSynchronization(buildCleanupSynch(txnIdentifier));
    }
 catch (    Throwable t) {
      try {
        currentSession.close();
      }
 catch (      Throwable ignore) {
        LOG.unableToReleaseSession(ignore.getMessage());
      }
      throw new HibernateException("Unable to register cleanup Synchronization with TransactionManager");
    }
    currentSessionMap.put(txnIdentifier,currentSession);
  }
  return currentSession;
}
