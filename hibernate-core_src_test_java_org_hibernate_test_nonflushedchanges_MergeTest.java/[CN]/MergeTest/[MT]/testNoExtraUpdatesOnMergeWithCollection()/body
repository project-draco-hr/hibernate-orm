{
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  Node parent=new Node("parent");
  Node child=new Node("child");
  parent.getChildren().add(child);
  child.setParent(parent);
  s.persist(parent);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  parent=(Node)s.merge(parent);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertUpdateCount(0);
  assertInsertCount(0);
  ((Node)parent.getChildren().iterator().next()).setDescription("child's new description");
  parent.addChild(new Node("second child"));
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  parent=(Node)s.merge(parent);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertUpdateCount(1);
  assertInsertCount(1);
  cleanup();
}
