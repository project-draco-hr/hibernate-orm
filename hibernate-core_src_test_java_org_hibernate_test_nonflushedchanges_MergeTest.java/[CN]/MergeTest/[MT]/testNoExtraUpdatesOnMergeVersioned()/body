{
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  VersionedEntity entity=new VersionedEntity("entity","entity");
  s.persist(entity);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  clearCounts();
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  VersionedEntity mergedEntity=(VersionedEntity)s.merge(entity);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  mergedEntity=(VersionedEntity)getOldToNewEntityRefMap().get(mergedEntity);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertUpdateCount(0);
  assertInsertCount(0);
  assertEquals("unexpected version increment",entity.getVersion(),mergedEntity.getVersion());
  entity.setName("new name");
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  entity=(VersionedEntity)s.merge(entity);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertUpdateCount(1);
  assertInsertCount(0);
  cleanup();
}
