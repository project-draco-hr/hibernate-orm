{
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  Session s=openSession();
  Person p=new Person("steve");
  Address a=new Address("123 Main","Austin","US",p);
  s.persist(a);
  s.persist(p);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  clearCounts();
  p.getAddress().setStreetAddress("321 Main");
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  p=(Person)s.merge(p);
  s=applyNonFlushedChangesToNewSessionCloseOldSession(s);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
  assertInsertCount(0);
  assertUpdateCount(0);
  assertDeleteCount(0);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().begin();
  s=openSession();
  s.delete(a);
  s.delete(p);
  TestingJtaBootstrap.INSTANCE.getTransactionManager().commit();
}
