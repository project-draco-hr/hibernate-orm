{
  LOG.trace("Closing session");
  if (isClosed()) {
    throw new SessionException("Session was already closed");
  }
  if (factory.getStatistics().isStatisticsEnabled()) {
    factory.getStatisticsImplementor().closeSession();
  }
  getEventListenerManager().end();
  try {
    if (!isTransactionCoordinatorShared) {
      return transactionCoordinator.close();
    }
 else {
      if (getActionQueue().hasBeforeTransactionActions() || getActionQueue().hasAfterTransactionActions()) {
        LOG.warn("On close, shared Session had before / after transaction actions that have not yet been processed");
      }
 else {
        transactionCoordinator.removeObserver(transactionObserver);
      }
      return null;
    }
  }
  finally {
    setClosed();
    cleanup();
  }
}
