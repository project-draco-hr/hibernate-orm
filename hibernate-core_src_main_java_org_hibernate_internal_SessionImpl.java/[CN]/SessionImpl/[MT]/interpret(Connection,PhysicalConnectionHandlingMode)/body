{
  if (userSuppliedConnection != null) {
    return DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION;
  }
  if (connectionHandlingMode == null) {
    connectionHandlingMode=getFactory().getSessionFactoryOptions().getPhysicalConnectionHandlingMode();
  }
  if (connectionHandlingMode.getReleaseMode() == ConnectionReleaseMode.AFTER_STATEMENT) {
    if (!getJdbcConnectionAccess().supportsAggressiveRelease()) {
      log.debug("Connection provider reports to not support aggressive release; overriding");
      return PhysicalConnectionHandlingMode.interpret(connectionHandlingMode.getAcquisitionMode(),ConnectionReleaseMode.AFTER_TRANSACTION);
    }
  }
  return connectionHandlingMode;
}
