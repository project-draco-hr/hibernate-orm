{
  log.trace("Flushing entities and processing referenced collections");
  final EventSource source=event.getSession();
  final Map.Entry[] list=IdentityMap.concurrentEntries(source.getPersistenceContext().getEntityEntries());
  final int size=list.length;
  for (int i=0; i < size; i++) {
    Map.Entry me=list[i];
    EntityEntry entry=(EntityEntry)me.getValue();
    Status status=entry.getStatus();
    if (status != Status.LOADING && status != Status.GONE) {
      FlushEntityEvent entityEvent=new FlushEntityEvent(source,me.getKey(),entry);
      FlushEntityEventListener[] listeners=source.getListeners().getFlushEntityEventListeners();
      for (int j=0; j < listeners.length; j++) {
        listeners[j].onFlushEntity(entityEvent);
      }
    }
  }
  source.getActionQueue().sortActions();
}
