{
  if (entity == null || copy == null) {
    throw new NullPointerException("null entities and copies are not supported by " + getClass().getName());
  }
  Object oldCopy=entityToCopyMap.put(entity,copy);
  Boolean oldOperatedOn=entityToOperatedOnFlagMap.put(entity,isOperatedOn);
  Object oldEntity=copyToEntityMap.put(copy,entity);
  if (oldCopy == null) {
    if (oldEntity != null) {
      throw new IllegalStateException("Error occurred while storing entity " + printEntity(entity) + ". An entity copy "+ printEntity(copy)+ " was already assigned to a different entity "+ printEntity(oldEntity)+ ".");
    }
    if (oldOperatedOn != null) {
      throw new IllegalStateException("EventCache#entityToOperatedOnFlagMap contains an entity " + printEntity(entity) + ", but EventCache#entityToCopyMap does not.");
    }
  }
 else {
    if (oldCopy != copy) {
      Object removedEntity=copyToEntityMap.remove(oldCopy);
      if (removedEntity != entity) {
        throw new IllegalStateException("Error occurred while storing entity " + printEntity(entity) + ". An unexpected entity "+ printEntity(removedEntity)+ " was associated with the old entity copy "+ printEntity(oldCopy)+ ".");
      }
      if (oldEntity != null) {
        throw new IllegalStateException("Error occurred while storing entity " + printEntity(entity) + ". A new entity copy "+ printEntity(copy)+ " is already associated with a different entity "+ printEntity(oldEntity)+ ".");
      }
    }
 else {
      if (oldEntity != entity) {
        throw new IllegalStateException("An entity copy " + printEntity(copy) + " was associated with a different entity "+ printEntity(oldEntity)+ " than provided "+ printEntity(entity)+ ".");
      }
    }
    if (oldOperatedOn == null) {
      throw new IllegalStateException("EventCache#entityToCopyMap contained an entity " + printEntity(entity) + ", but EventCache#entityToOperatedOnFlagMap did not.");
    }
  }
  return oldCopy;
}
