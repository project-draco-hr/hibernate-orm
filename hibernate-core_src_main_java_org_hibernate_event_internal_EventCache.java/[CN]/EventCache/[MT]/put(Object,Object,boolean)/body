{
  if (entity == null || copy == null) {
    throw new NullPointerException("null entities and copies are not supported by " + getClass().getName());
  }
  Object oldCopy=entityToCopyMap.put(entity,copy);
  Boolean oldOperatedOn=entityToOperatedOnFlagMap.put(entity,isOperatedOn);
  Object oldEntity=copyToEntityMap.put(copy,entity);
  if (oldCopy == null) {
    if (oldEntity != null) {
      throw new IllegalStateException("An entity copy was already assigned to a different entity.");
    }
    if (oldOperatedOn != null) {
      throw new IllegalStateException("entityToOperatedOnFlagMap contains an entity, but entityToCopyMap does not.");
    }
  }
 else {
    if (oldCopy != copy) {
      Object removedEntity=copyToEntityMap.remove(oldCopy);
      if (removedEntity != entity) {
        throw new IllegalStateException("An unexpected entity was associated with the old entity copy.");
      }
      if (oldEntity != null) {
        throw new IllegalStateException("A new entity copy is already associated with a different entity.");
      }
    }
 else {
      if (oldEntity != entity) {
        throw new IllegalStateException("An entity copy was associated with a different entity than provided.");
      }
    }
    if (oldOperatedOn == null) {
      throw new IllegalStateException("entityToCopyMap contained an entity, but entityToOperatedOnFlagMap did not.");
    }
  }
  return oldCopy;
}
