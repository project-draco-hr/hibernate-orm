{
  final JtaPlatform jtaPlatform=factory().getServiceRegistry().getService(JtaPlatform.class);
  final TransactionManager transactionManager=jtaPlatform.retrieveTransactionManager();
  if (transactionManager == null) {
    throw new HibernateException("No TransactionManagerLookup specified");
  }
  Transaction txn;
  try {
    txn=transactionManager.getTransaction();
    if (txn == null) {
      throw new HibernateException("Unable to locate current JTA transaction");
    }
    if (!JtaStatusHelper.isActive(txn.getStatus())) {
      throw new HibernateException("Current transaction is not in progress");
    }
  }
 catch (  HibernateException e) {
    throw e;
  }
catch (  Throwable t) {
    throw new HibernateException("Problem locating/validating JTA transaction",t);
  }
  final Object txnIdentifier=jtaPlatform.getTransactionIdentifier(txn);
  Session currentSession=currentSessionMap.get(txnIdentifier);
  if (currentSession == null) {
    currentSession=buildOrObtainSession();
    try {
      txn.registerSynchronization(buildCleanupSynch(txnIdentifier));
    }
 catch (    Throwable t) {
      try {
        currentSession.close();
      }
 catch (      Throwable ignore) {
        LOG.debug("Unable to release generated current-session on failed synch registration",ignore);
      }
      throw new HibernateException("Unable to register cleanup Synchronization with TransactionManager");
    }
    currentSessionMap.put(txnIdentifier,currentSession);
  }
 else {
    validateExistingSession(currentSession);
  }
  return currentSession;
}
