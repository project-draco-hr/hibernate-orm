{
  Session s=openSession();
  s.beginTransaction();
  Baz baz=new Baz();
  Baz baz2=new Baz();
  baz.setFooSet(new HashSet());
  Foo foo=new Foo();
  baz.getFooSet().add(foo);
  s.save(foo);
  s.save(baz);
  s.save(baz2);
  foo.setBytes("foobar".getBytes());
  s.getTransaction().commit();
  s.close();
  s=openSession();
  s.beginTransaction();
  foo=(Foo)s.get(Foo.class,foo.getKey());
  assertTrue(Hibernate.isInitialized(foo.getBytes()));
  assertTrue(foo.getBytes().length == 6);
  baz=(Baz)s.get(Baz.class,baz.getCode());
  assertTrue(baz.getFooSet().size() == 1);
  s.getTransaction().commit();
  s.close();
  sessionFactory().evictCollection("org.hibernate.test.legacy.Baz.fooSet");
  s=openSession();
  s.beginTransaction();
  baz=(Baz)s.get(Baz.class,baz.getCode());
  assertFalse(Hibernate.isInitialized(baz.getFooSet()));
  baz2=(Baz)s.get(Baz.class,baz2.getCode());
  baz2.setFooSet(baz.getFooSet());
  baz.setFooSet(null);
  assertFalse(Hibernate.isInitialized(baz2.getFooSet()));
  s.getTransaction().commit();
  s.close();
  s=openSession();
  s.beginTransaction();
  foo=(Foo)s.get(Foo.class,foo.getKey());
  assertTrue(foo.getBytes().length == 6);
  baz=(Baz)s.get(Baz.class,baz.getCode());
  baz2=(Baz)s.get(Baz.class,baz2.getCode());
  assertFalse(Hibernate.isInitialized(baz.getFooSet()));
  assertTrue(baz.getFooSet().size() == 0);
  assertTrue(Hibernate.isInitialized(baz2.getFooSet()));
  assertTrue(baz2.getFooSet().size() == 1);
  s.delete(baz);
  s.delete(baz2);
  s.delete(foo);
  s.getTransaction().commit();
  s.close();
}
