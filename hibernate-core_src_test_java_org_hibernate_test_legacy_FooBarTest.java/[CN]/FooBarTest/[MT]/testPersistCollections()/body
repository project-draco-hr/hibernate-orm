{
  Session s=openSession();
  Transaction txn=s.beginTransaction();
  assertEquals(0,((Long)s.createQuery("select count(*) from Bar").iterate().next()).longValue());
  assertTrue(s.createQuery("select count(*) from Bar b").iterate().next().equals(new Long(0)));
  assertFalse(s.createQuery("from Glarch g").iterate().hasNext());
  Baz baz=new Baz();
  s.save(baz);
  baz.setDefaults();
  baz.setStringArray(new String[]{"stuff"});
  Set bars=new HashSet();
  bars.add(new Bar());
  baz.setCascadingBars(bars);
  HashMap sgm=new HashMap();
  sgm.put("a",new Glarch());
  sgm.put("b",new Glarch());
  baz.setStringGlarchMap(sgm);
  txn.commit();
  s.close();
  s=openSession();
  txn=s.beginTransaction();
  assertEquals(1L,((Long)s.createQuery("select count(*) from Bar").iterate().next()).longValue());
  baz=(Baz)((Object[])s.createQuery("select baz, baz from Baz baz").list().get(0))[1];
  assertTrue(baz.getCascadingBars().size() == 1);
  Foo foo=new Foo();
  s.save(foo);
  Foo foo2=new Foo();
  s.save(foo2);
  baz.setFooArray(new Foo[]{foo,foo,null,foo2});
  baz.getFooSet().add(foo);
  baz.getCustoms().add(new String[]{"new","custom"});
  baz.setStringArray(null);
  baz.getStringList().set(0,"new value");
  baz.setStringSet(new TreeSet());
  Time time=new java.sql.Time(12345);
  baz.getTimeArray()[2]=time;
  assertTrue(baz.getStringGlarchMap().size() == 1);
  if (!(getDialect() instanceof MySQLDialect) && !(getDialect() instanceof HSQLDialect) && !(getDialect() instanceof PointbaseDialect)) {
    List list=s.createQuery("select foo from Foo foo, Baz baz where foo in elements(baz.fooArray) and 3 = some elements(baz.intArray) and 4 > all indices(baz.intArray)").list();
    assertTrue("collection.elements find",list.size() == 2);
  }
  if (!(getDialect() instanceof SAPDBDialect)) {
    List list=s.createQuery("select distinct foo from Baz baz join baz.fooArray foo").list();
    assertTrue("collection.elements find",list.size() == 2);
  }
  List list=s.createQuery("select foo from Baz baz join baz.fooSet foo").list();
  assertTrue("association.elements find",list.size() == 1);
  txn.commit();
  s.close();
  s=openSession();
  txn=s.beginTransaction();
  assertEquals(1,((Long)s.createQuery("select count(*) from Bar").iterate().next()).longValue());
  baz=(Baz)s.createQuery("select baz from Baz baz order by baz").list().get(0);
  assertTrue("collection of custom types - added element",baz.getCustoms().size() == 4 && baz.getCustoms().get(0) != null);
  assertTrue("component of component in collection",baz.getComponents()[1].getSubcomponent() != null);
  assertTrue(baz.getComponents()[1].getBaz() == baz);
  assertTrue("set of objects",((FooProxy)baz.getFooSet().iterator().next()).getKey().equals(foo.getKey()));
  assertTrue("collection removed",baz.getStringArray().length == 0);
  assertTrue("changed element",baz.getStringList().get(0).equals("new value"));
  assertTrue("replaced set",baz.getStringSet().size() == 0);
  assertTrue("array element change",baz.getTimeArray()[2] != null);
  assertTrue(baz.getCascadingBars().size() == 1);
  baz.getStringSet().add("two");
  baz.getStringSet().add("one");
  baz.getBag().add("three");
  txn.commit();
  s.close();
  s=openSession();
  txn=s.beginTransaction();
  baz=(Baz)s.createQuery("select baz from Baz baz order by baz").list().get(0);
  assertTrue(baz.getStringSet().size() == 2);
  assertTrue(baz.getStringSet().first().equals("one"));
  assertTrue(baz.getStringSet().last().equals("two"));
  assertTrue(baz.getBag().size() == 5);
  baz.getStringSet().remove("two");
  baz.getBag().remove("duplicate");
  txn.commit();
  s.close();
  s=openSession();
  txn=s.beginTransaction();
  assertEquals(1,((Long)s.createQuery("select count(*) from Bar").iterate().next()).longValue());
  baz=(Baz)s.load(Baz.class,baz.getCode());
  assertTrue(baz.getCascadingBars().size() == 1);
  Bar bar=new Bar();
  Bar bar2=new Bar();
  s.save(bar);
  s.save(bar2);
  baz.setTopFoos(new HashSet());
  baz.getTopFoos().add(bar);
  baz.getTopFoos().add(bar2);
  assertTrue(baz.getCascadingBars().size() == 1);
  baz.setTopGlarchez(new TreeMap());
  GlarchProxy g=new Glarch();
  s.save(g);
  baz.getTopGlarchez().put(new Character('G'),g);
  HashMap map=new HashMap();
  map.put(bar,g);
  map.put(bar2,g);
  baz.setFooToGlarch(map);
  map=new HashMap();
  map.put(new FooComponent("name",123,null,null),bar);
  map.put(new FooComponent("nameName",12,null,null),bar);
  baz.setFooComponentToFoo(map);
  map=new HashMap();
  map.put(bar,g);
  baz.setGlarchToFoo(map);
  txn.commit();
  s.close();
  s=openSession();
  txn=s.beginTransaction();
  baz=(Baz)s.createQuery("select baz from Baz baz order by baz").list().get(0);
  assertTrue(baz.getCascadingBars().size() == 1);
  Session s2=openSession();
  Transaction txn2=s2.beginTransaction();
  assertEquals(3,((Long)s2.createQuery("select count(*) from Bar").iterate().next()).longValue());
  Baz baz2=(Baz)s2.createQuery("select baz from Baz baz order by baz").list().get(0);
  Object o=baz2.getFooComponentToFoo().get(new FooComponent("name",123,null,null));
  assertTrue(o == baz2.getFooComponentToFoo().get(new FooComponent("nameName",12,null,null)) && o != null);
  txn2.commit();
  s2.close();
  assertTrue(Hibernate.isInitialized(baz.getFooToGlarch()));
  assertTrue(baz.getTopFoos().size() == 2);
  assertTrue(baz.getTopGlarchez().size() == 1);
  assertTrue(baz.getTopFoos().iterator().next() != null);
  assertTrue(baz.getStringSet().size() == 1);
  assertTrue(baz.getBag().size() == 4);
  assertTrue(baz.getFooToGlarch().size() == 2);
  assertTrue(baz.getFooComponentToFoo().size() == 2);
  assertTrue(baz.getGlarchToFoo().size() == 1);
  Iterator iter=baz.getFooToGlarch().keySet().iterator();
  for (int i=0; i < 2; i++)   assertTrue(iter.next() instanceof BarProxy);
  FooComponent fooComp=(FooComponent)baz.getFooComponentToFoo().keySet().iterator().next();
  assertTrue(((fooComp.getCount() == 123 && fooComp.getName().equals("name")) || (fooComp.getCount() == 12 && fooComp.getName().equals("nameName"))) && (baz.getFooComponentToFoo().get(fooComp) instanceof BarProxy));
  Glarch g2=new Glarch();
  s.save(g2);
  g=(GlarchProxy)baz.getTopGlarchez().get(new Character('G'));
  baz.getTopGlarchez().put(new Character('H'),g);
  baz.getTopGlarchez().put(new Character('G'),g2);
  txn.commit();
  s.close();
  s=openSession();
  txn=s.beginTransaction();
  baz=(Baz)s.load(Baz.class,baz.getCode());
  assertTrue(baz.getTopGlarchez().size() == 2);
  assertTrue(baz.getCascadingBars().size() == 1);
  txn.commit();
  s.close();
  s=openSession();
  txn=s.beginTransaction();
  assertEquals(3,((Long)s.createQuery("select count(*) from Bar").iterate().next()).longValue());
  baz=(Baz)s.createQuery("select baz from Baz baz order by baz").list().get(0);
  assertTrue(baz.getTopGlarchez().size() == 2);
  assertTrue(baz.getCascadingBars().size() == 1);
  txn.commit();
  final Session s3=(Session)SerializationHelper.deserialize(SerializationHelper.serialize(s));
  s.close();
  txn2=s3.beginTransaction();
  baz=(Baz)s3.load(Baz.class,baz.getCode());
  assertEquals(3,((Long)s3.createQuery("select count(*) from Bar").iterate().next()).longValue());
  s3.delete(baz);
  s3.delete(baz.getTopGlarchez().get(Character.valueOf('G')));
  s3.delete(baz.getTopGlarchez().get(Character.valueOf('H')));
  int rows=s3.doReturningWork(new AbstractReturningWork<Integer>(){
    @Override public Integer execute(    Connection connection) throws SQLException {
      final String sql="update " + getDialect().openQuote() + "glarchez"+ getDialect().closeQuote()+ " set baz_map_id=null where baz_map_index='a'";
      Statement st=connection.createStatement();
      return st.executeUpdate(sql);
    }
  }
);
  assertTrue(rows == 1);
  assertEquals(2,doDelete(s3,"from Bar bar"));
  FooProxy[] arr=baz.getFooArray();
  assertTrue("new array of objects",arr.length == 4 && arr[1].getKey().equals(foo.getKey()));
  for (int i=1; i < arr.length; i++) {
    if (arr[i] != null)     s3.delete(arr[i]);
  }
  s3.load(Qux.class,new Long(666));
  assertEquals(1,doDelete(s3,"from Glarch g"));
  txn2.commit();
  s3.disconnect();
  Session s4=(Session)SerializationHelper.deserialize(SerializationHelper.serialize(s3));
  s3.close();
  assertTrue(s4.load(Qux.class,new Long(666)) != null);
  s4.close();
}
