{
  Object currentRevisionData=getCurrentRevisionData(session,true);
  AuditWorkUnit vwu;
  while ((vwu=undoQueue.poll()) != null) {
    vwu.undo(session);
  }
  while ((vwu=workUnits.poll()) != null) {
    vwu.perform(session,revisionData);
    Serializable entityId=vwu.getEntityId();
    if (entityId instanceof PersistentCollectionChangeWorkUnit.PersistentCollectionChangeWorkUnitId) {
      entityId=((PersistentCollectionChangeWorkUnit.PersistentCollectionChangeWorkUnitId)entityId).getOwnerId();
    }
    Class entityClass=getEntityClass(this.session,session,vwu.getEntityName());
    revisionInfoGenerator.entityChanged(entityClass,vwu.getEntityName(),entityId,vwu.getRevisionType(),currentRevisionData);
  }
}
