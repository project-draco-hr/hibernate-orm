{
  if (workUnits.size() == 0 && undoQueue.size() == 0) {
    return;
  }
  try {
    if (FlushMode.isManualFlushMode(session.getFlushMode()) || session.isClosed()) {
      Session temporarySession=null;
      try {
        temporarySession=session.getFactory().openTemporarySession();
        executeInSession(temporarySession);
        temporarySession.flush();
      }
  finally {
        if (temporarySession != null) {
          temporarySession.close();
        }
      }
    }
 else {
      executeInSession(session);
      session.flush();
    }
  }
 catch (  RuntimeException e) {
    try {
      if (session.getTransaction().isActive()) {
        session.getTransaction().rollback();
      }
    }
  finally {
      throw e;
    }
  }
}
