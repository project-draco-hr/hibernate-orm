{
  final RowSelection selection=queryParameters.getRowSelection();
  final int maxRows=hasMaxRows(selection) ? selection.getMaxRows().intValue() : Integer.MAX_VALUE;
  final int entitySpan=getEntityPersisters().length;
  final ArrayList hydratedObjects=entitySpan == 0 ? null : new ArrayList(entitySpan * 10);
  final PreparedStatement st=prepareQueryStatement(queryParameters,false,session);
  final ResultSet rs=getResultSet(st,queryParameters.hasAutoDiscoverScalarTypes(),queryParameters.isCallable(),selection,session);
  final EntityKey optionalObjectKey=getOptionalObjectKey(queryParameters,session);
  final LockMode[] lockModesArray=getLockModes(queryParameters.getLockOptions());
  final boolean createSubselects=isSubselectLoadingEnabled();
  final List subselectResultKeys=createSubselects ? new ArrayList() : null;
  final List results=new ArrayList();
  try {
    handleEmptyCollections(queryParameters.getCollectionKeys(),rs,session);
    EntityKey[] keys=new EntityKey[entitySpan];
    if (LOG.isTraceEnabled()) {
      LOG.trace("Processing result set");
    }
    int count;
    for (count=0; count < maxRows && rs.next(); count++) {
      if (LOG.isDebugEnabled()) {
        LOG.debugf("Result set row: %s",count);
      }
      Object result=getRowFromResultSet(rs,session,queryParameters,lockModesArray,optionalObjectKey,hydratedObjects,keys,returnProxies,forcedResultTransformer);
      results.add(result);
      if (createSubselects) {
        subselectResultKeys.add(keys);
        keys=new EntityKey[entitySpan];
      }
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace("Done processing result set (" + count + " rows)");
    }
  }
  finally {
    st.close();
  }
  initializeEntitiesAndCollections(hydratedObjects,rs,session,queryParameters.isReadOnly(session));
  if (createSubselects)   createSubselects(subselectResultKeys,queryParameters,session);
  return results;
}
