{
  EntityPersister persister=session.getFactory().getEntityPersister(entity);
  CollectionPersister cp=session.getFactory().getCollectionPersister(entity + '.' + property);
  Object parent=parentsByChild.get(childEntity);
  if (parent != null) {
    final EntityEntry entityEntry=(EntityEntry)entityEntries.get(parent);
    if (persister.isSubclassEntityName(entityEntry.getEntityName())) {
      Object index=getIndexInParent(property,childEntity,persister,cp,parent);
      if (index == null && mergeMap != null) {
        Object unmergedInstance=mergeMap.get(parent);
        Object unmergedChild=mergeMap.get(childEntity);
        if (unmergedInstance != null && unmergedChild != null) {
          index=getIndexInParent(property,unmergedChild,persister,cp,unmergedInstance);
        }
      }
      if (index != null) {
        return index;
      }
    }
 else {
      parentsByChild.remove(childEntity);
    }
  }
  Iterator entities=IdentityMap.entries(entityEntries).iterator();
  while (entities.hasNext()) {
    Map.Entry me=(Map.Entry)entities.next();
    EntityEntry ee=(EntityEntry)me.getValue();
    if (persister.isSubclassEntityName(ee.getEntityName())) {
      Object instance=me.getKey();
      Object index=getIndexInParent(property,childEntity,persister,cp,instance);
      if (index == null && mergeMap != null) {
        Object unmergedInstance=mergeMap.get(instance);
        Object unmergedChild=mergeMap.get(childEntity);
        if (unmergedInstance != null && unmergedChild != null) {
          index=getIndexInParent(property,unmergedChild,persister,cp,unmergedInstance);
        }
      }
      if (index != null)       return index;
    }
  }
  return null;
}
