{
  boolean alreadyNarrow=persister.getConcreteProxyClass(session.getEntityMode()).isAssignableFrom(proxy.getClass());
  if (!alreadyNarrow) {
    if (PROXY_WARN_LOG.isWarnEnabled()) {
      PROXY_WARN_LOG.warn("Narrowing proxy to " + persister.getConcreteProxyClass(session.getEntityMode()) + " - this operation breaks ==");
    }
    if (object != null) {
      proxiesByKey.remove(key);
      return object;
    }
 else {
      proxy=persister.createProxy(key.getIdentifier(),session);
      Object proxyOrig=proxiesByKey.put(key,proxy);
      if (proxyOrig != null) {
        if (!(proxyOrig instanceof HibernateProxy)) {
          throw new AssertionFailure("proxy not of type HibernateProxy; it is " + proxyOrig.getClass());
        }
        boolean readOnlyOrig=((HibernateProxy)proxyOrig).getHibernateLazyInitializer().isReadOnly();
        ((HibernateProxy)proxy).getHibernateLazyInitializer().setReadOnly(readOnlyOrig);
      }
      return proxy;
    }
  }
 else {
    if (object != null) {
      LazyInitializer li=((HibernateProxy)proxy).getHibernateLazyInitializer();
      li.setImplementation(object);
    }
    return proxy;
  }
}
