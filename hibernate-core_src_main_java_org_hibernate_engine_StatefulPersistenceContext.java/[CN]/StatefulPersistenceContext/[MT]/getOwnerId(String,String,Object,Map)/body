{
  final String collectionRole=entityName + '.' + propertyName;
  final EntityPersister persister=session.getFactory().getEntityPersister(entityName);
  final CollectionPersister collectionPersister=session.getFactory().getCollectionPersister(collectionRole);
  Object parent=parentsByChild.get(childEntity);
  if (parent != null) {
    if (isFoundInParent(propertyName,childEntity,persister,collectionPersister,parent)) {
      return getEntry(parent).getId();
    }
 else {
      parentsByChild.remove(childEntity);
    }
  }
  Iterator entities=IdentityMap.entries(entityEntries).iterator();
  while (entities.hasNext()) {
    final Map.Entry me=(Map.Entry)entities.next();
    final EntityEntry entityEntry=(EntityEntry)me.getValue();
    if (persister.isSubclassEntityName(entityEntry.getEntityName())) {
      final Object entityEntryInstance=me.getKey();
      boolean found=isFoundInParent(propertyName,childEntity,persister,collectionPersister,entityEntryInstance);
      if (!found && mergeMap != null) {
        Object unmergedInstance=mergeMap.get(entityEntryInstance);
        Object unmergedChild=mergeMap.get(childEntity);
        if (unmergedInstance != null && unmergedChild != null) {
          found=isFoundInParent(propertyName,unmergedChild,persister,collectionPersister,unmergedInstance);
        }
      }
      if (found) {
        return entityEntry.getId();
      }
    }
  }
  if (mergeMap != null) {
    Iterator mergeMapItr=mergeMap.entrySet().iterator();
    while (mergeMapItr.hasNext()) {
      final Map.Entry mergeMapEntry=(Map.Entry)mergeMapItr.next();
      if (mergeMapEntry.getKey() instanceof HibernateProxy) {
        final HibernateProxy proxy=(HibernateProxy)mergeMapEntry.getKey();
        if (persister.isSubclassEntityName(proxy.getHibernateLazyInitializer().getEntityName())) {
          boolean found=isFoundInParent(propertyName,childEntity,persister,collectionPersister,mergeMap.get(proxy));
          if (!found) {
            found=isFoundInParent(propertyName,mergeMap.get(childEntity),persister,collectionPersister,mergeMap.get(proxy));
          }
          if (found) {
            return proxy.getHibernateLazyInitializer().getIdentifier();
          }
        }
      }
    }
  }
  return null;
}
