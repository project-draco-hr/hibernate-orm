{
  log.info("Running hbm2ddl schema export");
  Connection connection=null;
  Writer outputFileWriter=null;
  List<NamedReader> importFileReaders=new ArrayList<NamedReader>();
  Statement statement=null;
  exceptions.clear();
  try {
    for (    String currentFile : importFiles.split(",")) {
      try {
        final String resourceName=currentFile.trim();
        InputStream stream=ConfigHelper.getResourceAsStream(resourceName);
        importFileReaders.add(new NamedReader(resourceName,stream));
      }
 catch (      HibernateException e) {
        log.debug("import file not found: " + currentFile);
      }
    }
    if (outputFile != null) {
      log.info("writing generated schema to file: " + outputFile);
      outputFileWriter=new FileWriter(outputFile);
    }
    if (export) {
      log.info("exporting generated schema to database");
      connectionHelper.prepare(true);
      connection=connectionHelper.getConnection();
      statement=connection.createStatement();
    }
    if (!justCreate) {
      drop(script,export,outputFileWriter,statement);
    }
    if (!justDrop) {
      create(script,export,outputFileWriter,statement);
      if (export && importFileReaders.size() > 0) {
        for (        NamedReader reader : importFileReaders) {
          importScript(reader,statement);
        }
      }
    }
    log.info("schema export complete");
  }
 catch (  Exception e) {
    exceptions.add(e);
    log.error("schema export unsuccessful",e);
  }
 finally {
    try {
      if (statement != null) {
        statement.close();
      }
      if (connection != null) {
        connectionHelper.release();
      }
    }
 catch (    Exception e) {
      exceptions.add(e);
      log.error("Could not close connection",e);
    }
    try {
      if (outputFileWriter != null) {
        outputFileWriter.close();
      }
    }
 catch (    IOException ioe) {
      exceptions.add(ioe);
      log.error("Error closing output file: " + outputFile,ioe);
    }
    for (    NamedReader reader : importFileReaders) {
      try {
        reader.getReader().close();
      }
 catch (      IOException ioe) {
        exceptions.add(ioe);
        log.error("Error closing imput files: " + reader.getName(),ioe);
      }
    }
  }
}
