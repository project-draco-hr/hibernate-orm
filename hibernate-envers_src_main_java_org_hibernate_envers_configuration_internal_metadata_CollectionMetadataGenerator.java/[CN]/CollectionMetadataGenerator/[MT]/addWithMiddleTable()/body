{
  LOG.debugf("Adding audit mapping for property %s.%s: collection with a join table",referencingEntityName,propertyName);
  String auditMiddleTableName;
  String auditMiddleEntityName;
  if (!StringTools.isEmpty(propertyAuditingData.getJoinTable().name())) {
    auditMiddleTableName=propertyAuditingData.getJoinTable().name();
    auditMiddleEntityName=propertyAuditingData.getJoinTable().name();
  }
 else {
    final String middleTableName=getMiddleTableName(propertyValue,referencingEntityName);
    auditMiddleTableName=mainGenerator.getVerEntCfg().getAuditTableName(null,middleTableName);
    auditMiddleEntityName=mainGenerator.getVerEntCfg().getAuditEntityName(middleTableName);
  }
  LOG.debugf("Using join table name: %s",auditMiddleTableName);
  Element middleEntityXml;
  if (!propertyValue.isInverse()) {
    auditMiddleEntityName=mainGenerator.getAuditEntityNameRegister().createUnique(auditMiddleEntityName);
    mainGenerator.getAuditEntityNameRegister().register(auditMiddleEntityName);
    middleEntityXml=createMiddleEntityXml(auditMiddleTableName,auditMiddleEntityName,propertyValue.getWhere());
  }
 else {
    middleEntityXml=null;
  }
  final IdMappingData referencingIdMapping=referencingEntityConfiguration.getIdMappingData();
  String mappedBy;
  String referencingPrefixRelated;
  String referencedPrefix;
  if (propertyValue.isInverse()) {
    mappedBy=getMappedBy(propertyValue.getCollectionTable(),mainGenerator.getMetadata().getEntityBinding(referencedEntityName));
    referencingPrefixRelated=mappedBy + "_";
    referencedPrefix=StringTools.getLastComponent(referencedEntityName);
  }
 else {
    mappedBy=null;
    referencingPrefixRelated=StringTools.getLastComponent(referencingEntityName) + "_";
    referencedPrefix=referencedEntityName == null ? "element" : propertyName;
  }
  final MiddleIdData referencingIdData=createMiddleIdData(referencingIdMapping,referencingPrefixRelated,referencingEntityName);
  final QueryGeneratorBuilder queryGeneratorBuilder=new QueryGeneratorBuilder(mainGenerator.getGlobalCfg(),mainGenerator.getVerEntCfg(),mainGenerator.getAuditStrategy(),referencingIdData,auditMiddleEntityName,isEmbeddableElementType());
  if (middleEntityXml != null) {
    addRelatedToXmlMapping(middleEntityXml,referencingPrefixRelated,MetadataTools.getColumnNameIterator(propertyValue.getKey().getColumnIterator()),referencingIdMapping);
  }
  final MiddleComponentData elementComponentData=addValueToMiddleTable(propertyValue.getElement(),middleEntityXml,queryGeneratorBuilder,referencedPrefix,propertyAuditingData.getJoinTable().inverseJoinColumns());
  final MiddleComponentData indexComponentData=addIndex(middleEntityXml,queryGeneratorBuilder);
  final RelationQueryGenerator queryGenerator=queryGeneratorBuilder.build(elementComponentData,indexComponentData);
  final CommonCollectionMapperData commonCollectionMapperData=new CommonCollectionMapperData(mainGenerator.getVerEntCfg(),auditMiddleEntityName,propertyAuditingData.getPropertyData(),referencingIdData,queryGenerator);
  addMapper(commonCollectionMapperData,elementComponentData,indexComponentData);
  storeMiddleEntityRelationInformation(mappedBy);
}
