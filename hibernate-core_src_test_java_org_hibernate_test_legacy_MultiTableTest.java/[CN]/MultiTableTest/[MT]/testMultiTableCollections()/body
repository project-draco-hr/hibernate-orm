{
  Session s=openSession();
  Transaction t=s.beginTransaction();
  assertTrue(s.createQuery("from Top").list().size() == 0);
  Multi multi=new Multi();
  multi.setExtraProp("extra");
  multi.setName("name");
  Top simp=new Top();
  simp.setDate(new Date());
  simp.setName("simp");
  s.save(multi);
  s.save(simp);
  Lower ls=new Lower();
  ls.setOther(ls);
  ls.setAnother(ls);
  ls.setYetanother(ls);
  ls.setName("Less Simple");
  Set set=new HashSet();
  ls.setSet(set);
  set.add(multi);
  set.add(simp);
  Serializable id=s.save(ls);
  t.commit();
  s.close();
  assertTrue(ls.getOther() == ls && ls.getAnother() == ls && ls.getYetanother() == ls);
  s=openSession();
  t=s.beginTransaction();
  ls=(Lower)s.load(Lower.class,id);
  assertTrue(ls.getOther() == ls && ls.getAnother() == ls && ls.getYetanother() == ls);
  assertTrue(ls.getSet().size() == 2);
  Iterator iter=ls.getSet().iterator();
  int foundMulti=0;
  int foundSimple=0;
  while (iter.hasNext()) {
    Object o=iter.next();
    if (o instanceof Top)     foundSimple++;
    if (o instanceof Multi)     foundMulti++;
  }
  assertTrue(foundSimple == 2 && foundMulti == 1);
  t.commit();
  s.close();
  s=openSession();
  t=s.beginTransaction();
  try {
    ls=s.load(Lower.class,id);
    ls.setOther(null);
    ls.setAnother(null);
    ls.setYetanother(null);
    for (    Object o : ls.getSet()) {
      s.delete(o);
    }
    ls.getSet().clear();
    s.flush();
    s.delete(ls);
    t.commit();
  }
 catch (  Exception e) {
    t.rollback();
    throw e;
  }
 finally {
    s.close();
  }
}
