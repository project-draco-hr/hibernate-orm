{
  final String collectionRole=entityName + '.' + propertyName;
  final EntityPersister persister=session.getFactory().getMetamodel().entityPersister(entityName);
  final CollectionPersister collectionPersister=session.getFactory().getMetamodel().collectionPersister(collectionRole);
  final Object parent=parentsByChild.get(childEntity);
  if (parent != null) {
    final EntityEntry entityEntry=entityEntryContext.getEntityEntry(parent);
    if (persister.isSubclassEntityName(entityEntry.getEntityName()) && isFoundInParent(propertyName,childEntity,persister,collectionPersister,parent)) {
      return getEntry(parent).getId();
    }
 else {
      parentsByChild.remove(childEntity);
    }
  }
  for (  Entry<Object,EntityEntry> me : reentrantSafeEntityEntries()) {
    final EntityEntry entityEntry=me.getValue();
    if (persister.isSubclassEntityName(entityEntry.getEntityName())) {
      final Object entityEntryInstance=me.getKey();
      boolean found=isFoundInParent(propertyName,childEntity,persister,collectionPersister,entityEntryInstance);
      if (!found && mergeMap != null) {
        final Object unmergedInstance=mergeMap.get(entityEntryInstance);
        final Object unmergedChild=mergeMap.get(childEntity);
        if (unmergedInstance != null && unmergedChild != null) {
          found=isFoundInParent(propertyName,unmergedChild,persister,collectionPersister,unmergedInstance);
          LOG.debugf("Detached object being merged (corresponding with a managed entity) has a collection that [%s] the detached child.",(found ? "contains" : "does not contain"));
        }
      }
      if (found) {
        return entityEntry.getId();
      }
    }
  }
  if (mergeMap != null) {
    for (    Object o : mergeMap.entrySet()) {
      final Entry mergeMapEntry=(Entry)o;
      if (mergeMapEntry.getKey() instanceof HibernateProxy) {
        final HibernateProxy proxy=(HibernateProxy)mergeMapEntry.getKey();
        if (persister.isSubclassEntityName(proxy.getHibernateLazyInitializer().getEntityName())) {
          boolean found=isFoundInParent(propertyName,childEntity,persister,collectionPersister,mergeMap.get(proxy));
          LOG.debugf("Detached proxy being merged has a collection that [%s] the managed child.",(found ? "contains" : "does not contain"));
          if (!found) {
            found=isFoundInParent(propertyName,mergeMap.get(childEntity),persister,collectionPersister,mergeMap.get(proxy));
            LOG.debugf("Detached proxy being merged has a collection that [%s] the detached child being merged..",(found ? "contains" : "does not contain"));
          }
          if (found) {
            return proxy.getHibernateLazyInitializer().getIdentifier();
          }
        }
      }
    }
  }
  return null;
}
