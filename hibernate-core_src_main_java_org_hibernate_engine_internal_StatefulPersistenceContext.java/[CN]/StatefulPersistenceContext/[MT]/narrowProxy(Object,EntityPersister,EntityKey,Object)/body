{
  final Class concreteProxyClass=persister.getConcreteProxyClass();
  final boolean alreadyNarrow=concreteProxyClass.isAssignableFrom(proxy.getClass());
  if (!alreadyNarrow) {
    LOG.narrowingProxy(concreteProxyClass);
    if (object != null) {
      proxiesByKey.remove(key);
      return object;
    }
 else {
      proxy=persister.createProxy(key.getIdentifier(),session);
      final Object proxyOrig=proxiesByKey.put(key,proxy);
      if (proxyOrig != null) {
        if (!(proxyOrig instanceof HibernateProxy)) {
          throw new AssertionFailure("proxy not of type HibernateProxy; it is " + proxyOrig.getClass());
        }
        HibernateProxy originalHibernateProxy=(HibernateProxy)proxyOrig;
        HibernateProxy newHibernateProxy=(HibernateProxy)proxy;
        final boolean readOnlyOrig=originalHibernateProxy.getHibernateLazyInitializer().isReadOnly();
        newHibernateProxy.getHibernateLazyInitializer().setReadOnly(readOnlyOrig);
        if (!originalHibernateProxy.getHibernateLazyInitializer().isUninitialized()) {
          newHibernateProxy.getHibernateLazyInitializer().setImplementation(originalHibernateProxy.getHibernateLazyInitializer().getImplementation());
        }
      }
      return proxy;
    }
  }
 else {
    if (object != null) {
      final LazyInitializer li=((HibernateProxy)proxy).getHibernateLazyInitializer();
      li.setImplementation(object);
    }
    return proxy;
  }
}
