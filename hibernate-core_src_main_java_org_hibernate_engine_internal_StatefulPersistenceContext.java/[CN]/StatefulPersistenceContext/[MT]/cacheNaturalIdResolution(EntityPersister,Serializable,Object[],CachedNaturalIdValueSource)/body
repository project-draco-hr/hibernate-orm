{
  validateNaturalId(persister,naturalIdValues);
  NaturalIdResolutionCache entityNaturalIdResolutionCache=naturalIdResolutionCacheMap.get(persister);
  if (entityNaturalIdResolutionCache == null) {
    entityNaturalIdResolutionCache=new NaturalIdResolutionCache(persister);
    naturalIdResolutionCacheMap.put(persister,entityNaturalIdResolutionCache);
  }
  final LocalNaturalIdCacheKey localNaturalIdCacheKey=new LocalNaturalIdCacheKey(persister,naturalIdValues);
  entityNaturalIdResolutionCache.pkToNaturalIdMap.put(pk,localNaturalIdCacheKey);
  entityNaturalIdResolutionCache.naturalIdToPkMap.put(localNaturalIdCacheKey,pk);
  if (persister.hasNaturalIdCache()) {
    final NaturalIdRegionAccessStrategy naturalIdCacheAccessStrategy=persister.getNaturalIdCacheAccessStrategy();
    final NaturalIdCacheKey naturalIdCacheKey=new NaturalIdCacheKey(naturalIdValues,persister,session);
    final SessionFactoryImplementor factory=getSession().getFactory();
switch (valueSource) {
case LOAD:
{
        final boolean put=naturalIdCacheAccessStrategy.putFromLoad(naturalIdCacheKey,pk,session.getTimestamp(),null);
        if (put && factory.getStatistics().isStatisticsEnabled()) {
          factory.getStatisticsImplementor().naturalIdCachePut(naturalIdCacheAccessStrategy.getRegion().getName());
        }
        break;
      }
case INSERT:
{
      naturalIdCacheAccessStrategy.insert(naturalIdCacheKey,pk);
      ((EventSource)this.session).getActionQueue().registerProcess(new AfterTransactionCompletionProcess(){
        @Override public void doAfterTransactionCompletion(        boolean success,        SessionImplementor session){
          final boolean put=naturalIdCacheAccessStrategy.afterInsert(naturalIdCacheKey,pk);
          if (put && factory.getStatistics().isStatisticsEnabled()) {
            factory.getStatisticsImplementor().naturalIdCachePut(naturalIdCacheAccessStrategy.getRegion().getName());
          }
        }
      }
);
      break;
    }
case UPDATE:
{
    final SoftLock lock=naturalIdCacheAccessStrategy.lockItem(naturalIdCacheKey,null);
    naturalIdCacheAccessStrategy.update(naturalIdCacheKey,pk);
    ((EventSource)this.session).getActionQueue().registerProcess(new AfterTransactionCompletionProcess(){
      @Override public void doAfterTransactionCompletion(      boolean success,      SessionImplementor session){
        final boolean put=naturalIdCacheAccessStrategy.afterUpdate(naturalIdCacheKey,pk,lock);
        if (put && factory.getStatistics().isStatisticsEnabled()) {
          factory.getStatisticsImplementor().naturalIdCachePut(naturalIdCacheAccessStrategy.getRegion().getName());
        }
      }
    }
);
    break;
  }
}
}
}
