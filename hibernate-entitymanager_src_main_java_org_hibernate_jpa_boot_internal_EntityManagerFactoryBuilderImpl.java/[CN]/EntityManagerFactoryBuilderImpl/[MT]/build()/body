{
  if (validatorFactory != null) {
    configurationValues.put(AvailableSettings.VALIDATION_FACTORY,validatorFactory);
  }
  final Object validationFactory=configurationValues.get(AvailableSettings.VALIDATION_FACTORY);
  if (validationFactory != null) {
    BeanValidationIntegrator.validateFactory(validationFactory);
  }
  final ServiceRegistry serviceRegistry=buildServiceRegistry();
  final ClassLoaderService classLoaderService=serviceRegistry.getService(ClassLoaderService.class);
  return ((ClassLoaderServiceImpl)classLoaderService).withTccl(new ClassLoaderServiceImpl.Work<EntityManagerFactoryImpl>(){
    @Override public EntityManagerFactoryImpl perform(){
      hibernateConfiguration=buildHibernateConfiguration(serviceRegistry);
      SessionFactoryImplementor sessionFactory;
      try {
        sessionFactory=(SessionFactoryImplementor)hibernateConfiguration.buildSessionFactory(serviceRegistry);
      }
 catch (      MappingException e) {
        throw persistenceException("Unable to build Hibernate SessionFactory",e);
      }
      if (suppliedSessionFactoryObserver != null) {
        sessionFactory.addObserver(suppliedSessionFactoryObserver);
      }
      sessionFactory.addObserver(new ServiceRegistryCloser());
      return new EntityManagerFactoryImpl(persistenceUnit.getName(),sessionFactory,settings,configurationValues,hibernateConfiguration);
    }
  }
);
}
