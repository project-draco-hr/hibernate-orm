{
  LogHelper.logPersistenceUnitInformation(persistenceUnit);
  this.persistenceUnit=persistenceUnit;
  if (integrationSettings == null) {
    integrationSettings=Collections.emptyMap();
  }
  final BootstrapServiceRegistry bsr=buildBootstrapServiceRegistry(integrationSettings,providedClassLoader);
  final StandardServiceRegistryBuilder ssrBuilder=new StandardServiceRegistryBuilder(bsr);
  final MergedSettings mergedSettings=mergeSettings(persistenceUnit,integrationSettings,ssrBuilder);
  this.configurationValues=mergedSettings.getConfigurationValues();
  ssrBuilder.applySettings(configurationValues);
  this.settings=configure(ssrBuilder);
  this.standardServiceRegistry=ssrBuilder.build();
  configure(standardServiceRegistry,mergedSettings);
  final MetadataSources metadataSources=new MetadataSources(bsr);
  List<AttributeConverterDefinition> attributeConverterDefinitions=populate(metadataSources,mergedSettings,standardServiceRegistry);
  this.metamodelBuilder=(MetadataBuilderImplementor)metadataSources.getMetadataBuilder(standardServiceRegistry);
  populate(metamodelBuilder,mergedSettings,standardServiceRegistry,attributeConverterDefinitions);
  final CfgXmlAccessService cfgXmlAccessService=standardServiceRegistry.getService(CfgXmlAccessService.class);
  if (cfgXmlAccessService.getAggregatedConfig() != null) {
    if (cfgXmlAccessService.getAggregatedConfig().getMappingReferences() != null) {
      for (      MappingReference mappingReference : cfgXmlAccessService.getAggregatedConfig().getMappingReferences()) {
        mappingReference.apply(metadataSources);
      }
    }
  }
  this.managedResources=MetadataBuildingProcess.prepare(metadataSources,metamodelBuilder.getMetadataBuildingOptions());
  withValidatorFactory(configurationValues.get(AvailableSettings.VALIDATION_FACTORY));
  final boolean useClassTransformer="true".equals(configurationValues.remove(AvailableSettings.USE_CLASS_ENHANCER));
  if (useClassTransformer) {
    persistenceUnit.pushClassTransformer(managedResources.getAnnotatedClassNames());
  }
  metamodelBuilder.applyTempClassLoader(null);
}
