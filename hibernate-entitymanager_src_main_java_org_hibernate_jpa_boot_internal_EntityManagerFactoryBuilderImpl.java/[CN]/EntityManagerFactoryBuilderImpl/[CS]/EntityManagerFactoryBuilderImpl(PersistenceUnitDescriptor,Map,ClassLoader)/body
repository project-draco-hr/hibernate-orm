{
  LogHelper.logPersistenceUnitInformation(persistenceUnit);
  this.persistenceUnit=persistenceUnit;
  if (integrationSettings == null) {
    integrationSettings=Collections.emptyMap();
  }
  this.providedClassLoader=providedClassLoader;
  final BootstrapServiceRegistry bootstrapServiceRegistry=buildBootstrapServiceRegistry(integrationSettings);
  this.serviceRegistryBuilder=new StandardServiceRegistryBuilder(bootstrapServiceRegistry);
  this.configurationValues=mergePropertySources(persistenceUnit,integrationSettings,bootstrapServiceRegistry);
  this.serviceRegistryBuilder.applySettings(configurationValues);
  final ScanResult scanResult=scan(bootstrapServiceRegistry);
  final DeploymentResources deploymentResources=buildDeploymentResources(scanResult,bootstrapServiceRegistry);
  final IndexView jandexIndex=locateOrBuildJandexIndex(deploymentResources);
  metadataSources=prepareMetadataSources(jandexIndex,deploymentResources,bootstrapServiceRegistry);
  withValidatorFactory(configurationValues.get(AvailableSettings.VALIDATION_FACTORY));
  final boolean useClassTransformer="true".equals(configurationValues.remove(AvailableSettings.USE_CLASS_ENHANCER));
  if (useClassTransformer) {
    persistenceUnit.pushClassTransformer(metadataSources.collectMappingClassNames());
  }
}
