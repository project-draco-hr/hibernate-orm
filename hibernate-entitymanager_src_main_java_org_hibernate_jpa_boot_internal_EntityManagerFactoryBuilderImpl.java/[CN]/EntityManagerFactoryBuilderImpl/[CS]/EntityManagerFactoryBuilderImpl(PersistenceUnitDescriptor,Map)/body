{
  LogHelper.logPersistenceUnitInformation(persistenceUnit);
  this.persistenceUnit=persistenceUnit;
  if (integrationSettings == null) {
    integrationSettings=Collections.emptyMap();
  }
  final BootstrapServiceRegistry bootstrapServiceRegistry=buildBootstrapServiceRegistry(integrationSettings);
  this.serviceRegistryBuilder=new ServiceRegistryBuilder(bootstrapServiceRegistry);
  this.configurationValues=mergePropertySources(persistenceUnit,integrationSettings,bootstrapServiceRegistry);
  this.serviceRegistryBuilder.applySettings(configurationValues);
  processProperties(bootstrapServiceRegistry);
  ScanResult scanResult=scan(bootstrapServiceRegistry);
  Set<String> collectedManagedClassNames=collectManagedClassNames(scanResult);
  IndexResult jandexIndex=locateOrBuildJandexIndex(collectedManagedClassNames,scanResult.getPackageNames(),bootstrapServiceRegistry);
  metadataSources=prepareMetadataSources(jandexIndex,collectedManagedClassNames,scanResult,bootstrapServiceRegistry);
  final boolean useClassTransformer="true".equals(configurationValues.remove(AvailableSettings.USE_CLASS_ENHANCER));
  if (useClassTransformer) {
    persistenceUnit.pushClassTransformer(metadataSources.collectMappingClassNames());
  }
}
