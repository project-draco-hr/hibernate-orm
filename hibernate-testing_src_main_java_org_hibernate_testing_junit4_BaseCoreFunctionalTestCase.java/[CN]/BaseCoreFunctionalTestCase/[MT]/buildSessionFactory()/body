{
  configuration=constructAndConfigureConfiguration();
  serviceRegistry=buildServiceRegistry(configuration);
  isMetadataUsed=serviceRegistry.getService(ConfigurationService.class).getSetting(USE_NEW_METADATA_MAPPINGS,new ConfigurationService.Converter<Boolean>(){
    @Override public Boolean convert(    Object value){
      return Boolean.parseBoolean((String)value);
    }
  }
,false);
  if (isMetadataUsed) {
    sessionFactory=(SessionFactoryImplementor)buildMetadata(serviceRegistry).buildSessionFactory();
  }
 else {
    afterConstructAndConfigureConfiguration(configuration);
    sessionFactory=(SessionFactoryImplementor)configuration.buildSessionFactory(serviceRegistry);
  }
  afterSessionFactoryBuilt();
}
