{
  InheritanceState inheritanceState=inheritanceStatePerClass.get(clazzToProcess);
  AnnotatedClassType classType=mappings.getClassType(clazzToProcess);
  if (AnnotatedClassType.EMBEDDABLE_SUPERCLASS.equals(classType)) {
    bindQueries(clazzToProcess,mappings);
    bindTypeDefs(clazzToProcess,mappings);
    bindFilterDefs(clazzToProcess,mappings);
  }
  if (!isEntityClassType(clazzToProcess,classType)) {
    return;
  }
  log.info("Binding entity from annotated class: {}",clazzToProcess.getName());
  PersistentClass superEntity=getSuperEntity(clazzToProcess,inheritanceStatePerClass,mappings,inheritanceState);
  bindQueries(clazzToProcess,mappings);
  bindFilterDefs(clazzToProcess,mappings);
  bindTypeDefs(clazzToProcess,mappings);
  BinderHelper.bindAnyMetaDefs(clazzToProcess,mappings);
  String schema="";
  String table="";
  String catalog="";
  List<UniqueConstraintHolder> uniqueConstraints=new ArrayList<UniqueConstraintHolder>();
  if (clazzToProcess.isAnnotationPresent(javax.persistence.Table.class)) {
    javax.persistence.Table tabAnn=clazzToProcess.getAnnotation(javax.persistence.Table.class);
    table=tabAnn.name();
    schema=tabAnn.schema();
    catalog=tabAnn.catalog();
    uniqueConstraints=TableBinder.buildUniqueConstraintHolders(tabAnn.uniqueConstraints());
  }
  Ejb3JoinColumn[] inheritanceJoinedColumns=makeInheritanceJoinColumns(clazzToProcess,mappings,inheritanceState,superEntity);
  Ejb3DiscriminatorColumn discriminatorColumn=null;
  String discrimValue=null;
  if (InheritanceType.SINGLE_TABLE.equals(inheritanceState.getType())) {
    javax.persistence.DiscriminatorColumn discAnn=clazzToProcess.getAnnotation(javax.persistence.DiscriminatorColumn.class);
    DiscriminatorType discriminatorType=discAnn != null ? discAnn.discriminatorType() : DiscriminatorType.STRING;
    org.hibernate.annotations.DiscriminatorFormula discFormulaAnn=clazzToProcess.getAnnotation(org.hibernate.annotations.DiscriminatorFormula.class);
    if (!inheritanceState.hasParents()) {
      discriminatorColumn=Ejb3DiscriminatorColumn.buildDiscriminatorColumn(discriminatorType,discAnn,discFormulaAnn,mappings);
    }
    if (discAnn != null && inheritanceState.hasParents()) {
      log.warn("Discriminator column has to be defined in the root entity, it will be ignored in subclass: {}",clazzToProcess.getName());
    }
    discrimValue=clazzToProcess.isAnnotationPresent(DiscriminatorValue.class) ? clazzToProcess.getAnnotation(DiscriminatorValue.class).value() : null;
  }
  PersistentClass persistentClass=makePersistentClass(inheritanceState,superEntity);
  Proxy proxyAnn=clazzToProcess.getAnnotation(Proxy.class);
  BatchSize sizeAnn=clazzToProcess.getAnnotation(BatchSize.class);
  Where whereAnn=clazzToProcess.getAnnotation(Where.class);
  Entity entityAnn=clazzToProcess.getAnnotation(Entity.class);
  org.hibernate.annotations.Entity hibEntityAnn=clazzToProcess.getAnnotation(org.hibernate.annotations.Entity.class);
  org.hibernate.annotations.Cache cacheAnn=clazzToProcess.getAnnotation(org.hibernate.annotations.Cache.class);
  EntityBinder entityBinder=new EntityBinder(entityAnn,hibEntityAnn,clazzToProcess,persistentClass,mappings);
  entityBinder.setDiscriminatorValue(discrimValue);
  entityBinder.setBatchSize(sizeAnn);
  entityBinder.setProxy(proxyAnn);
  entityBinder.setWhere(whereAnn);
  entityBinder.setCache(cacheAnn);
  entityBinder.setInheritanceState(inheritanceState);
  if (!inheritanceState.hasParents()) {
    bindFilters(clazzToProcess,entityBinder,mappings);
  }
  entityBinder.bindEntity();
  if (inheritanceState.hasTable()) {
    Check checkAnn=clazzToProcess.getAnnotation(Check.class);
    String constraints=checkAnn == null ? null : checkAnn.constraints();
    entityBinder.bindTable(schema,catalog,table,uniqueConstraints,constraints,inheritanceState.hasDenormalizedTable() ? superEntity.getTable() : null);
  }
 else {
    if (clazzToProcess.isAnnotationPresent(Table.class)) {
      log.warn("Illegal use of @Table in a subclass of a SINGLE_TABLE hierarchy: " + clazzToProcess.getName());
    }
  }
  PropertyHolder propertyHolder=PropertyHolderBuilder.buildPropertyHolder(clazzToProcess,persistentClass,entityBinder,mappings,inheritanceStatePerClass);
  javax.persistence.SecondaryTable secTabAnn=clazzToProcess.getAnnotation(javax.persistence.SecondaryTable.class);
  javax.persistence.SecondaryTables secTabsAnn=clazzToProcess.getAnnotation(javax.persistence.SecondaryTables.class);
  entityBinder.firstLevelSecondaryTablesBinding(secTabAnn,secTabsAnn);
  OnDelete onDeleteAnn=clazzToProcess.getAnnotation(OnDelete.class);
  boolean onDeleteAppropriate=false;
  if (InheritanceType.JOINED.equals(inheritanceState.getType()) && inheritanceState.hasParents()) {
    onDeleteAppropriate=true;
    final JoinedSubclass jsc=(JoinedSubclass)persistentClass;
    if (persistentClass.getEntityPersisterClass() == null) {
      persistentClass.getRootClass().setEntityPersisterClass(JoinedSubclassEntityPersister.class);
    }
    SimpleValue key=new DependantValue(jsc.getTable(),jsc.getIdentifier());
    jsc.setKey(key);
    ForeignKey fk=clazzToProcess.getAnnotation(ForeignKey.class);
    if (fk != null && !BinderHelper.isDefault(fk.name())) {
      key.setForeignKeyName(fk.name());
    }
    if (onDeleteAnn != null) {
      key.setCascadeDeleteEnabled(OnDeleteAction.CASCADE.equals(onDeleteAnn.action()));
    }
 else {
      key.setCascadeDeleteEnabled(false);
    }
    SecondPass sp=new JoinedSubclassFkSecondPass(jsc,inheritanceJoinedColumns,key,mappings);
    mappings.addSecondPass(sp);
    mappings.addSecondPass(new CreateKeySecondPass(jsc));
  }
 else   if (InheritanceType.SINGLE_TABLE.equals(inheritanceState.getType())) {
    if (inheritanceState.hasParents()) {
      if (persistentClass.getEntityPersisterClass() == null) {
        persistentClass.getRootClass().setEntityPersisterClass(SingleTableEntityPersister.class);
      }
    }
 else {
      if (inheritanceState.hasSiblings() || !discriminatorColumn.isImplicit()) {
        bindDiscriminatorToPersistentClass((RootClass)persistentClass,discriminatorColumn,entityBinder.getSecondaryTables(),propertyHolder);
        entityBinder.bindDiscriminatorValue();
      }
    }
  }
 else   if (InheritanceType.TABLE_PER_CLASS.equals(inheritanceState.getType())) {
    if (inheritanceState.hasParents()) {
      if (persistentClass.getEntityPersisterClass() == null) {
        persistentClass.getRootClass().setEntityPersisterClass(UnionSubclassEntityPersister.class);
      }
    }
  }
  if (onDeleteAnn != null && !onDeleteAppropriate) {
    log.warn("Inapropriate use of @OnDelete on entity, annotation ignored: {}",propertyHolder.getEntityName());
  }
  HashMap<String,IdGenerator> classGenerators=buildLocalGenerators(clazzToProcess,mappings);
  List<PropertyData> elements=getElementsToProcess(persistentClass,clazzToProcess,inheritanceStatePerClass,entityBinder,mappings);
  if (elements == null) {
    throw new AnnotationException("No identifier specified for entity: " + propertyHolder.getEntityName());
  }
  final boolean subclassAndSingleTableStrategy=inheritanceState.getType() == InheritanceType.SINGLE_TABLE && inheritanceState.hasParents();
  Set<String> idProperties=new HashSet<String>();
  IdClass idClass=null;
  XClass current=null;
  if (!inheritanceState.hasParents()) {
    InheritanceState state=inheritanceState;
    do {
      current=state.getClazz();
      if (current.isAnnotationPresent(IdClass.class)) {
        idClass=current.getAnnotation(IdClass.class);
        break;
      }
      state=InheritanceState.getSuperclassInheritanceState(current,inheritanceStatePerClass,mappings.getReflectionManager());
    }
 while (state != null);
  }
  if (idClass != null) {
    XClass compositeClass=mappings.getReflectionManager().toXClass(idClass.value());
    boolean isComponent=true;
    AccessType propertyAccessor=entityBinder.getPropertyAccessor(compositeClass);
    String generatorType="assigned";
    String generator=BinderHelper.ANNOTATION_STRING_DEFAULT;
    PropertyData inferredData=new PropertyPreloadedData(entityBinder.getPropertyAccessor(),"id",compositeClass);
    PropertyData baseInferredData=new PropertyPreloadedData(entityBinder.getPropertyAccessor(),"id",current);
    HashMap<String,IdGenerator> localGenerators=new HashMap<String,IdGenerator>();
    boolean ignoreIdAnnotations=entityBinder.isIgnoreIdAnnotations();
    entityBinder.setIgnoreIdAnnotations(true);
    bindId(generatorType,generator,inferredData,baseInferredData,null,propertyHolder,localGenerators,isComponent,propertyAccessor,entityBinder,true,false,mappings,inheritanceStatePerClass);
    inferredData=new PropertyPreloadedData(propertyAccessor,"_identifierMapper",compositeClass);
    Component mapper=fillComponent(propertyHolder,inferredData,baseInferredData,propertyAccessor,false,entityBinder,true,true,false,mappings,inheritanceStatePerClass);
    entityBinder.setIgnoreIdAnnotations(ignoreIdAnnotations);
    persistentClass.setIdentifierMapper(mapper);
    final org.hibernate.mapping.MappedSuperclass superclass=BinderHelper.getMappedSuperclassOrNull(inferredData.getDeclaringClass(),inheritanceStatePerClass,mappings);
    if (superclass != null) {
      superclass.setDeclaredIdentifierMapper(mapper);
    }
 else {
      persistentClass.setDeclaredIdentifierMapper(mapper);
    }
    Property property=new Property();
    property.setName("_identifierMapper");
    property.setNodeName("id");
    property.setUpdateable(false);
    property.setInsertable(false);
    property.setValue(mapper);
    property.setPropertyAccessorName("embedded");
    persistentClass.addProperty(property);
    entityBinder.setIgnoreIdAnnotations(true);
    Iterator properties=mapper.getPropertyIterator();
    while (properties.hasNext()) {
      idProperties.add(((Property)properties.next()).getName());
    }
  }
  Set<String> missingIdProperties=new HashSet<String>(idProperties);
  for (  PropertyData propertyAnnotatedElement : elements) {
    String propertyName=propertyAnnotatedElement.getPropertyName();
    if (!idProperties.contains(propertyName)) {
      processElementAnnotations(propertyHolder,subclassAndSingleTableStrategy ? Nullability.FORCED_NULL : Nullability.NO_CONSTRAINT,propertyAnnotatedElement.getProperty(),propertyAnnotatedElement,classGenerators,entityBinder,false,false,false,mappings,inheritanceStatePerClass);
    }
 else {
      missingIdProperties.remove(propertyName);
    }
  }
  if (missingIdProperties.size() != 0) {
    StringBuilder missings=new StringBuilder();
    for (    String property : missingIdProperties) {
      missings.append(property).append(", ");
    }
    throw new AnnotationException("Unable to find properties (" + missings.substring(0,missings.length() - 2) + ") in entity annotated with @IdClass:"+ persistentClass.getEntityName());
  }
  if (!inheritanceState.hasParents()) {
    final RootClass rootClass=(RootClass)persistentClass;
    mappings.addSecondPass(new CreateKeySecondPass(rootClass));
  }
 else {
    superEntity.addSubclass((Subclass)persistentClass);
  }
  mappings.addClass(persistentClass);
  mappings.addSecondPass(new SecondaryTableSecondPass(entityBinder,propertyHolder,clazzToProcess));
  entityBinder.processComplementaryTableDefinitions(clazzToProcess.getAnnotation(org.hibernate.annotations.Table.class));
  entityBinder.processComplementaryTableDefinitions(clazzToProcess.getAnnotation(org.hibernate.annotations.Tables.class));
}
