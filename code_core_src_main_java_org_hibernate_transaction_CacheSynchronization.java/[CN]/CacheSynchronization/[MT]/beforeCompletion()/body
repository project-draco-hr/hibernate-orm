{
  log.trace("transaction before completion callback");
  boolean flush;
  try {
    flush=!ctx.isFlushModeNever() && ctx.isFlushBeforeCompletionEnabled() && !JTAHelper.isRollback(transaction.getStatus());
  }
 catch (  SystemException se) {
    log.error("could not determine transaction status",se);
    setRollbackOnly();
    throw new TransactionException("could not determine transaction status in beforeCompletion()",se);
  }
  try {
    if (flush) {
      log.trace("automatically flushing session");
      ctx.managedFlush();
    }
  }
 catch (  RuntimeException re) {
    setRollbackOnly();
    throw re;
  }
 finally {
    jdbcContext.beforeTransactionCompletion(hibernateTransaction);
  }
}
