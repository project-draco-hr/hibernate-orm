{
  final boolean[] tableUpdateNeeded=getTableUpdateNeeded(dirtyFields,hasDirtyCollection);
  final int span=getTableSpan();
  final boolean[] propsToUpdate;
  final String[] updateStrings;
  EntityEntry entry=session.getPersistenceContext().getEntry(object);
  if (entry == null && !isMutable()) {
    throw new IllegalStateException("Updating immutable entity that is not in session yet!");
  }
  if (entry != null && !isModifiableEntity(entry) && entry.getStatus() != Status.DELETED) {
    throw new IllegalStateException("Updating non-modifiable entity that is not being deleted!");
  }
  if ((entityMetamodel.isDynamicUpdate() || !isModifiableEntity(entry)) && dirtyFields != null) {
    propsToUpdate=getPropertiesToUpdate(dirtyFields,hasDirtyCollection);
    updateStrings=new String[span];
    for (int j=0; j < span; j++) {
      updateStrings[j]=tableUpdateNeeded[j] ? generateUpdateString(propsToUpdate,j,oldFields,j == 0 && rowId != null) : null;
    }
  }
 else {
    updateStrings=getUpdateStrings(rowId != null,hasUninitializedLazyProperties(object,session.getEntityMode()));
    propsToUpdate=getPropertyUpdateability(object,session.getEntityMode());
  }
  for (int j=0; j < span; j++) {
    if (tableUpdateNeeded[j]) {
      updateOrInsert(id,fields,oldFields,j == 0 ? rowId : null,propsToUpdate,j,oldVersion,object,updateStrings[j],session);
    }
  }
}
