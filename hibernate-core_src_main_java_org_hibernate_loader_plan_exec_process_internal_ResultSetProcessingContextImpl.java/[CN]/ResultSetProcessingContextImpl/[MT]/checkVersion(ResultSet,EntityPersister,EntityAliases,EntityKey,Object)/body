{
  final Object version=session.getPersistenceContext().getEntry(entityInstance).getVersion();
  if (version != null) {
    VersionType versionType=persister.getVersionType();
    final Object currentVersion;
    try {
      currentVersion=versionType.nullSafeGet(resultSet,entityAliases.getSuffixedVersionAliases(),session,null);
    }
 catch (    SQLException e) {
      throw getSession().getFactory().getJdbcServices().getSqlExceptionHelper().convert(e,"Could not read version value from result set");
    }
    if (!versionType.isEqual(version,currentVersion)) {
      if (session.getFactory().getStatistics().isStatisticsEnabled()) {
        session.getFactory().getStatisticsImplementor().optimisticFailure(persister.getEntityName());
      }
      throw new StaleObjectStateException(persister.getEntityName(),entityKey.getIdentifier());
    }
  }
}
