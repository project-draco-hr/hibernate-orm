{
  SessionFactoryImplementor sfi=(SessionFactoryImplementor)getEntityManagerFactory().getSessionFactory();
  TransactionManager tm=sfi.getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager();
  Session s;
  if (!JtaStatusHelper.isActive(tm)) {
    s=sfi.openTemporarySession();
    ((SessionImplementor)s).setAutoClear(true);
  }
 else {
    s=sfi.getCurrentSession();
  }
  return s;
}
