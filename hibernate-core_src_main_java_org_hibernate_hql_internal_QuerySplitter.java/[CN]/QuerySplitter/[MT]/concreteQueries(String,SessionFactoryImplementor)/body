{
  String[] tokens=StringHelper.split(StringHelper.WHITESPACE + "(),",query,true);
  if (tokens.length == 0) {
    return new String[]{query};
  }
  ArrayList<String> placeholders=new ArrayList<String>();
  ArrayList<String[]> replacements=new ArrayList<String[]>();
  StringBuilder templateQuery=new StringBuilder(40);
  int start=getStartingPositionFor(tokens,templateQuery);
  int count=0;
  String next;
  String last=tokens[start - 1].toLowerCase(Locale.ROOT);
  boolean inQuote=false;
  for (int i=start; i < tokens.length; i++) {
    String token=tokens[i];
    if (ParserHelper.isWhitespace(token)) {
      templateQuery.append(token);
      continue;
    }
 else     if (isQuoteCharacter(token)) {
      inQuote=!inQuote;
      templateQuery.append(token);
      continue;
    }
 else     if (isTokenStartWithAQuoteCharacter(token)) {
      if (!isTokenEndWithAQuoteCharacter(token)) {
        inQuote=true;
      }
      templateQuery.append(token);
      continue;
    }
 else     if (isTokenEndWithAQuoteCharacter(token)) {
      inQuote=false;
      templateQuery.append(token);
      continue;
    }
 else     if (inQuote) {
      templateQuery.append(token);
      continue;
    }
    next=nextNonWhite(tokens,i).toLowerCase(Locale.ROOT);
    boolean process=isJavaIdentifier(token) && isPossiblyClassName(last,next);
    last=token.toLowerCase(Locale.ROOT);
    if (process) {
      String importedClassName=getImportedClass(token,factory);
      if (importedClassName != null) {
        String[] implementors=factory.getImplementors(importedClassName);
        token="$clazz" + count++ + "$";
        if (implementors != null) {
          placeholders.add(token);
          replacements.add(implementors);
        }
      }
    }
    templateQuery.append(token);
  }
  String[] results=StringHelper.multiply(templateQuery.toString(),placeholders.iterator(),replacements.iterator());
  if (results.length == 0) {
    LOG.noPersistentClassesFound(query);
  }
  return results;
}
