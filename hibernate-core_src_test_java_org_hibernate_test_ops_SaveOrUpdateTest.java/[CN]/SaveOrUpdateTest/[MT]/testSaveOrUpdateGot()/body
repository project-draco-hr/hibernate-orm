{
  boolean instrumented=FieldInterceptionHelper.isInstrumented(new NumberedNode());
  Session s=openSession();
  Transaction tx=s.beginTransaction();
  NumberedNode root=new NumberedNode("root");
  s.saveOrUpdate(root);
  tx.commit();
  s.close();
  assertInsertCount(1);
  assertUpdateCount(0);
  clearCounts();
  s=openSession();
  tx=s.beginTransaction();
  s.saveOrUpdate(root);
  tx.commit();
  s.close();
  assertInsertCount(0);
  assertUpdateCount(instrumented ? 0 : 1);
  s=openSession();
  tx=s.beginTransaction();
  root=(NumberedNode)s.get(NumberedNode.class,new Long(root.getId()));
  Hibernate.initialize(root.getChildren());
  tx.commit();
  s.close();
  clearCounts();
  s=openSession();
  tx=s.beginTransaction();
  NumberedNode child=new NumberedNode("child");
  root.addChild(child);
  s.saveOrUpdate(root);
  assertTrue(s.contains(child));
  tx.commit();
  assertInsertCount(1);
  assertUpdateCount(instrumented ? 0 : 1);
  tx=s.beginTransaction();
  assertEquals(s.createCriteria(NumberedNode.class).setProjection(Projections.rowCount()).uniqueResult(),new Long(2));
  s.delete(root);
  s.delete(child);
  tx.commit();
  s.close();
}
