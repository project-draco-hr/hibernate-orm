{
  final LinkedHashSet<String> spacesList=new LinkedHashSet<String>();
  spacesList.addAll(tableSpaces);
  final SessionFactoryImplementor factory=session.getFactory();
  for (  String entityName : factory.getAllClassMetadata().keySet()) {
    final EntityPersister persister=factory.getEntityPersister(entityName);
    final String[] entitySpaces=(String[])persister.getQuerySpaces();
    if (affectedEntity(tableSpaces,entitySpaces)) {
      spacesList.addAll(Arrays.asList(entitySpaces));
      if (persister.hasCache()) {
        entityCleanups.add(new EntityCleanup(persister.getCacheAccessStrategy()));
      }
      if (persister.hasNaturalIdentifier() && persister.hasNaturalIdCache()) {
        naturalIdCleanups.add(new NaturalIdCleanup(persister.getNaturalIdCacheAccessStrategy()));
      }
      final Set<String> roles=session.getFactory().getCollectionRolesByEntityParticipant(persister.getEntityName());
      if (roles != null) {
        for (        String role : roles) {
          final CollectionPersister collectionPersister=factory.getCollectionPersister(role);
          if (collectionPersister.hasCache()) {
            collectionCleanups.add(new CollectionCleanup(collectionPersister.getCacheAccessStrategy()));
          }
        }
      }
    }
  }
  this.affectedTableSpaces=spacesList.toArray(new String[spacesList.size()]);
}
