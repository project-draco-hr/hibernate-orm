{
  errorIfClosed();
  NamedQueryDefinition nqd=factory.getNamedQuery(queryName);
  final Query query;
  if (nqd != null) {
    String queryString=nqd.getQueryString();
    query=new QueryImpl(queryString,nqd.getFlushMode(),this,getHQLQueryPlan(queryString,false).getParameterMetadata());
    query.setComment("named HQL query " + queryName);
    if (nqd.getLockTimeout() != null) {
      ((QueryImpl)query).getLockOptions().setTimeOut(nqd.getLockTimeout());
    }
  }
 else {
    NamedSQLQueryDefinition nsqlqd=factory.getNamedSQLQuery(queryName);
    if (nsqlqd == null) {
      throw new MappingException("Named query not known: " + queryName);
    }
    ParameterMetadata parameterMetadata=factory.getQueryPlanCache().getSQLParameterMetadata(nsqlqd.getQueryString());
    query=new SQLQueryImpl(nsqlqd,this,parameterMetadata);
    query.setComment("named native SQL query " + queryName);
    nqd=nsqlqd;
  }
  initQuery(query,nqd);
  return query;
}
