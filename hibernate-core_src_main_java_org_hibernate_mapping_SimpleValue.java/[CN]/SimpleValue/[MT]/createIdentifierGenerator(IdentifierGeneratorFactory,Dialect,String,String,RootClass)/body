{
  if (identifierGenerator != null) {
    return identifierGenerator;
  }
  Properties params=new Properties();
  if (defaultSchema != null) {
    params.setProperty(PersistentIdentifierGenerator.SCHEMA,defaultSchema);
  }
  if (defaultCatalog != null) {
    params.setProperty(PersistentIdentifierGenerator.CATALOG,defaultCatalog);
  }
  if (rootClass != null) {
    params.setProperty(IdentifierGenerator.ENTITY_NAME,rootClass.getEntityName());
    params.setProperty(IdentifierGenerator.JPA_ENTITY_NAME,rootClass.getJpaEntityName());
  }
  String tableName=getTable().getQuotedName(dialect);
  params.setProperty(PersistentIdentifierGenerator.TABLE,tableName);
  String columnName=((Column)getColumnIterator().next()).getQuotedName(dialect);
  params.setProperty(PersistentIdentifierGenerator.PK,columnName);
  if (rootClass != null) {
    StringBuilder tables=new StringBuilder();
    Iterator iter=rootClass.getIdentityTables().iterator();
    while (iter.hasNext()) {
      Table table=(Table)iter.next();
      tables.append(table.getQuotedName(dialect));
      if (iter.hasNext()) {
        tables.append(", ");
      }
    }
    params.setProperty(PersistentIdentifierGenerator.TABLES,tables.toString());
  }
 else {
    params.setProperty(PersistentIdentifierGenerator.TABLES,tableName);
  }
  if (identifierGeneratorProperties != null) {
    params.putAll(identifierGeneratorProperties);
  }
  final ConfigurationService cs=metadata.getMetadataBuildingOptions().getServiceRegistry().getService(ConfigurationService.class);
  params.put(AvailableSettings.PREFER_POOLED_VALUES_LO,cs.getSetting(AvailableSettings.PREFER_POOLED_VALUES_LO,StandardConverters.BOOLEAN,false));
  if (cs.getSettings().get(AvailableSettings.PREFERRED_POOLED_OPTIMIZER) != null) {
    params.put(AvailableSettings.PREFERRED_POOLED_OPTIMIZER,cs.getSettings().get(AvailableSettings.PREFERRED_POOLED_OPTIMIZER));
  }
  identifierGeneratorFactory.setDialect(dialect);
  identifierGenerator=identifierGeneratorFactory.createIdentifierGenerator(identifierGeneratorStrategy,getType(),params);
  return identifierGenerator;
}
