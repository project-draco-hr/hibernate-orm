{
  final String sql=session.getFactory().getDialect().getSelectGUIDString();
  try {
    PreparedStatement st=session.getTransactionCoordinator().getJdbcCoordinator().getStatementPreparer().prepareStatement(sql);
    try {
      ResultSet rs=session.getTransactionCoordinator().getJdbcCoordinator().getResultSetReturn().extract(st);
      final String result;
      try {
        if (!rs.next()) {
          throw new HibernateException("The database returned no GUID identity value");
        }
        result=rs.getString(1);
      }
  finally {
        session.getTransactionCoordinator().getJdbcCoordinator().release(rs,st);
      }
      LOG.guidGenerated(result);
      return result;
    }
  finally {
      session.getTransactionCoordinator().getJdbcCoordinator().release(st);
    }
  }
 catch (  SQLException sqle) {
    throw session.getFactory().getSQLExceptionHelper().convert(sqle,"could not retrieve GUID",sql);
  }
}
