{
  Session s=openSession();
  Category c=new Category();
  c.setName(Category.ROOT_CATEGORY);
  Category c1=new Category();
  Category c2=new Category();
  Category c3=new Category();
  c.getSubcategories().add(c1);
  c.getSubcategories().add(c2);
  c2.getSubcategories().add(null);
  c2.getSubcategories().add(c3);
  s.save(c);
  s.flush();
  s.connection().commit();
  s.close();
  s=openSession();
  Transaction tx=s.beginTransaction();
  s.lock(c,LockMode.UPGRADE);
  Category loaded=(Category)s.load(Category.class,new Long(c3.getId()));
  assertTrue(s.contains(c3));
  assertTrue(loaded == c3);
  assertTrue(s.getCurrentLockMode(c3) == LockMode.NONE);
  assertTrue(s.getCurrentLockMode(c) == LockMode.UPGRADE);
  s.flush();
  tx.commit();
  s.close();
  s=openSession();
  loaded=(Category)s.load(Category.class,new Long(c.getId()));
  assertFalse(Hibernate.isInitialized(loaded.getSubcategories()));
  s.connection().commit();
  s.close();
  s=openSession();
  s.lock(loaded,LockMode.NONE);
  assertTrue(loaded.getSubcategories().size() == 2);
  s.connection().commit();
  s.close();
  s=openSession();
  c=(Category)s.load(Category.class,new Long(c.getId()));
  System.out.println(c.getSubcategories());
  assertTrue(c.getSubcategories().get(0) != null && c.getSubcategories().get(1) != null);
  List list=((Category)c.getSubcategories().get(1)).getSubcategories();
  assertTrue(list.get(1) != null && list.get(0) == null);
  assertTrue(s.iterate("from Category c where c.name = org.hibernate.test.legacy.Category.ROOT_CATEGORY").hasNext());
  s.delete(c);
  s.flush();
  s.connection().commit();
  s.close();
}
