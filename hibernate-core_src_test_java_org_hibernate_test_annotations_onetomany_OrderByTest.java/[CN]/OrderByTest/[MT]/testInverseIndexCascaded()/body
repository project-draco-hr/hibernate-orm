{
  final Session s=openSession();
  s.getTransaction().begin();
  Forum forum=new Forum();
  forum.setName("forum1");
  forum=(Forum)s.merge(forum);
  s.flush();
  s.clear();
  sessionFactory().getCache().evictEntityRegions();
  forum=(Forum)s.get(Forum.class,forum.getId());
  final Post post=new Post();
  post.setName("post1");
  post.setForum(forum);
  forum.getPosts().add(post);
  final User user=new User();
  user.setName("john");
  user.setForum(forum);
  forum.getUsers().add(user);
  forum=(Forum)s.merge(forum);
  s.flush();
  s.clear();
  sessionFactory().getCache().evictEntityRegions();
  forum=(Forum)s.get(Forum.class,forum.getId());
  final Post post2=new Post();
  post2.setName("post2");
  post2.setForum(forum);
  forum.getPosts().add(post2);
  forum=(Forum)s.merge(forum);
  s.flush();
  s.clear();
  sessionFactory().getCache().evictEntityRegions();
  forum=(Forum)s.get(Forum.class,forum.getId());
  assertEquals(2,forum.getPosts().size());
  assertEquals("post1",forum.getPosts().get(0).getName());
  assertEquals("post2",forum.getPosts().get(1).getName());
  Hibernate.initialize(forum.getPosts());
  assertEquals(2,forum.getPosts().size());
  assertEquals(1,forum.getUsers().size());
  assertEquals("john",forum.getUsers().get(0).getName());
  Hibernate.initialize(forum.getUsers());
  assertEquals(1,forum.getUsers().size());
}
