{
  final boolean debugEnabled=LOG.isDebugEnabled();
  if (debugEnabled)   LOG.debugf("Checking cached query results in region: %s",cacheRegion.getName());
  List cacheable=(List)cacheRegion.get(key);
  if (tracing)   logCachedResultDetails(key,spaces,returnTypes,cacheable);
  if (cacheable == null) {
    if (debugEnabled)     LOG.debug("Query results were not found in cache");
    return null;
  }
  Long timestamp=(Long)cacheable.get(0);
  if (!isNaturalKeyLookup && !isUpToDate(spaces,timestamp)) {
    if (debugEnabled)     LOG.debug("Cached query results were not up-to-date");
    return null;
  }
  if (debugEnabled)   LOG.debug("Returning cached query results");
  final boolean singleResult=returnTypes.length == 1;
  for (int i=1; i < cacheable.size(); i++) {
    if (singleResult) {
      returnTypes[0].beforeAssemble((Serializable)cacheable.get(i),session);
    }
 else {
      TypeHelper.beforeAssemble((Serializable[])cacheable.get(i),returnTypes,session);
    }
  }
  List result=new ArrayList(cacheable.size() - 1);
  for (int i=1; i < cacheable.size(); i++) {
    try {
      if (singleResult) {
        result.add(returnTypes[0].assemble((Serializable)cacheable.get(i),session,null));
      }
 else {
        result.add(TypeHelper.assemble((Serializable[])cacheable.get(i),returnTypes,session,null));
      }
      if (tracing)       logCachedResultRowDetails(returnTypes,result.get(i - 1));
    }
 catch (    RuntimeException ex) {
      if (isNaturalKeyLookup && (UnresolvableObjectException.class.isInstance(ex) || EntityNotFoundException.class.isInstance(ex))) {
        if (debugEnabled)         LOG.debug("Unable to reassemble cached result set");
        cacheRegion.evict(key);
        return null;
      }
      throw ex;
    }
  }
  return result;
}
