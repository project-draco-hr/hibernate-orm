{
  final CountDownLatch pferLatch=new CountDownLatch(1);
  final CountDownLatch removeLatch=new CountDownLatch(1);
  final TransactionManager remoteTm=remoteCollectionRegion.getTransactionManager();
  withCacheManager(new CacheManagerCallable(createCacheManager()){
    @Override public void call(){
      PutFromLoadValidator validator=getPutFromLoadValidator(remoteCollectionRegion.getCache(),cm,removeLatch,pferLatch);
      final TransactionalAccessDelegate delegate=new TransactionalAccessDelegate(localCollectionRegion,validator);
      final TransactionManager localTm=localCollectionRegion.getTransactionManager();
      Callable<Void> pferCallable=new Callable<Void>(){
        public Void call() throws Exception {
          SessionImplementor session=mock(SessionImplementor.class);
          delegate.putFromLoad(session,"k1","v1",0,null);
          return null;
        }
      }
;
      Callable<Void> removeCallable=new Callable<Void>(){
        public Void call() throws Exception {
          removeLatch.await();
          Caches.withinTx(localTm,new Callable<Void>(){
            @Override public Void call() throws Exception {
              SessionImplementor session=mock(SessionImplementor.class);
              delegate.remove(session,"k1");
              return null;
            }
          }
);
          pferLatch.countDown();
          return null;
        }
      }
;
      ExecutorService executorService=Executors.newCachedThreadPool();
      Future<Void> pferFuture=executorService.submit(pferCallable);
      Future<Void> removeFuture=executorService.submit(removeCallable);
      try {
        pferFuture.get();
        removeFuture.get();
      }
 catch (      Exception e) {
        throw new RuntimeException(e);
      }
      assertFalse(localCollectionRegion.getCache().containsKey("k1"));
    }
  }
);
}
