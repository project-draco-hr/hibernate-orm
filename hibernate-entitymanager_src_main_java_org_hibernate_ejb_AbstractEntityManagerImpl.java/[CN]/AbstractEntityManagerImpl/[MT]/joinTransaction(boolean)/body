{
  if (transactionType != PersistenceUnitTransactionType.JTA) {
    if (!ignoreNotJoining) {
      log.warn("Calling joinTransaction() on a non JTA EntityManager");
    }
    return;
  }
  final SessionImplementor session=(SessionImplementor)getSession();
  final TransactionCoordinator transactionCoordinator=session.getTransactionCoordinator();
  final TransactionImplementor transaction=transactionCoordinator.getTransaction();
  transaction.markForJoin();
  transactionCoordinator.pulse();
  log.debug("Looking for a JTA transaction to join");
  if (!transactionCoordinator.isTransactionJoinable()) {
    log.warn("Cannot join transaction: do not override {}",Environment.TRANSACTION_STRATEGY);
  }
  try {
    if (transaction.getJoinStatus() == JoinStatus.JOINED) {
      log.debug("Transaction already joined");
      return;
    }
    transaction.join();
    if (transaction.getJoinStatus() == JoinStatus.NOT_JOINED) {
      if (ignoreNotJoining) {
        log.debug("No JTA transaction found");
        return;
      }
 else {
        throw new TransactionRequiredException("No active JTA transaction on joinTransaction call");
      }
    }
 else     if (transaction.getJoinStatus() == JoinStatus.MARKED_FOR_JOINED) {
      throw new AssertionFailure("Transaction MARKED_FOR_JOINED after isOpen() call");
    }
    SynchronizationCallbackCoordinator callbackCoordinator=transactionCoordinator.getSynchronizationCallbackCoordinator();
    callbackCoordinator.setManagedFlushChecker(new ManagedFlushCheckerImpl());
    callbackCoordinator.setExceptionMapper(new CallbackExceptionMapperImpl());
    callbackCoordinator.setAfterCompletionAction(new AfterCompletionActionImpl(session,transactionType));
  }
 catch (  HibernateException he) {
    throw convert(he);
  }
}
