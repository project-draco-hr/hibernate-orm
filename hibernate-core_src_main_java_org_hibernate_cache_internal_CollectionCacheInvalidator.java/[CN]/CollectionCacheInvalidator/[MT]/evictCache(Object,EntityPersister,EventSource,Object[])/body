{
  try {
    SessionFactoryImplementor factory=persister.getFactory();
    Set<String> collectionRoles=factory.getCollectionRolesByEntityParticipant(persister.getEntityName());
    if (collectionRoles == null || collectionRoles.isEmpty()) {
      return;
    }
    for (    String role : collectionRoles) {
      final CollectionPersister collectionPersister=factory.getCollectionPersister(role);
      if (!collectionPersister.hasCache()) {
        continue;
      }
      String mappedBy=collectionPersister.getMappedByProperty();
      if (!collectionPersister.isManyToMany() && mappedBy != null && !mappedBy.isEmpty()) {
        int i=persister.getEntityMetamodel().getPropertyIndex(mappedBy);
        Serializable oldId=null;
        if (oldState != null) {
          oldId=session.getIdentifier(oldState[i]);
        }
        Object ref=persister.getPropertyValue(entity,i);
        Serializable id=null;
        if (ref != null) {
          id=session.getContextEntityIdentifier(ref);
          if (id == null) {
            id=session.getSessionFactory().getClassMetadata(ref.getClass()).getIdentifier(ref,session);
          }
        }
        if (id != null && !id.equals(oldId)) {
          evict(id,collectionPersister,session);
          if (oldId != null) {
            evict(oldId,collectionPersister,session);
          }
        }
      }
 else {
        LOG.debug("Evict CollectionRegion " + role);
        final SoftLock softLock=collectionPersister.getCacheAccessStrategy().lockRegion();
        session.getActionQueue().registerProcess(new AfterTransactionCompletionProcess(){
          @Override public void doAfterTransactionCompletion(          boolean success,          SessionImplementor session){
            collectionPersister.getCacheAccessStrategy().unlockRegion(softLock);
          }
        }
);
      }
    }
  }
 catch (  Exception e) {
    if (PROPAGATE_EXCEPTION) {
      throw new IllegalStateException(e);
    }
    LOG.error("",e);
  }
}
