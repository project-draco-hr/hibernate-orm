{
  sessionFactory().getStatistics().clear();
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().begin();
  Session s=openSession();
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().commit();
  assertFalse(s.isOpen());
  assertEquals(sessionFactory().getStatistics().getFlushCount(),0);
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().begin();
  s=openSession();
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().rollback();
  assertFalse(s.isOpen());
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().begin();
  s=openSession();
  Map item=new HashMap();
  item.put("name","The Item");
  item.put("description","The only item we have");
  s.persist("Item",item);
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().commit();
  assertFalse(s.isOpen());
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().begin();
  s=openSession();
  item=(Map)s.createQuery("from Item").uniqueResult();
  assertNotNull(item);
  s.delete(item);
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().commit();
  assertFalse(s.isOpen());
  assertEquals(sessionFactory().getStatistics().getTransactionCount(),4);
  assertEquals(sessionFactory().getStatistics().getSuccessfulTransactionCount(),3);
  assertEquals(sessionFactory().getStatistics().getEntityDeleteCount(),1);
  assertEquals(sessionFactory().getStatistics().getEntityInsertCount(),1);
  assertEquals(sessionFactory().getStatistics().getSessionOpenCount(),4);
  assertEquals(sessionFactory().getStatistics().getSessionCloseCount(),4);
  assertEquals(sessionFactory().getStatistics().getQueryExecutionCount(),1);
  assertEquals(sessionFactory().getStatistics().getFlushCount(),2);
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().begin();
  s=openSession();
  s.createQuery("delete from Item").executeUpdate();
  sessionFactory().getServiceRegistry().getService(JtaPlatform.class).retrieveTransactionManager().commit();
}
