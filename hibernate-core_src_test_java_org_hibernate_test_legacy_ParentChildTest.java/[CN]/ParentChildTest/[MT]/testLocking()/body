{
  Session s=openSession();
  Transaction tx=s.beginTransaction();
  Simple s1=new Simple(Long.valueOf(1));
  s1.setCount(1);
  Simple s2=new Simple(Long.valueOf(2));
  s2.setCount(2);
  Simple s3=new Simple(Long.valueOf(3));
  s3.setCount(3);
  Simple s4=new Simple(Long.valueOf(4));
  s4.setCount(4);
  s.save(s1);
  s.save(s2);
  s.save(s3);
  s.save(s4);
  assertTrue(s.getCurrentLockMode(s1) == LockMode.WRITE);
  tx.commit();
  s.close();
  s=openSession();
  tx=s.beginTransaction();
  s1=(Simple)s.load(Simple.class,new Long(1),LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s1) == LockMode.READ || s.getCurrentLockMode(s1) == LockMode.NONE);
  s2=(Simple)s.load(Simple.class,new Long(2),LockMode.READ);
  assertTrue(s.getCurrentLockMode(s2) == LockMode.READ);
  s3=(Simple)s.load(Simple.class,new Long(3),LockMode.UPGRADE);
  assertTrue(s.getCurrentLockMode(s3) == LockMode.UPGRADE);
  s4=(Simple)s.get(Simple.class,new Long(4),LockMode.UPGRADE_NOWAIT);
  assertTrue(s.getCurrentLockMode(s4) == LockMode.UPGRADE_NOWAIT);
  s1=(Simple)s.load(Simple.class,new Long(1),LockMode.UPGRADE);
  assertTrue(s.getCurrentLockMode(s1) == LockMode.UPGRADE);
  s2=(Simple)s.load(Simple.class,new Long(2),LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s2) == LockMode.READ);
  s3=(Simple)s.load(Simple.class,new Long(3),LockMode.READ);
  assertTrue(s.getCurrentLockMode(s3) == LockMode.UPGRADE);
  s4=(Simple)s.load(Simple.class,new Long(4),LockMode.UPGRADE);
  assertTrue(s.getCurrentLockMode(s4) == LockMode.UPGRADE_NOWAIT);
  s.lock(s2,LockMode.UPGRADE);
  assertTrue(s.getCurrentLockMode(s2) == LockMode.UPGRADE);
  s.lock(s3,LockMode.UPGRADE);
  assertTrue(s.getCurrentLockMode(s3) == LockMode.UPGRADE);
  s.lock(s1,LockMode.UPGRADE_NOWAIT);
  s.lock(s4,LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s4) == LockMode.UPGRADE_NOWAIT);
  tx.commit();
  tx=s.beginTransaction();
  assertTrue(s.getCurrentLockMode(s3) == LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s1) == LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s2) == LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s4) == LockMode.NONE);
  s.lock(s1,LockMode.READ);
  assertTrue(s.getCurrentLockMode(s1) == LockMode.READ);
  s.lock(s2,LockMode.UPGRADE);
  assertTrue(s.getCurrentLockMode(s2) == LockMode.UPGRADE);
  s.lock(s3,LockMode.UPGRADE_NOWAIT);
  assertTrue(s.getCurrentLockMode(s3) == LockMode.UPGRADE_NOWAIT);
  s.lock(s4,LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s4) == LockMode.NONE);
  s4.setName("s4");
  s.flush();
  assertTrue(s.getCurrentLockMode(s4) == LockMode.WRITE);
  tx.commit();
  tx=s.beginTransaction();
  assertTrue(s.getCurrentLockMode(s3) == LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s1) == LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s2) == LockMode.NONE);
  assertTrue(s.getCurrentLockMode(s4) == LockMode.NONE);
  s.delete(s1);
  s.delete(s2);
  s.delete(s3);
  s.delete(s4);
  tx.commit();
  s.close();
}
